<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Japan Azure IaaS Core Support Blog</title>
  
  <subtitle>日本マイクロソフトの Azure IaaS テクニカル サポート チームより、情報をお届けします！</subtitle>
  <link href="/blog/atom.xml" rel="self"/>
  
  <link href="https://jpaztech.github.io/blog/"/>
  <updated>2021-04-27T07:25:57.333Z</updated>
  <id>https://jpaztech.github.io/blog/</id>
  
  <author>
    <name>Japan Azure IaaS Core Support Team</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Azure Front Door を用いた App Service などへのセキュアな接続の構成</title>
    <link href="https://jpaztech.github.io/blog/network/AzureFrontDoor-LockDown/"/>
    <id>https://jpaztech.github.io/blog/network/AzureFrontDoor-LockDown/</id>
    <published>2021-04-01T15:00:00.000Z</published>
    <updated>2021-04-27T07:25:57.333Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チーム 箕輪 です。</p><p>Azure Front Door は、世界中に展開された Microsoft のリソースを用いて、レイヤー 7 (HTTP/HTTPS 層) で動作する負荷分散サービスとなります。<br>このブログでは、Azure Front Door についてよくお問い合わせをいただく、App Service などへのセキュアな接続の構成についてご紹介します。</p><a id="more"></a> <br><h2 id="Azure-Front-Door-の-概要"><a href="#Azure-Front-Door-の-概要" class="headerlink" title="Azure Front Door の 概要"></a>Azure Front Door の 概要</h2><p>Azure でご利用いただける負荷分散サービスやご選択いただく考え方としては、公開情報の <a href="https://docs.microsoft.com/ja-jp/azure/architecture/guide/technology-choices/load-balancing-overview" target="_blank" rel="noopener">Azure 負荷分散を理解する</a> に記載があります。<br>この中で、Azure Front Door は、グローバル リージョンでご利用いただけるレイヤー 7 で動作する負荷分散サービスであり、公開情報では <a href="https://docs.microsoft.com/ja-jp/azure/frontdoor/front-door-overview" target="_blank" rel="noopener">Azure Front Door とは</a> に記載があります通り、下記の機能がご利用いただけます。</p><ul><li>スプリット TCP ベースの エニーキャスト プロトコル を使用したアプリケーションのパフォーマンスの高速化</li><li>インテリジェントな 正常性プローブ によるバックエンド リソースの監視</li><li>要求の URL パス ベース のルーティング</li><li>効率的なアプリケーション インフラストラクチャを実現する、複数の Web サイトのホスティング</li><li>Cookie ベースの セッション アフィニティ</li><li>SSL オフロード と証明書管理</li><li>独自の カスタム ドメイン の定義</li><li>Web Application Firewall (WAF) が統合されたアプリケーション セキュリティ</li><li>URL リダイレクト による、HTTPS への HTTP トラフィックのリダイレクト</li><li>URL 書き換え によるカスタム転送パス</li><li>エンド ツー エンドの IPv6 接続と HTTP/2 プロトコル のネイティブ サポート</li></ul><br><h2 id="Azure-Front-Door-におけるセキュアな構成"><a href="#Azure-Front-Door-におけるセキュアな構成" class="headerlink" title="Azure Front Door におけるセキュアな構成"></a>Azure Front Door におけるセキュアな構成</h2><p>Azure Front Door は上記の通り多くの機能を要しています。その中で、Azure Front Door の WAF (Web アプリケーション ファイアウォール) を利用いただければ、バックエンドに配置した Azure 仮想マシンや App Service 上の Web アプリケーションを、一般的な悪用や脆弱性を含んだリクエストから保護する構成がご利用いただけます。<br><br><br>Azure Front Door をご利用いただいているお客様からいただくご質問については、<a href="https://docs.microsoft.com/ja-jp/azure/frontdoor/front-door-faq" target="_blank" rel="noopener">Azure Front Door についてよく寄せられる質問</a> でご案内しておりますが、このブログではその中でもよくお問い合わせいただく、<a href="https://docs.microsoft.com/ja-jp/azure/frontdoor/front-door-faq#how-do-i-lock-down-the-access-to-my-backend-to-only-azure-front-door" target="_blank" rel="noopener">バックエンドへのアクセスを Azure Front Door のみにされたい構成</a> について、ご紹介いたします。</p><br><h2 id="Azure-Front-Door-で用いられる-IP-アドレス-FAQ"><a href="#Azure-Front-Door-で用いられる-IP-アドレス-FAQ" class="headerlink" title="Azure Front Door で用いられる IP アドレス FAQ"></a>Azure Front Door で用いられる IP アドレス FAQ</h2><p>Azure Front Door では、クライアントがAzure Front Door に接続するためのパブリック IP アドレスと、Azure Front Door からバックエンドのリソースに接続する際に用いられるパブリック IP アドレスは異なります。<br>Azure Fornt Door で用いられるパブリック IP アドレスは、<a href="https://www.microsoft.com/en-us/download/details.aspx?id=56519" target="_blank" rel="noopener">Azure IP 範囲とサービス タグ</a> で公開されています。<br>Azure Front Door が、バックエンドに構成されたリソースに接続する際のパブリック IP アドレスは、「AzureFrontDoor.Backend」セクションで公開されており、このパブリック IP アドレスの範囲の中から任意の IP アドレスが用いられます。<br><br><br>そのため、例えばバックエンドに Azure 仮想マシンを配置されている構成であれば、NSG のサービス タグで「AzureFrontDoor.Backend」からの HTTP/HTTPS 通信のみ許可することで、Azure Front Door のパブリック IP アドレス以外からの HTTP/HTTPS 接続を許可しない構成が可能です。</p><br><h2 id="Azure-Front-Door-の固有のリソース-ID"><a href="#Azure-Front-Door-の固有のリソース-ID" class="headerlink" title="Azure Front Door の固有のリソース ID"></a>Azure Front Door の固有のリソース ID</h2><p>Azure Front Door では、お客様のリソースに固有の ID 割り当てられており、バックエンドへの通信時の HTTP ヘッダーに “X-Azure-FDID” として追加されます。<br>IP アドレスでの制御に加えて、この HTTP ヘッダー “X-Azure FDID” を、バックエンドに配置したアプリケーション上でフィルター処理することで、構成いただいた Azure Front Door からの接続のみに限定することが可能です。<br><br><br>Azure Front Door のリソース ID は、Azure ポータルの Azure Front Door リソースの 概要 にある “フロント ドア ID” から確認できます。<br>コマンドであれば、下記のコマンドから “frontdoorId” を確認できます。<br><br></p><p><a href="https://docs.microsoft.com/ja-jp/powershell/module/az.frontdoor/get-azfrontdoor?view=azps-5.7.0" target="_blank" rel="noopener">Azure PowerShell (Get-AzFrontDoor)</a><br><br><br><a href="https://docs.microsoft.com/ja-jp/cli/azure/ext/front-door/network/front-door?view=azure-cli-latest#ext_front_door_az_network_front_door_show" target="_blank" rel="noopener">Azure CLI (az network front-door show)</a></p><br><h2 id="App-Service-における制限設定"><a href="#App-Service-における制限設定" class="headerlink" title="App Service における制限設定"></a>App Service における制限設定</h2><p>Azure Front Door のバックエンドに App Service を配置している構成においては、上記で案内したパラメータを用いて、App Service の機能を用いてアクセス制限を構成することが可能です。<br>具体的な設定方法については、<a href="https://docs.microsoft.com/ja-jp/azure/app-service/app-service-ip-restrictions#restrict-access-to-a-specific-azure-front-door-instance" target="_blank" rel="noopener">Azure App Service のアクセス制限を設定する</a> で紹介しています。<br><br><br>設定値について抜粋すると下記の通りとなります。<br><br></p><ul><li>サービス タグにおいて、「AzureFrontDoor.Backend」を指定する</li><li>X-Azure-FDIDにおいて、Azure Front Door の固有のリソース ID を指定する<br></li></ul><p><img src="/blog/network/AzureFrontDoor-LockDown/AzureFrontDoor-AppService-LockDown.png" alt="参考 : App Service での設定例"> </p><br><h2 id="アプリケーション上のサンプル-IIS"><a href="#アプリケーション上のサンプル-IIS" class="headerlink" title="アプリケーション上のサンプル (IIS)"></a>アプリケーション上のサンプル (IIS)</h2><p>バックエンドの Web サーバー側での設定例として、web.config ファイルによる IIS (Internet Information Services) の構成設定例を以下にご案内いたします。お客様が構成された Web アプリケーションに適した形でご設定ください。<br><br><br>なお、Web サーバーやアプリケーション上での個別のフィルタリング方法については、お客様の構成範囲となりますため、Azure サポート担当では具体的なご支援ができない点はご理解いただきますようお願い申し上げます。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">system.webServer</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rewrite</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">rules</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">rule</span> <span class="attr">name</span>=<span class="string">"Filter_X-Azure-FDID"</span> <span class="attr">patternSyntax</span>=<span class="string">"Wildcard"</span> <span class="attr">stopProcessing</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">match</span> <span class="attr">url</span>=<span class="string">"*"</span> /&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">conditions</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">add</span> <span class="attr">input</span>=<span class="string">"&#123;HTTP_X_AZURE_FDID&#125;"</span> <span class="attr">pattern</span>=<span class="string">"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"</span> <span class="attr">negate</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">conditions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">action</span> <span class="attr">type</span>=<span class="string">"AbortRequest"</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">rules</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rewrite</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">system.webServer</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><br><p>本ブログが皆様のお役に立てれば幸いです。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;こんにちは、Azure テクニカル サポート チーム 箕輪 です。&lt;/p&gt;
&lt;p&gt;Azure Front Door は、世界中に展開された Microsoft のリソースを用いて、レイヤー 7 (HTTP/HTTPS 層) で動作する負荷分散サービスとなります。&lt;br&gt;このブログでは、Azure Front Door についてよくお問い合わせをいただく、App Service などへのセキュアな接続の構成についてご紹介します。&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
      <category term="AzureFrontDoor" scheme="https://jpaztech.github.io/blog/tags/AzureFrontDoor/"/>
    
      <category term="FAQ" scheme="https://jpaztech.github.io/blog/tags/FAQ/"/>
    
  </entry>
  
  <entry>
    <title>Azure Firewall の各ルールの動作について</title>
    <link href="https://jpaztech.github.io/blog/network/firewall-rules/"/>
    <id>https://jpaztech.github.io/blog/network/firewall-rules/</id>
    <published>2021-03-31T03:30:00.000Z</published>
    <updated>2021-04-27T07:25:57.345Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure サポートチーム檜山です。</p><p>今回は Azure Firewall の各ルールの動作についてよくあるお問い合わせを紹介させていただきます。</p><hr><p><span id="apprule-block"></span></p><h2 id="Azure-Firewall-のアプリケーションルールで許可されているように見える動作について"><a href="#Azure-Firewall-のアプリケーションルールで許可されているように見える動作について" class="headerlink" title="Azure Firewall のアプリケーションルールで許可されているように見える動作について"></a><a href="#apprule-block">Azure Firewall のアプリケーションルールで許可されているように見える動作について</a></h2><p>HTTP (80), HTTPS (443) の通信において、ネットワークルール、アプリケーションルールで明示的に拒否していない場合、ルールの処理順序に従って、Azure Firewall の既定の動作として、アプリケーションルールで拒否されることが想定される動作となります。</p><p>この動作について Windows の Test-Netconnection や Linux の curl, nc コマンド等 (以下に記載) で TCP の 3way handshake による接続確認を実施した場合はアプリケーションルールで許可していないにもかかわらず、3way handshake が確立され、許可されたように見える動作となります。この動作の詳細を以下に記載します。</p><ul><li>Powershell Test-NetConnection コマンド (Windows)</li></ul><blockquote><p>Test-NetConnection -port 443 <a href="http://www.micorosoft.com" target="_blank" rel="noopener">www.micorosoft.com</a></p><p>ComputerName     : <a href="http://www.micorosoft.com" target="_blank" rel="noopener">www.micorosoft.com</a><br>RemoteAddress    : 40.76.4.15<br>RemotePort       : 443<br>InterfaceAlias   : Ethernet 2<br>SourceAddress    : 10.0.1.5<br><span style="color: red">TcpTestSucceeded : True</span></p></blockquote><ul><li>nc コマンド (linux)</li></ul><blockquote><p>$ nc -vz <a href="http://www.microsoft.com" target="_blank" rel="noopener">www.microsoft.com</a> 443<br>Ncat: Version 7.50 ( <a href="https://nmap.org/ncat" target="_blank" rel="noopener">https://nmap.org/ncat</a> )<br><span style="color: red">Ncat: Connected to 23.33.181.181:443.</span><br>Ncat: 0 bytes sent, 0 bytes received in 0.02 seconds.</p></blockquote><h3 id="Azure-Firewall-のアプリケーションルールの動作の詳細について"><a href="#Azure-Firewall-のアプリケーションルールの動作の詳細について" class="headerlink" title="Azure Firewall のアプリケーションルールの動作の詳細について"></a>Azure Firewall のアプリケーションルールの動作の詳細について</h3><p>上述の通り、TCP 80, 443 宛の通信について、ネットワークルールで明示的な拒否、許可がない場合、アプリケーションルールで評価され、許可ルールがない場合は既定の動作としてアプリケーションルールにて拒否されます。<br>アプリケーションルールでは HTTP のホストヘッダ、HTTPS の SNI の Server Name をもとにアプリケーションルール内の FQDN とマッチするかを確認して評価が行われます。</p><p>アプリケーションルールは L7 で動作しますので、内部的には クライアントと Azure Firewall 間で 3way handshake を確立し、HTTP , HTTPS の情報に基づいて通信を制御しますので、3way handshake が確立されることは想定される動作となります。</p><p>NSG にて接続が拒否されている Web サーバーにアクセスした際も、宛先アドレスと 3way handshake は確立可能で、HTTP, HTTPS のレイヤーで拒否されていることから、Azure Firewall が送信元を変換してパケットを返送するような動作であることが確認できます。</p><p><strong>そのため、アプリケーションルールで実際に通信が拒否されるかどうかを確認する際は、ブラウザや curl コマンド等で Web サイトへアクセスし、エラーによりクライアントへ期待される応答 (Status 200 等) が返らないことをご確認ください。</strong></p><p>アプリケーションルールにて拒否されている場合はブラウザや curl コマンドだと以下のような動作となります。</p><ul><li>Chrome [HTTP]</li></ul><table><thead><tr><th align="center"><img src="/blog/network/firewall-rules/http-deny-browser.png" alt="HTTP拒否"></th></tr></thead></table><ul><li>Chrome [HTTPS]</li></ul><table><thead><tr><th align="center"><img src="/blog/network/firewall-rules/https-deny-browser.png" alt="HTTPS拒否"></th></tr></thead></table><ul><li>curl コマンド (HTTP)</li></ul><blockquote><p>$ curl -v <a href="http://www.microsoft.com" target="_blank" rel="noopener">http://www.microsoft.com</a></p><p>About to connect() to <a href="http://www.microsoft.com" target="_blank" rel="noopener">www.microsoft.com</a> port 80 (#0)<br>   Trying 23.33.181.181…<br>Connected to <a href="http://www.microsoft.com" target="_blank" rel="noopener">www.microsoft.com</a> (23.33.181.181) port 80 (#0)<br>GET / HTTP/1.1<br>User-Agent: curl/7.29.0<br>Host: <a href="http://www.microsoft.com" target="_blank" rel="noopener">www.microsoft.com</a><br>Accept: <em>/</em></p><p>HTTP/1.1 470 status code 470<br>Date: Mon, 29 Mar 2021 04:29:57 GMT<br>Content-Length: 144<br>Content-Type: text/plain; charset=utf-8<br>Connection #0 to host <a href="http://www.microsoft.com" target="_blank" rel="noopener">www.microsoft.com</a> left intact<br><span style="color: red">HTTP  request from 10.0.1.4:53460 to <a href="http://www.microsoft.com:80" target="_blank" rel="noopener">www.microsoft.com:80</a>. Url: <a href="http://www.microsoft.com" target="_blank" rel="noopener">www.microsoft.com</a>. Action: Deny. No rule matched. Proceeding with default action</span></p></blockquote><ul><li>curl コマンド (HTTPS)</li></ul><blockquote><p>$ curl -v <a href="https://www.microsoft.com" target="_blank" rel="noopener">https://www.microsoft.com</a></p><p>About to connect() to <a href="http://www.microsoft.com" target="_blank" rel="noopener">www.microsoft.com</a> port 443 (#0)<br>  Trying 23.33.181.181…<br>Connected to <a href="http://www.microsoft.com" target="_blank" rel="noopener">www.microsoft.com</a> (23.33.181.181) port 443 (#0)<br>Initializing NSS with certpath: sql:/etc/pki/nssdb<br>  CAfile: /etc/pki/tls/certs/ca-bundle.crt<br>CApath: none<br><span style="color: red">NSS error -5938 (PR_END_OF_FILE_ERROR)</span><br><span style="color: red">Encountered end of file</span><br><span style="color: red">Closing connection 0</span><br><span style="color: red">curl: (35) Encountered end of file</span></p></blockquote><p><span id="difference-net-app"></span></p><h2 id="ネットワークルールと、アプリケーションルールの動作の違いについて"><a href="#ネットワークルールと、アプリケーションルールの動作の違いについて" class="headerlink" title="ネットワークルールと、アプリケーションルールの動作の違いについて"></a><a href="#difference-net-app">ネットワークルールと、アプリケーションルールの動作の違いについて</a></h2><h3 id="ネットワークルールの動作について"><a href="#ネットワークルールの動作について" class="headerlink" title="ネットワークルールの動作について"></a>ネットワークルールの動作について</h3><p>ネットワークルールは L4 で動作します。TCP の通信で宛先アドレス、宛先ポートが拒否されている場合、Azure Firewall は SYN/ACK を返しませんので、3way handshake に失敗し、通信が拒否される動作となります。</p><h3 id="アプリケーションルールとネットワークルールの動作の違いについて"><a href="#アプリケーションルールとネットワークルールの動作の違いについて" class="headerlink" title="アプリケーションルールとネットワークルールの動作の違いについて"></a>アプリケーションルールとネットワークルールの動作の違いについて</h3><p>上述の通り、ネットワークルールは L4 で動作し、アプリケーションルールは L7 で動作します。<br>どちらのルールを使用すべきかについては以下がベストプラクティスとなりますので、ご確認いただけますと幸いです。</p><ol><li>HTTP, HTTPS の通信において FQDN ベースで通信を制御できるものはアプリケーションルールを利用する</li><li>HTTP, HTTPS の通信において FQDN ベースで通信を制御できないものはネットワークルールを利用する</li><li>HTTP, HTTPS, MSSQL 以外の通信はネットワークルールを利用する</li></ol><h3 id="アプリケーションルールとネットワークルールの-FQDN-のフィルタリングについて"><a href="#アプリケーションルールとネットワークルールの-FQDN-のフィルタリングについて" class="headerlink" title="アプリケーションルールとネットワークルールの FQDN のフィルタリングについて"></a>アプリケーションルールとネットワークルールの FQDN のフィルタリングについて</h3><p>現在はアプリケーションルール、ネットワークルールどちらでも FQDN のフィルタリングが可能です。<br>ベストプラクティスは上述の通りとなりますが、HTTP, HTTPS の通信でアプリケーションルールの利用を推奨する理由としては以下もございます。</p><ul><li>IP アドレスが同一になるような FQDN でも制御可能 (CDN や AppService 等の同一 IP アドレスを複数のユーザーが利用する基盤が宛先となっている場合でも制御が可能)</li><li>ワイルドカードによる FQDN の指定が可能</li><li>DNS Proxy の利用が不要 (クライアント側の DNS の設定変更も不要)</li><li>Web トラフィックに対する今後の機能追加が優先的に行われる可能性がある </li></ul><p>ネットワークルールでの FQDN のフィルタリングは以下もご一読ください。</p><p><a href="https://docs.microsoft.com/ja-jp/azure/firewall/fqdn-filtering-network-rules" target="_blank" rel="noopener">ネットワーク ルールでの FQDN フィルタリング</a></p><p><a href="https://docs.microsoft.com/ja-jp/azure/firewall/dns-settings" target="_blank" rel="noopener">Azure Firewall の DNS 設定</a></p><h2 id="Azure-Firewall-のルールの処理順序-フローチャート"><a href="#Azure-Firewall-のルールの処理順序-フローチャート" class="headerlink" title="Azure Firewall のルールの処理順序 (フローチャート)"></a>Azure Firewall のルールの処理順序 (フローチャート)</h2><p>Azure Firewall のルールの処理順序がわかりにくいというお問い合わせをいただくことがございます。以下のフローチャートにて詳細を記載しておりますのでご確認ください。</p><p><img src="/blog/network/firewall-rules/FWdefault-flow.png" alt="フローチャート"></p><p><span id="faq"></span></p><h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a><a href="#faq">FAQ</a></h2><h4 id="設定変更時に既存接続への影響はありますか。"><a href="#設定変更時に既存接続への影響はありますか。" class="headerlink" title="- 設定変更時に既存接続への影響はありますか。"></a>- 設定変更時に既存接続への影響はありますか。</h4><p>DNAT ルール, ネットワークルール, アプリケーションルールの設定変更において、既存の接続に影響が出るような設定変更でなければ既存の接続に影響がでない動作となることを確認しております。</p><h4 id="戻りのパケットは診断ログに記録されますか。"><a href="#戻りのパケットは診断ログに記録されますか。" class="headerlink" title="- 戻りのパケットは診断ログに記録されますか。"></a>- 戻りのパケットは診断ログに記録されますか。</h4><p>ネットワークルールでは TCP の SYN パケットに対して許可/拒否が記録されますが、戻りのパケット (SYN/ACK) は診断ログには記録されない動作となります。</p><h4 id="「Action-Deny-Reason-SNI-TLS-extension-was-missing」で拒否される理由を教えてください。"><a href="#「Action-Deny-Reason-SNI-TLS-extension-was-missing」で拒否される理由を教えてください。" class="headerlink" title="- 「Action: Deny. Reason: SNI TLS extension was missing」で拒否される理由を教えてください。"></a>- 「Action: Deny. Reason: SNI TLS extension was missing」で拒否される理由を教えてください。</h4><p>アプリケーションルールでは TLS の通信を評価する際に Client Hello に含まれる SNI の Server Name を参照し、評価を行っております。そのため、SNI が利用されない通信はアプリケーションルールで制御することができません。</p><p>例えば、<a href="https://1.2.3.4" target="_blank" rel="noopener">https://1.2.3.4</a> のような IP アドレスでアクセスするような方法ですと、SNI が含まれるずにアプリケーションルールで拒否されることが想定されます。対応策としてはネットワークルールにて制御する必要があります。</p><p><a href="https://docs.microsoft.com/ja-jp/azure/firewall/overview#known-issues" target="_blank" rel="noopener">既知の問題</a></p><h4 id="NAT-ルールで拒否のログが記録されません。"><a href="#NAT-ルールで拒否のログが記録されません。" class="headerlink" title="- NAT ルールで拒否のログが記録されません。"></a>- NAT ルールで拒否のログが記録されません。</h4><p>NAT ルールで指定されている宛先ポート以外の通信のログは出力されない動作となります。NAT ルールが構成されている宛先ポートに対して通信を行い、拒否のログが出力されるかをご確認ください。</p><h4 id="NAT-ルールの処理順序をおしえてください。"><a href="#NAT-ルールの処理順序をおしえてください。" class="headerlink" title="- NAT ルールの処理順序をおしえてください。"></a>- NAT ルールの処理順序をおしえてください。</h4><ul><li>NAT ルールはネットワークルールより優先的に評価されます。</li><li>NAT ルールが適用されたトラフィックは暗黙的なネットワークルールにより許可されますが、この暗黙的なルールの優先度は明示的なネットワークルールの優先度よりも低くなります。</li></ul><h2 id="参考情報"><a href="#参考情報" class="headerlink" title="参考情報"></a>参考情報</h2><p>Azure Firewall の概要や機能については以下にも記載がありますのでご一読ください。</p><p><a href="https://docs.microsoft.com/ja-jp/azure/firewall/overview" target="_blank" rel="noopener">Azure Firewall とは</a></p><p><a href="https://docs.microsoft.com/ja-jp/azure/firewall/features" target="_blank" rel="noopener">Azure Firewall の機能</a></p><p><a href="https://docs.microsoft.com/ja-jp/azure/firewall/firewall-faq" target="_blank" rel="noopener">Azure Firewall FAQ</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは、Azure サポートチーム檜山です。&lt;/p&gt;
&lt;p&gt;今回は Azure Firewall の各ルールの動作についてよくあるお問い合わせを紹介させていただきます。&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;&lt;span id=&quot;apprule-block&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;
      
    
    </summary>
    
    
    
      <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
      <category term="Azure Firewall" scheme="https://jpaztech.github.io/blog/tags/Azure-Firewall/"/>
    
  </entry>
  
  <entry>
    <title>VM 複製方法について part.3/3 OS ディスクのスナップショットから複製する手順</title>
    <link href="https://jpaztech.github.io/blog/vm/vm-replica-3/"/>
    <id>https://jpaztech.github.io/blog/vm/vm-replica-3/</id>
    <published>2021-03-29T05:00:03.000Z</published>
    <updated>2021-04-27T07:25:57.437Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの富田です。<br>今回は OS ディスクのスナップショットから VM を複製する手順について、Azure ポータル上での手順をスクリーンショット付きで詳細に説明したいと思います。  </p><p>本記事は 3 部作の 3 記事目です。</p><ol><li><a href="https://jpaztech.github.io/blog/vm/vm-replica-1">VM 複製方法について 2 つの方法の紹介</a></li><li><a href="https://jpaztech.github.io/blog/vm/vm-replica-2">一般化したイメージから VM を複製する手順</a></li><li><a href="https://jpaztech.github.io/blog/vm/vm-replica-3">OS ディスクのスナップショットから VM を複製する手順</a></li></ol><p>そのため 1 記事目の <a href="https://jpaztech.github.io/blog/vm/vm-replica-1">VM 複製方法について 2 つの方法の紹介</a> をご覧いただいている前提で記載させていただきます。  </p><p>本記事では Azure ポータルで、OS ディスクのスナップショットから複製する手順について詳細に記載します。<br>また、マネージド ディスクの使用を前提とさせていただきますので、アンマネージド ディスクをご利用いただいている場合は、下記手順より VM をマネージドディスクに変換をお願いいたします。</p><ul><li>Azure VM を Azure Managed Disks に移行する<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/migrate-to-managed-disks" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/migrate-to-managed-disks</a></li></ul><h2 id="注意事項"><a href="#注意事項" class="headerlink" title="注意事項"></a>注意事項</h2><p>Windows VM を複製しそれをご利用いただく場合、基本的には本手順はご利用いただけません。<br>詳細は <a href="https://jpaztech.github.io/blog/vm/vm-replica-1/#Windows-VMを複製しようとしている方への注意喚起">Windows-VM を複製しようとしている方への注意喚起</a> をご参照ください。  </p><p>また、スナップショットからの複製でご注意いただきたい点として、<strong><span style="color:red">スナップショットは VM 固有のファイルとデータは保持される</span></strong> 、<strong><span style="color:red">OS ディスクの完全読み取りコピーである</span></strong> ということがあります。<br>つまり、複製した VM は SID やホスト名が複製元と同一になります。 </p><p>そのため、完全複製による意図しない動作を防止するため、同一 VNET 上で元 VM と複製 VM を同時に起動しないようにしてください。<br>スナップショットからの複製する場合は <strong><span style="color:red">必ず別の VNET 上にデプロイするようにお願いいたします。</span></strong>    </p><p>なお、本記事では扱いませんが、Azure Backup をご利用いただいた場合も、複製 VM はバックアップ取得元の VM の完全複製となります。</p><h2 id="大まかな流れ"><a href="#大まかな流れ" class="headerlink" title="大まかな流れ"></a>大まかな流れ</h2><ol><li>複製元となる VM を用意する</li><li>VM を停止 (割り当て解除) し、OS ディスクの [スナップショット] を取得</li><li>作成した [スナップショット] より必要な数だけ [ディスク] を作成</li><li>作成した [ディスク] よりVM作成する</li></ol><h2 id="実際の手順"><a href="#実際の手順" class="headerlink" title="実際の手順"></a>実際の手順</h2><p>それでは、上記の大まかな流れに沿って実際の手順をやってみましょう。  </p><hr><h3 id="1-複製元となる-VM-を作成する"><a href="#1-複製元となる-VM-を作成する" class="headerlink" title="1. 複製元となる VM を作成する"></a>1. 複製元となる VM を作成する</h3><p>複製元 (スナップショット取得元) となる仮想マシンを作成します。<br>詳細な手順は割愛させていただきますので、下記資料をご参照いただき VM を作成します。  </p><p>参考: クイック スタート:Azure Portal で Windows 仮想マシンを作成する<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/quick-create-portal" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/quick-create-portal</a></p><p>参考: クイック スタート:Azure portal で Linux 仮想マシンを作成する<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/linux/quick-create-portal" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/virtual-machines/linux/quick-create-portal</a></p><hr><h3 id="2-VM-を停止-割り当て解除-し、OS-ディスクの-スナップショット-を取得"><a href="#2-VM-を停止-割り当て解除-し、OS-ディスクの-スナップショット-を取得" class="headerlink" title="2. VM を停止 (割り当て解除) し、OS ディスクの [スナップショット] を取得"></a>2. VM を停止 (割り当て解除) し、OS ディスクの [スナップショット] を取得</h3><p>Azure ポータルから、VM を停止 (割り当て解除) します。</p><p><img src="/blog/vm/vm-replica-3/snp-010.png" alt=""> </p><p>VM の [ディスク] ブレードより、OS ディスクを選択します。</p><p><img src="/blog/vm/vm-replica-3/snp-020.png" alt=""> </p><p>上部にある [スナップショットの作成] を選択します。</p><p><img src="/blog/vm/vm-replica-3/snp-030.png" alt=""> </p><p>スナップショット作成のオプションを選択します。<br>下記は一例とはなりますが、今回はスナップショットの種類は [フル] とし、記憶域の種類は [Standard HDD] としています。<br>設定が完了したら、[レビュー] を選択し、スナップショットを作成します。</p><p><img src="/blog/vm/vm-replica-3/snp-040.png" alt=""> </p><hr><h3 id="3-作成した-スナップショット-より必要な数だけ-ディスク-を作成"><a href="#3-作成した-スナップショット-より必要な数だけ-ディスク-を作成" class="headerlink" title="3.作成した [スナップショット] より必要な数だけ [ディスク] を作成"></a>3.作成した [スナップショット] より必要な数だけ [ディスク] を作成</h3><p>スナップショットからディスクを作成します。<br>なお、スナップショットからディスクは複数作成することができますが、ディスクから VM は 1 つしか作成できません。<br>そのため、Azure ポータルを用いて複数 VM を作成する場合はこの手順を繰り返し行うこととなります。</p><p>まずは、ポータル上部の検索ボックスで [スナップショット] を検索し、選択します。</p><p><img src="/blog/vm/vm-replica-3/snp-050.png" alt=""></p><p>先ほど取得したスナップショットを一覧より選択します。</p><p><img src="/blog/vm/vm-replica-3/snp-060.png" alt=""> </p><p>上部に表示される [ディスクの作成] を選択します。 </p><p><img src="/blog/vm/vm-replica-3/snp-070.png" alt=""></p><p>マネージドディスクを作成します。<br>基本的には、デフォルトの設定で問題無いかと思いますが、下記例ではサイズにて [Standard HDD] のディスクを作成するように設定しています。  </p><p>設定が完了したら [確認および作成] を選択し、マネージドディスクを作成します。</p><p><img src="/blog/vm/vm-replica-3/snp-080.png" alt=""> </p><h3 id="4-作成した-ディスク-より-VM-作成する"><a href="#4-作成した-ディスク-より-VM-作成する" class="headerlink" title="4.作成した [ディスク] より VM 作成する"></a>4.作成した [ディスク] より VM 作成する</h3><p>最後に作成したマネージド ディスクから VM を作成します。<br>まずはじめに、Azure ポータル上部の検索ボックスで [ディスク] を検索し、選択します。</p><p><img src="/blog/vm/vm-replica-3/snp-090.png" alt=""> </p><p>先ほど作成したディスクを一覧より選択します。</p><p><img src="/blog/vm/vm-replica-3/snp-100.png" alt=""> </p><p>上部に表示される [VM の作成] を選択します。</p><p><img src="/blog/vm/vm-replica-3/snp-110.png" alt=""> </p><p>すると、VM 作成画面が表示されますので、新規 VM を作成するのと同じ要領で VM を作成します。</p><p><img src="/blog/vm/vm-replica-3/snp-120.png" alt=""> </p><p>以上が、Azure ポータルでのイメージを用いたスナップショットから VM を複製する手順となります。<br>もちろん PowerShell を用いた展開なども可能です。本記事が、基本的な手順としてお役に立てれば幸いです。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは、Azure テクニカル サポート チームの富田です。&lt;br&gt;今回は OS ディスクのスナップショットから VM を複製する手順について、Azure ポータル上での手順をスクリーンショット付きで詳細に説明したいと思います。  &lt;/p&gt;
&lt;p&gt;本記事は 3 部作の 
      
    
    </summary>
    
    
    
      <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
      <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
      <category term="Linux" scheme="https://jpaztech.github.io/blog/tags/Linux/"/>
    
      <category term="HowTo" scheme="https://jpaztech.github.io/blog/tags/HowTo/"/>
    
  </entry>
  
  <entry>
    <title>VM 複製方法について part.2/3 一般化したイメージから VM を複製する手順</title>
    <link href="https://jpaztech.github.io/blog/vm/vm-replica-2/"/>
    <id>https://jpaztech.github.io/blog/vm/vm-replica-2/</id>
    <published>2021-03-29T05:00:02.000Z</published>
    <updated>2021-04-27T07:25:57.433Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの富田です。<br>今回は一般化したイメージから VM を複製する手順について、Azure ポータル上での手順をスクリーンショット付きで詳細に説明したいと思います。  </p><p>本記事は 3 部作の 2 記事目です。</p><ol><li><a href="https://jpaztech.github.io/blog/vm/vm-replica-1">VM 複製方法について 2 つの方法の紹介</a></li><li><a href="https://jpaztech.github.io/blog/vm/vm-replica-2">一般化したイメージから VM を複製する手順</a></li><li><a href="https://jpaztech.github.io/blog/vm/vm-replica-3">OS ディスクのスナップショットから VM を複製する手順</a></li></ol><p>そのため 1 記事目の <a href="https://jpaztech.github.io/blog/vm/vm-replica-1">VM 複製方法について 2 つの方法の紹介</a> をご覧いただいている前提で記載させていただきます。  </p><p>本記事では Azure ポータルで、一般化したイメージを使用し、VM を複製する詳細な方法をご紹介します。<br>また、マネージド ディスクの使用を前提とさせていただきますので、アンマネージド ディスクをご利用いただいている場合は、下記手順より VM をマネージドディスクに変換をお願いいたします。</p><ul><li>Azure VM を Azure Managed Disks に移行する<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/migrate-to-managed-disks" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/migrate-to-managed-disks</a></li></ul><p>一般化をするにあたり、下記の点についてはバックアップが無い場合取り返しがつきませんのでご注意ください。<br>念のため、バックアップをご取得いただいてからご実施いただくことをお勧めいたします。</p><ul><li>一般化を行うとマシン固有のファイルとデータは削除されます</li><li>一般化を行ったVMは起動できなくなります</li></ul><h2 id="大まかな流れ"><a href="#大まかな流れ" class="headerlink" title="大まかな流れ"></a>大まかな流れ</h2><ol><li>複製元となる VM を作成する</li><li>作成した VM で必要なソフトウェアのインストールや設定を行う</li><li>VM を一般化（マシン固有のファイルとデータを削除）する</li><li>一般化した VM より [イメージ] を作成する</li><li>作成した [イメージ] より新規 VM を必要な数だけ作成する</li></ol><h2 id="実際の手順"><a href="#実際の手順" class="headerlink" title="実際の手順"></a>実際の手順</h2><p>それでは、上記の大まかな流れに沿って実際の手順をやってみましょう。   </p><hr><h3 id="1-複製元となる-VM-を作成する"><a href="#1-複製元となる-VM-を作成する" class="headerlink" title="1. 複製元となる VM を作成する"></a>1. 複製元となる VM を作成する</h3><p>複製元となる VM を作成します。詳細な手順は下記公開情報を確認いただき、ご実施ください。</p><ul><li><p>参考: クイック スタート:Azure Portal で Windows 仮想マシンを作成する<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/quick-create-portal" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/quick-create-portal</a></p></li><li><p>参考: クイック スタート:Azure portal で Linux 仮想マシンを作成する<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/linux/quick-create-portal" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/virtual-machines/linux/quick-create-portal</a></p></li></ul><hr><h3 id="2-作成したVMで必要なソフトウェアのインストールや各種設定を行う"><a href="#2-作成したVMで必要なソフトウェアのインストールや各種設定を行う" class="headerlink" title="2. 作成したVMで必要なソフトウェアのインストールや各種設定を行う"></a>2. 作成したVMで必要なソフトウェアのインストールや各種設定を行う</h3><p>VM を作成した後に、必要なソフトウェアをインストールしたり、各種設定を行います。こちらは、個々の要件に沿って実施してください。</p><hr><h3 id="3-VM-を一般化-マシン固有のファイルとデータを削除-する"><a href="#3-VM-を一般化-マシン固有のファイルとデータを削除-する" class="headerlink" title="3. VM を一般化 (マシン固有のファイルとデータを削除) する"></a>3. VM を一般化 (マシン固有のファイルとデータを削除) する</h3><p>一般化はゲスト OS 内部の操作で行うものとなります。<br>一般化の手順は Windows / Linux 両方とも公開情報にまとまっておりますので、下記をご参照の上、一般化を行い VM をシャットダウンします。  </p><hr><h4 id="3-1-Windows-VM-で一般化を行う方法"><a href="#3-1-Windows-VM-で一般化を行う方法" class="headerlink" title="3-1. Windows VM で一般化を行う方法"></a>3-1. Windows VM で一般化を行う方法</h4><ul><li>参考: Sysprep を使用して Windows VM を一般化する<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/capture-image-resource#generalize-the-windows-vm-using-sysprep" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/capture-image-resource#generalize-the-windows-vm-using-sysprep</a></li></ul><hr><h4 id="注意事項-Windows-の-Sysprep-の設定を間違えないこと！"><a href="#注意事項-Windows-の-Sysprep-の設定を間違えないこと！" class="headerlink" title="注意事項: Windows の Sysprep の設定を間違えないこと！"></a>注意事項: Windows の Sysprep の設定を間違えないこと！</h4><p>Windows OS では sysprep.exe を使って一般化を行いますが、最後の設定を間違えて、一般化したにもかかわらずその後複製した VM が正常に起動しないということがあります。</p><p>Sysprep.exe の画面は既定値ではなく、必ず下記スクリーンショットの設定になっていることを確認します。<br>Generalize（一般化）のチェック ボックスにチェックが入っており、<br>シャットダウン オプションが Shutdown（シャットダウン）となっている必要がありますのでご注意ください。</p><p>英語の場合:<br><img src="/blog/vm/vm-replica-2/sysprep-en.png" alt=""> </p><p>日本語の場合:<br><img src="/blog/vm/vm-replica-2/sysprep-jp.png" alt=""> </p><hr><h4 id="3-2-Linux-VM-で一般化を行う方法"><a href="#3-2-Linux-VM-で一般化を行う方法" class="headerlink" title="3-2. Linux VM で一般化を行う方法"></a>3-2. Linux VM で一般化を行う方法</h4><p>参考: 手順 1:VM のプロビジョニングを解除する<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/linux/capture-image#step-1-deprovision-the-vm" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/virtual-machines/linux/capture-image#step-1-deprovision-the-vm</a></p><p>今回はポータルからイメージを作成しますので、[手順 1:VM のプロビジョニングを解除する] が完了したら VM を停止しましょう。</p><hr><h3 id="4-一般化したVMより-イメージ-を作成する"><a href="#4-一般化したVMより-イメージ-を作成する" class="headerlink" title="4. 一般化したVMより [イメージ] を作成する"></a>4. 一般化したVMより [イメージ] を作成する</h3><p>ここまでの操作により、ゲスト OS 上で一般化が完了して VM は停止状態になりますので、[イメージ] を Azure ポータル上で作成します。  </p><p>まずは Azure ポータルにて、対象の VM の概要ブレードを開きます。概要ブレード上部の [キャプチャ] を選択します。</p><p><img src="/blog/vm/vm-replica-2/img-010.png" alt=""> </p><p>[キャプチャ] を選択すると、イメージを作成する画面が表示されます。<br>下記例では、ミニマムな設定にしているため、共有イメージ ギャラリーでのイメージ共有はしない設定にしています。<br>また、ゾーンの回復性についても、設定はしていません。</p><p>なお、一般化を行った VM は起動できなくなるため、[この仮想マシンを自動的に削除] にチェックを入れて一般化を行った VM は削除します。</p><p><img src="/blog/vm/vm-replica-2/img-020.png" alt=""> </p><p>各種オプションは、要件に合わせて変更してお使いください。<br>各種設定が完了したら、[確認および作成] - [作成] をクリックします。</p><hr><h3 id="5-作成した-イメージ-より新規VMを必要な数だけ作成する"><a href="#5-作成した-イメージ-より新規VMを必要な数だけ作成する" class="headerlink" title="5.作成した [イメージ] より新規VMを必要な数だけ作成する"></a>5.作成した [イメージ] より新規VMを必要な数だけ作成する</h3><p>ここまでの操作により [イメージ] が作成されましたので、この [イメージ] を用いて VM を作成（複製）します。  </p><p>まずは、Azure ポータル上部の検索ボックスよりイメージを検索します。</p><p><img src="/blog/vm/vm-replica-2/img-025.png" alt=""> </p><p>先ほど作成したイメージが表示されますので、これを選択します。</p><p><img src="/blog/vm/vm-replica-2/img-030.png" alt=""> </p><p>次に、上部に [VM の作成] がありますので、これを選択します。</p><p><img src="/blog/vm/vm-replica-2/img-040.png" alt=""> </p><p>すると、VM 作成画面が表示されますので、新規 VM を作成するのと同じ要領で VM を作成します。</p><p><img src="/blog/vm/vm-replica-2/img-050.png" alt=""> </p><p>以上が、Azure ポータルでのイメージを用いた VM 複製方法となります。<br>今回は説明のため、Azure ポータルを用いたミニマムな設定での説明となりましたが、もちろん PowerShell を用いた展開やイメージ作成時にイメージ共有などの設定も可能です。<br>本記事が、基本的な手順としてお役に立てれば幸いです。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは、Azure テクニカル サポート チームの富田です。&lt;br&gt;今回は一般化したイメージから VM を複製する手順について、Azure ポータル上での手順をスクリーンショット付きで詳細に説明したいと思います。  &lt;/p&gt;
&lt;p&gt;本記事は 3 部作の 2 記事目です。
      
    
    </summary>
    
    
    
      <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
      <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
      <category term="Linux" scheme="https://jpaztech.github.io/blog/tags/Linux/"/>
    
      <category term="HowTo" scheme="https://jpaztech.github.io/blog/tags/HowTo/"/>
    
  </entry>
  
  <entry>
    <title>VM 複製方法について part.1/3 2 つの方法の紹介</title>
    <link href="https://jpaztech.github.io/blog/vm/vm-replica-1/"/>
    <id>https://jpaztech.github.io/blog/vm/vm-replica-1/</id>
    <published>2021-03-29T05:00:01.000Z</published>
    <updated>2021-04-27T07:25:57.433Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの富田です。<br>今回はご案内することの多い、VM 複製方法についてとなります。</p><p>本記事は 3 部作の 1 記事目です。</p><ol><li><a href="https://jpaztech.github.io/blog/vm/vm-replica-1">VM 複製方法について 2 つの方法の紹介</a></li><li><a href="https://jpaztech.github.io/blog/vm/vm-replica-2">一般化したイメージから VM を複製する手順</a></li><li><a href="https://jpaztech.github.io/blog/vm/vm-replica-3">OS ディスクのスナップショットから VM を複製する手順</a></li></ol><p>VM 複製方法については多数の方法がありますが、こちらの記事では、よく使われる</p><ul><li>一般化を行いイメージを作成して、そのイメージから VM を複製する方法</li><li>OS ディスクのスナップショットを作成し、そのスナップショットから VM を複製する方法</li></ul><p>に絞って説明させていただきます。  </p><p>本記事ではマネージド ディスクの使用を前提とさせていただきますので、アンマネージド ディスクをご利用いただいている場合は、下記手順より VM をマネージドディスクに変換をお願いいたします。</p><ul><li>Azure VM を Azure Managed Disks に移行する<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/migrate-to-managed-disks" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/migrate-to-managed-disks</a></li></ul><p>詳細な手順は、part2 / part3 に記載いたしますので、まずは注意喚起および、それぞれの簡単な概要について紹介します。</p><hr><h2 id="Windows-VMを複製しようとしている方への注意喚起"><a href="#Windows-VMを複製しようとしている方への注意喚起" class="headerlink" title="Windows VMを複製しようとしている方への注意喚起"></a>Windows VMを複製しようとしている方への注意喚起</h2><p>重要な事のため、先に記載させていただきます。<br><strong><span style="color:red">Windows VM を複製しそれをご利用いただく場合、基本的には「一般化したイメージから VM を複製」いただく必要がございます。</span></strong><br>Windows VM の場合「OS ディスクのスナップショットから VM を複製」はバックアップ用途等でご利用いただけるものとなります。  </p><ul><li>参考: Windows インストールのディスク複製のための Microsoft ポリシー<br><a href="https://docs.microsoft.com/ja-jp/troubleshoot/windows-server/backup-and-storage/windows-installations-disk-duplication" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/troubleshoot/windows-server/backup-and-storage/windows-installations-disk-duplication</a></li></ul><blockquote><p>＝＝＝＝＝抜粋＝＝＝＝＝<br>複製またはイメージ化された Windows インストールを展開する場合は、イメージをキャプチャする前にシステム準備 (Sysprep) ツールを使用する必要があります。<br>＝＝＝＝＝＝＝＝＝＝＝＝  </p></blockquote><ul><li>参考: Azure Portal を使用して VHD から VM を作成する<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/create-vm-specialized-portal" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/create-vm-specialized-portal</a></li></ul><blockquote><p>＝＝＝＝＝抜粋＝＝＝＝＝<br>複数の VM を作成する場合は、特殊化されたディスクを使用しないでください。<br>代わりに、より大規模なデプロイの場合は、イメージを作成してから、そのイメージを使用して複数の VM を作成します。<br>＝＝＝＝＝＝＝＝＝＝＝＝  </p></blockquote><hr><h2 id="一般化したイメージからVMを複製"><a href="#一般化したイメージからVMを複製" class="headerlink" title="一般化したイメージからVMを複製"></a>一般化したイメージからVMを複製</h2><p>こちらの手順では、一般化 (VM 内の固有のファイルやデータを削除) した後に、イメージを作成し、そのイメージから新規に VM を作成 (複製) いただくこととなります。</p><p>一般化したイメージから VM を複製いただく手順は基本的に下記の流れになります。</p><ol><li>複製元となる VM を作成する</li><li>作成した VM で必要なソフトウェアのインストールや設定を行う</li><li>VM を一般化 (マシン固有のファイルとデータを削除) する</li><li>一般化した VM より [イメージ] を作成する</li><li>作成した [イメージ] より新規 VM を必要な数だけ作成する</li></ol><p>一般化とは、VM を複製したりするための下準備として、マシン固有のファイルとデータを削除するものとなります。<br>削除されるデータの例として、VM の管理者アカウント(Built-in Administrator) や SID (Security Identifier) があります。  </p><p>つまり、これらの情報は削除されていますので、イメージから新しく VM を作成 (複製) する際に、VM の管理者アカウントを設定し、SID も新規に割り振られるということとなります。<br>また、<strong><span style="color:red">一般化した VM は起動不可となるため再利用不可</span></strong> となりますので、ご注意ください。</p><p>なお、Windows VM では一般化をする際 Sysprep というツールを用います。<br>そのため [一般化する] = [Sysprep する] と同義で言われることも多いです。</p><p>こちらの詳細な手順は <a href="https://jpaztech.github.io/blog/vm/vm-replica-2">一般化したイメージから VM を複製する手順</a> をご参照ください。</p><hr><h2 id="OSディスクのスナップショットからVMを複製"><a href="#OSディスクのスナップショットからVMを複製" class="headerlink" title="OSディスクのスナップショットからVMを複製"></a>OSディスクのスナップショットからVMを複製</h2><p>一般化したイメージから VM を複製いただく手順は基本的に下記の流れになります。</p><ol><li>複製元となるVMを用意する</li><li>VM を停止 (割り当て解除) し、OS ディスクの [スナップショット] を取得</li><li>作成した [スナップショット] より必要な数だけ [ディスク] を作成</li><li>作成した [ディスク] より VM 作成する</li></ol><p>スナップショットからの複製でご注意いただきたい点として、スナップショットは VM 固有のファイルとデータは保持される、OS ディスクの完全読み取りコピーであるという点がございます。<br>つまり、複製した VM は SID やホスト名が複製元と同一になります。   </p><p>完全複製による意図しない動作を防止するため、同一 VNET 上で元 VM と複製 VM を同時に起動しないようにしてください。<br>スナップショットからの複製する場合は <strong><span style="color:red">別の VNET 上にデプロイするようにお願いいたします。</span></strong>     </p><p>こちらの詳細な手順は <a href="https://jpaztech.github.io/blog/vm/vm-replica-3">OS ディスクのスナップショットから VM を複製する手順</a> をご参照ください。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは、Azure テクニカル サポート チームの富田です。&lt;br&gt;今回はご案内することの多い、VM 複製方法についてとなります。&lt;/p&gt;
&lt;p&gt;本記事は 3 部作の 1 記事目です。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&quot;https://jpaztech.git
      
    
    </summary>
    
    
    
      <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
      <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
      <category term="Linux" scheme="https://jpaztech.github.io/blog/tags/Linux/"/>
    
      <category term="HowTo" scheme="https://jpaztech.github.io/blog/tags/HowTo/"/>
    
  </entry>
  
  <entry>
    <title>Tracking ID PLWV-BT0 と可用性について</title>
    <link href="https://jpaztech.github.io/blog/vm/plwv-bt0/"/>
    <id>https://jpaztech.github.io/blog/vm/plwv-bt0/</id>
    <published>2021-03-23T00:30:00.000Z</published>
    <updated>2021-04-27T07:25:57.417Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの鳥越です。</p><p>先日 (2021/02/26)、Azure 弊社基盤の問題により、東日本で仮想マシンを含むストレージ サービスをご利用いただいている一部のお客様に対し、多大なるご不便をおかけすることとなりました。</p><blockquote><p><strong>2/26</strong><br><strong>RCA - Azure Storage and dependent services - Japan East (Tracking ID PLWV-BT0)</strong></p><p>Azure status history<br><a href="https://status.azure.com/en-us/status/history/" target="_blank" rel="noopener">https://status.azure.com/en-us/status/history/</a></p></blockquote><a id="more"></a><p>上記の障害ですが、単一のストレージスケールユニット (下記、Storage Cluster) で発生した問題であり、 仮想マシンの構成として、可用性セット + 管理ディスクの構成をとることにより、可用性セット内のすべての仮想マシンが同時に障害の影響を受けることを防ぐことが可能でした。</p><p>これは、下記の図のように、Storage Cluster についても適切に障害ドメインを分ける挙動を取るためです。</p><p><img src="/blog/vm/plwv-bt0/01.png" alt=""></p><p>※ Storage Cluster に対して FD0、FD1、FD2 として障害ドメインが分かれていることが確認可能かと存じます。</p><p>ただし、可用性セットを組む際に以下のように最初に作成した仮想マシンを、次の仮想マシンを作成する際に、事前に割り当て解除していた場合、障害ドメインが適切に分散されません。 </p><p><strong>1. 最初の仮想マシンをデプロイする</strong><br><strong>2. 最初の仮想マシンを停止 (割り当て解除) する</strong><br><strong>3. 次の仮想マシンをデプロイする</strong></p><p>この場合、更新ドメインは分かれていますが障害ドメインが同一となります。</p><p>&lt;参考イメージ&gt;<br><img src="/blog/vm/plwv-bt0/02.png" alt=""></p><p>これを図で表すと下記のようになります。<br>たとえ可用性セットを構成していたとしてもストレージ レイヤの障害で可用性セット内のすべての仮想マシンに影響が発生する可能性があることをご確認いただけるとかと存じます。</p><p><img src="/blog/vm/plwv-bt0/03.png" alt=""></p><p>そのため、障害ドメインが同一となっている仮想マシンについては障害ドメインの変更が必要となりますが、この障害ドメインは <span style="color:red;"><strong>可用性セットに仮想マシンを作成したタイミングで自動的に割り当てられるため仮想マシン作成後に変更いただくことは叶いません。</strong></span></p><p>そこで下記手順にて仮想マシンの再作成を行うことにより、障害ドメインの変更を実施いただけます。</p><p>障害ドメインが同一の状態からどのように障害ドメインを分けるか、またその結果どうなるかを含め下記に記載したいと思いますので、ご参考いただけますと幸いでございます。</p><ol><li><p>可用性セット内の仮想マシンで障害ドメインが同一であることを確認<br><img src="/blog/vm/plwv-bt0/04.png" alt=""></p></li><li><p>(参考) この時に OS ディスクがどのようになっているかを確認してみましょう。<br>ディスクのエクスポートを行うことで OS ディスクのストレージ アカウントとコンテナを確認することが可能です。<br>(ディスクのエクスポートは事前に仮想マシンの割り当て解除が必要です)<br><img src="/blog/vm/plwv-bt0/05.png" alt=""><br><img src="/blog/vm/plwv-bt0/06.png" alt=""></p></li></ol><blockquote><p>リンク: https://<span style="color:red;"><strong>md-dmxg3kx5tqjr</strong></span>.z43.blob.storage.azure.net/<span style="color:red;"><strong>4kthfmkhnglv</strong></span>/abcd?sv=2018-03-28&amp;sr=b&amp;si=048a5665-b278-4dd4-a6c5-fc3a661be840&amp;sig=ssM5KVUHxxxxxxxxxxcLxGNIkbGFucF4I6qsgw%2BAW5Zw%3D</p></blockquote><ol start="3"><li>以下のスクリプトを利用します。<br>このスクリプトを利用することで既存のリソースを利用して仮想マシンの再作成を行うことが可能です。<br>※ このスクリプトは仮想マシンがロード バランサーに接続されているかどうかは確認されません。<br>※ もしエラー等発生いたしましたらスクリプトの改変をご検討ください。</li></ol><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    <span class="variable">$resourceGroup</span> = <span class="string">"AVSET"</span> <span class="comment"># Resouce Group Name </span></span><br><span class="line">    <span class="variable">$vmName</span> = <span class="string">"AV01"</span>         <span class="comment"># VM Name </span></span><br><span class="line">    <span class="variable">$newAvailSetName</span> = <span class="string">"AvailabilitySet"</span> <span class="comment"># Availability Set Name  </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Get the details of the VM to be moved to the Availability Set </span></span><br><span class="line">    <span class="variable">$originalVM</span> = <span class="built_in">Get-AzVM</span> ` </span><br><span class="line">        <span class="literal">-ResourceGroupName</span> <span class="variable">$resourceGroup</span> ` </span><br><span class="line">        <span class="literal">-Name</span> <span class="variable">$vmName</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># Create new availability set if it does not exist </span></span><br><span class="line">    <span class="variable">$availSet</span> = <span class="built_in">Get-AzAvailabilitySet</span> ` </span><br><span class="line">        <span class="literal">-ResourceGroupName</span> <span class="variable">$resourceGroup</span> ` </span><br><span class="line">        <span class="literal">-Name</span> <span class="variable">$newAvailSetName</span> ` </span><br><span class="line">        <span class="literal">-ErrorAction</span> Ignore </span><br><span class="line">    <span class="keyword">if</span> (<span class="operator">-Not</span> <span class="variable">$availSet</span>) &#123; </span><br><span class="line">        <span class="variable">$availSet</span> = <span class="built_in">New-AzAvailabilitySet</span> ` </span><br><span class="line">            <span class="literal">-Location</span> <span class="variable">$originalVM</span>.Location ` </span><br><span class="line">            <span class="literal">-Name</span> <span class="variable">$newAvailSetName</span> ` </span><br><span class="line">            <span class="literal">-ResourceGroupName</span> <span class="variable">$resourceGroup</span> ` </span><br><span class="line">            <span class="literal">-PlatformFaultDomainCount</span> <span class="number">2</span> ` </span><br><span class="line">            <span class="literal">-PlatformUpdateDomainCount</span> <span class="number">2</span> ` </span><br><span class="line">            <span class="literal">-Sku</span> Aligned </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line"><span class="comment"># Remove the original VM </span></span><br><span class="line">    <span class="built_in">Remove-AzVM</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$resourceGroup</span> <span class="literal">-Name</span> <span class="variable">$vmName</span>     </span><br><span class="line"></span><br><span class="line"><span class="comment"># Create the basic configuration for the replacement VM.  </span></span><br><span class="line">    <span class="variable">$newVM</span> = <span class="built_in">New-AzVMConfig</span> ` </span><br><span class="line">        <span class="literal">-VMName</span> <span class="variable">$originalVM</span>.Name ` </span><br><span class="line">        <span class="literal">-VMSize</span> <span class="variable">$originalVM</span>.HardwareProfile.VmSize ` </span><br><span class="line">        <span class="literal">-AvailabilitySetId</span> <span class="variable">$availSet</span>.Id </span><br><span class="line"></span><br><span class="line"><span class="comment"># For a Linux VM, change the last parameter from -Windows to -Linux  </span></span><br><span class="line"><span class="comment"># Linux の場合は一番下のパラメータを -Linux としてください。 </span></span><br><span class="line">    <span class="built_in">Set-AzVMOSDisk</span> ` </span><br><span class="line">        <span class="literal">-VM</span> <span class="variable">$newVM</span> <span class="literal">-CreateOption</span> Attach ` </span><br><span class="line">        <span class="literal">-ManagedDiskId</span> <span class="variable">$originalVM</span>.StorageProfile.OsDisk.ManagedDisk.Id ` </span><br><span class="line">        <span class="literal">-Name</span> <span class="variable">$originalVM</span>.StorageProfile.OsDisk.Name ` </span><br><span class="line">        <span class="literal">-Windows</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># Add Data Disks </span></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$disk</span> <span class="keyword">in</span> <span class="variable">$originalVM</span>.StorageProfile.DataDisks) &#123;  </span><br><span class="line">        <span class="built_in">Add-AzVMDataDisk</span> <span class="literal">-VM</span> <span class="variable">$newVM</span> ` </span><br><span class="line">            <span class="literal">-Name</span> <span class="variable">$disk</span>.Name ` </span><br><span class="line">            <span class="literal">-ManagedDiskId</span> <span class="variable">$disk</span>.ManagedDisk.Id ` </span><br><span class="line">            <span class="literal">-Caching</span> <span class="variable">$disk</span>.Caching ` </span><br><span class="line">            <span class="literal">-Lun</span> <span class="variable">$disk</span>.Lun ` </span><br><span class="line">            <span class="literal">-DiskSizeInGB</span> <span class="variable">$disk</span>.DiskSizeGB ` </span><br><span class="line">            <span class="literal">-CreateOption</span> Attach </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add NIC(s) and keep the same NIC as primary; keep the Private IP too, if it exists.  </span></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$nic</span> <span class="keyword">in</span> <span class="variable">$originalVM</span>.NetworkProfile.NetworkInterfaces) &#123;     </span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$nic</span>.Primary <span class="operator">-eq</span> <span class="string">"True"</span>) &#123; </span><br><span class="line">            <span class="built_in">Add-AzVMNetworkInterface</span> ` </span><br><span class="line">                <span class="literal">-VM</span> <span class="variable">$newVM</span> ` </span><br><span class="line">                <span class="literal">-Id</span> <span class="variable">$nic</span>.Id <span class="literal">-Primary</span> </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span> &#123; </span><br><span class="line">            <span class="built_in">Add-AzVMNetworkInterface</span> ` </span><br><span class="line">                <span class="literal">-VM</span> <span class="variable">$newVM</span> ` </span><br><span class="line">                <span class="literal">-Id</span> <span class="variable">$nic</span>.Id  </span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line"><span class="comment"># Recreate the VM </span></span><br><span class="line">    <span class="built_in">New-AzVM</span> ` </span><br><span class="line">       <span class="literal">-ResourceGroupName</span> <span class="variable">$resourceGroup</span> ` </span><br><span class="line">       <span class="literal">-Location</span> <span class="variable">$originalVM</span>.Location ` </span><br><span class="line">       <span class="literal">-VM</span> <span class="variable">$newVM</span> ` </span><br><span class="line">       <span class="literal">-DisableBginfoExtension</span></span><br></pre></td></tr></table></figure><ol start="4"><li>可用性セット内で仮想マシンの障害ドメインが適切に分かれていることをご確認ください。</li></ol><p><img src="/blog/vm/plwv-bt0/07.png" alt=""></p><ol start="5"><li>(参考) 障害ドメインを変更した際に、管理ディスクがどのように変わるか確認してみましょう。こちらも 2. と同様に、ディスクのエクスポートにてストレージ アカウントとコンテナを確認いただけます。</li></ol><p><img src="/blog/vm/plwv-bt0/08.png" alt=""></p><blockquote><p>リンク: https://<span style="color:red;"><strong>md-szxnwvfc5gpr</strong></span>.z44.blob.storage.azure.net/<span style="color:red;"><strong>kz3p403l4zcs</strong></span>/abcd?sv=2018-03-28&amp;sr=b&amp;si=1435231a-850c-457a-b12a-3d0988036177&amp;sig=cHP3SMf0gKxxxxxxxxBmbp7GSnUgC2T63JB18V49s2c%3D</p></blockquote><p>2.の時からストレージ アカウントの変更が行われたことが確認いただけます。</p><p>つまり、この結果は、障害ドメインを分けたことによりストレージ レイヤの障害ドメインが適切に分かれるようにストレージ アカウントの変更が実施されたことを意味します。<br>このように、適切に更新ドメイン、障害ドメインを構成することにより、Azure 基盤での問題が発生したとしても多くのケースで業務を継続いただけます。</p><p>弊社といたしましては、可能な限りAzure 基盤側でのお客様の仮想マシンへの影響を無くすように日々改善を行っておりますが、この度のような障害は大変心苦しいのですが起こり得ることがございます。<br>そのため、事前の備えと致しましても、また、業務継続性といった観点からも可用性ゾーン、可用性セット、管理ディスクといった構成をご検討いただけますと幸いでございます。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;こんにちは。Azure テクニカル サポート チームの鳥越です。&lt;/p&gt;
&lt;p&gt;先日 (2021/02/26)、Azure 弊社基盤の問題により、東日本で仮想マシンを含むストレージ サービスをご利用いただいている一部のお客様に対し、多大なるご不便をおかけすることとなりました。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;2/26&lt;/strong&gt;&lt;br&gt;&lt;strong&gt;RCA - Azure Storage and dependent services - Japan East (Tracking ID PLWV-BT0)&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Azure status history&lt;br&gt;&lt;a href=&quot;https://status.azure.com/en-us/status/history/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://status.azure.com/en-us/status/history/&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
    
      <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
      <category term="Availability Zone" scheme="https://jpaztech.github.io/blog/tags/Availability-Zone/"/>
    
      <category term="Availability Set" scheme="https://jpaztech.github.io/blog/tags/Availability-Set/"/>
    
  </entry>
  
  <entry>
    <title>リソース グループ名の大文字・小文字について</title>
    <link href="https://jpaztech.github.io/blog/vm/resourcegroup-uppercase-lowercase/"/>
    <id>https://jpaztech.github.io/blog/vm/resourcegroup-uppercase-lowercase/</id>
    <published>2021-03-22T08:30:00.000Z</published>
    <updated>2021-04-27T07:25:57.433Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの富田です。<br>今回は、お問い合わせいただくことの多い、リソース グループ名の大文字・小文字についてとなります。  </p><p>小文字でリソース グループ名を作成したのに Azure ポータル上では大文字で表示されるといったような、<br>お問い合わせいただくことがございます。<br>例としては下記のような表示となります。</p><table><thead><tr><th>作成したリソース グループ名</th><th>Azure ポータル上で表示されるリソース グループ名</th></tr></thead><tbody><tr><td>rgname</td><td>RGNAME</td></tr><tr><td>RGNAME</td><td>rgname</td></tr><tr><td>Rgname</td><td>RGNAME</td></tr><tr><td>Rgname</td><td>rgname</td></tr></tbody></table><p>結論から申し上げますと、これは現行の Azure においては想定される仕様の範囲内の動作であり、<br>残念ながら、現時点では回避策のご用意がございません。<br>ただし、本動作によって、Azure をお使い頂く上で問題が発生するものではございませんのでご安心ください。  </p><p>まず次のドキュメントにも記載がございますとおり、リソース グループにおいては<br>そのリソース名の大文字と小文字は区別されないものとなっております。  </p><p>参照: Azure リソースの名前付け規則と制限事項<br><a href="https://docs.microsoft.com/ja-jp/azure/azure-resource-manager/management/resource-name-rules" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/azure-resource-manager/management/resource-name-rules</a></p><blockquote><p>＝＝＝＝＝抜粋＝＝＝＝＝<br>「有効な文字」列に特に明記されていない限り、リソース名では大文字と小文字は区別されません。<br>＝＝＝＝＝＝＝＝＝＝＝＝  </p></blockquote><p>したがいまして、リソース グループ名に大文字・小文字が混在している状態でありましても、<br>Azure の動作に影響を及ぼすものではございません。<br>上述の例を参考にしますと、</p><ul><li>rgname</li><li>RGNAME</li><li>Rgname</li></ul><p>これら3つの表記は区別されず同じリソース グループとして扱われることとなります。<br>Azure Powershell や Azure CLI のコマンドパラメータとしてリソースグループ名をご指定いただく際にも、<br>大文字・小文字が異なることへの配慮は不要でございます。  </p><p>また、 Azure ポータルでのリソース グループ名の表示において、大文字・小文字の名称が混在する<br>状況についても現行のAzureにおいて仕様となっております。  </p><p>仕様についてご意見やご要望がございます場合には、お手数ですが<br>下記のフィードバックサイト、もしくは Azure ポータル右上のフィードバックより、ご要望をご投稿いただけますと幸いです。  </p><ul><li>Azure Genaral Feedback<br><a href="https://feedback.azure.com/forums/34192--general-feedback" target="_blank" rel="noopener">https://feedback.azure.com/forums/34192--general-feedback</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは、Azure テクニカル サポート チームの富田です。&lt;br&gt;今回は、お問い合わせいただくことの多い、リソース グループ名の大文字・小文字についてとなります。  &lt;/p&gt;
&lt;p&gt;小文字でリソース グループ名を作成したのに Azure ポータル上では大文字で表示され
      
    
    </summary>
    
    
    
      <category term="Resource Group" scheme="https://jpaztech.github.io/blog/tags/Resource-Group/"/>
    
  </entry>
  
  <entry>
    <title>Azure File Sync よくあるお問合せ - FAQ</title>
    <link href="https://jpaztech.github.io/blog/storage/storageFileSyncFAQ/"/>
    <id>https://jpaztech.github.io/blog/storage/storageFileSyncFAQ/</id>
    <published>2021-03-18T08:30:00.000Z</published>
    <updated>2021-04-27T07:25:57.365Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの木下です。</p><p>Azure File Sync に関して、たびたびお問合せいただくことがございます。<br>今回は、よくあるお問い合わせのうち下記 2 つの項目についてご紹介いたします。</p><p><strong>・ファイルの同期周期に関する FAQ</strong><br><strong>・同期の一時停止に関する FAQ</strong></p><a id="more"></a><h2 id="ファイルの同期周期に関する-FAQ"><a href="#ファイルの同期周期に関する-FAQ" class="headerlink" title="ファイルの同期周期に関する FAQ"></a>ファイルの同期周期に関する FAQ</h2><p><strong>Q1.</strong><br>Azure Portal から ファイルをアップロードしましたがサーバーエンドポイントに反映されません。原因を教えてください。</p><p><strong>A1.</strong><br>Azure Portal または SMB を使用して Azure ファイル共有に加えられた変更は<strong>即時反映されません</strong>。Azure File Sync には、”変更検出ジョブ” という 24 時間ごとに実行するようスケジュールされたジョブがあります。</p><p>その “変更検出ジョブ” によって Azure ファイル共有上のファイルに変更が加えられていることが検出された場合に、Azure File Sync が同期セッションを開始し、サーバーエンドポイントへ反映されることとなります。</p><blockquote><p>参考 )<br>□SMB またはポータルで Azure ファイル共有に直接ファイルを作成しました。<br>このファイルが同期グループのサーバーに同期されるまでどのくらいの時間がかかりますか。<br><a href="https://docs.microsoft.com/ja-jp/azure/storage/files/storage-files-faq" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/storage/files/storage-files-faq</a></p></blockquote><p>サーバーエンドポイントおよびクラウドエンドポイントでの同期周期は以下の通りです。</p><table><thead><tr><th>ファイル操作元</th><th>同期周期</th></tr></thead><tbody><tr><td>サーバーエンドポイント</td><td>即時</td></tr><tr><td>クラウドエンドポイント (Azure Portal または SMB)</td><td>約 24 時間ごと</td></tr></tbody></table><p>サーバーエンドポイント、クラウドエンドポイントから各々ファイルをアップロードした際の同期グループへの反映状況を確認してみます。</p><p><strong>■サーバーエンドポイントでファイルをアップロードした場合</strong></p><p>サーバーエンドポイント でファイルを追加します。<br><img src="/blog/storage/storageFileSyncFAQ/Storage01.png" alt=""></p><p>サーバーエンドポイントで作成したファイルは Azure Portal 上の ファイル共有 内に即時反映されたことが確認できます。<br><img src="/blog/storage/storageFileSyncFAQ/Storage02.png" alt=""></p><p><strong>■クラウドエンドポイント (Azure Portal)でファイルをアップロードした場合</strong></p><p>Azure Portal &gt; ファイル共有 よりファイルをアップロードします。<br><img src="/blog/storage/storageFileSyncFAQ/Storage03.png" alt=""></p><p>サーバーエンドポイント側にはファイルが即時反映されていません。<br><img src="/blog/storage/storageFileSyncFAQ/Storage04.png" alt=""></p><p><strong>Q2.</strong><br>Azure Portal または SMB を使用して Azure ファイル共有に加えられた変更に関しては、24 時間ごとの変更検出ジョブを待つしかないのでしょうか。</p><p><strong>A2.</strong><br>いいえ、手動にはなりますが Azure ファイル共有上で変更されたファイルを即時でサーバーエンドポイントへ同期したい場合は、<strong>Invoke-AzStorageSyncChangeDetection</strong> PowerShell コマンドレットを使用いただくことで変更検出ジョブの実行を待つことなく、同期グループ上のサーバーエンドポイントへ反映させることが可能です。</p><p>例)<br>PowerShell より Invoke-AzStorageSyncChangeDetection を実行<br><img src="/blog/storage/storageFileSyncFAQ/Storage05.png" alt=""></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Invoke-AzStorageSyncChangeDetection </span><br><span class="line"> -ResourceGroupName "リソースグループ名" </span><br><span class="line"> -StorageSyncServiceName "ストレージ同期サービス名" </span><br><span class="line"> -SyncGroupName "同期グループ名" </span><br><span class="line"> -CloudEndpointName "クラウドエンドポイント名" </span><br><span class="line"> -DirectoryPath "ディレクトリパス名"</span><br></pre></td></tr></table></figure><p>サーバーエンドポイントへ反映されたことを確認します。<br><img src="/blog/storage/storageFileSyncFAQ/Storage06.png" alt=""></p><blockquote><p>&lt;ご参考&gt;<br>□Invoke-AzStorageSyncChangeDetection<br><a href="https://docs.microsoft.com/ja-jp/powershell/module/az.storagesync/invoke-azstoragesyncchangedetection?view=azps-5.5.0" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/powershell/module/az.storagesync/invoke-azstoragesyncchangedetection?view=azps-5.5.0</a><br>□Get-AzStorageSyncCloudEndpoint<br><a href="https://docs.microsoft.com/ja-jp/powershell/module/az.storagesync/get-azstoragesynccloudendpoint?view=azps-5.5.0" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/powershell/module/az.storagesync/get-azstoragesynccloudendpoint?view=azps-5.5.0</a></p></blockquote><h2 id="同期の一時停止に関する-FAQ"><a href="#同期の一時停止に関する-FAQ" class="headerlink" title="同期の一時停止に関する FAQ"></a>同期の一時停止に関する FAQ</h2><p><strong>Q.</strong><br>Azure File Sync の同期を一時停止させることはできますか。</p><p><strong>A.</strong><br>はい、同期グループ内のサーバーエンドポイント側で設定を行っていただくことで一時的に同期を停止させることが可能です。</p><p><strong>■サーバーエンドポイントにて同期を一時停止する手順</strong></p><ol><li>対象のサーバーエンドポイント側のレジストリで以下の値を作成します。<br>#既定では “Settings” はないため手動で作成してください。<br><img src="/blog/storage/storageFileSyncFAQ/Storage07.png" alt=""></li></ol><p><img src="/blog/storage/storageFileSyncFAQ/Storage08.png" alt=""></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Key: [HKLM(HKEY_LOCAL_MACHINE)]\SYSTEM\CurrentControlSet\Services\FileSyncSvc\Settings</span><br><span class="line">Type: REG_DWORD</span><br><span class="line">Value name: StopSync</span><br><span class="line">Value: 1</span><br></pre></td></tr></table></figure><ol start="2"><li><p>サービスから “Storage Sync Agent” を再起動します。<br><img src="/blog/storage/storageFileSyncFAQ/Storage09.png" alt=""></p></li><li><p>サーバーエンドポイント側でアップロードしたファイルが Azure Portal 上へ反映されていないことを確認します。<br><img src="/blog/storage/storageFileSyncFAQ/Storage10.png" alt=""></p></li></ol><p><img src="/blog/storage/storageFileSyncFAQ/Storage11.png" alt=""></p><blockquote><p>注意)<br>この操作では同期のみが停止され、ファイルの変更検出や階層化の呼び戻しは実行されますのでご留意ください。</p></blockquote><p>同期を再開いただく場合には、レジストリより “StopSync” を削除のうえ再度サービスより “Storage Sync Agent” の再起動を行ってください。<br><img src="/blog/storage/storageFileSyncFAQ/Storage12.png" alt=""></p><p>StopSync を削除しStorage Sync Agent の再起動を行うと Azure Portal 上へファイルの同期が再開されます。<br><img src="/blog/storage/storageFileSyncFAQ/Storage13.png" alt=""></p><blockquote><p>注意)<br>サーバーエンドポイントの削除、Storage Sync Agent の停止は基本的に推奨されない手順となります。<br>上記一時停止がご要望に沿わない場合、まずは対応方針について弊社サポート部門までお問い合わせください。</p></blockquote><p>本稿は以上となりますが、いかがでしたでしょうか。 本稿が皆様のお役に立てれば幸いです。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;こんにちは、Azure テクニカル サポート チームの木下です。&lt;/p&gt;
&lt;p&gt;Azure File Sync に関して、たびたびお問合せいただくことがございます。&lt;br&gt;今回は、よくあるお問い合わせのうち下記 2 つの項目についてご紹介いたします。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;・ファイルの同期周期に関する FAQ&lt;/strong&gt;&lt;br&gt;&lt;strong&gt;・同期の一時停止に関する FAQ&lt;/strong&gt;&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="Storage" scheme="https://jpaztech.github.io/blog/tags/Storage/"/>
    
  </entry>
  
  <entry>
    <title>特定の AKS ノードを再起動または削除したい</title>
    <link href="https://jpaztech.github.io/blog/containers/aks-maintenance-for-node/"/>
    <id>https://jpaztech.github.io/blog/containers/aks-maintenance-for-node/</id>
    <published>2021-02-10T03:00:00.000Z</published>
    <updated>2021-04-27T07:25:57.333Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは- Azure テクニカルサポートチームの大野です。<br>今回は良くお問合せいただく内容として、特定の AKS ノードの再起動または削除についてご案内したいと思います。</p><h2 id="そもそもサポート外の操作ですか？"><a href="#そもそもサポート外の操作ですか？" class="headerlink" title="そもそもサポート外の操作ですか？"></a>そもそもサポート外の操作ですか？</h2><p>Azure Kubernetes Service (AKS) についてよく寄せられる質問でも下記の通り、サポートされない操作と記載があります。</p><blockquote><p><a href="https://docs.microsoft.com/ja-jp/azure/aks/faq#can-i-stop-or-de-allocate-all-my-vms" target="_blank" rel="noopener">すべての VM を停止したり、その割り当てを解除したりできますか?</a> より引用</p><p>これは、直接 AKS のリソースの操作を行うことにより、AKS として管理している情報と不整合 (例えば、仮想マシ<br>ンを直接削除したが、AKS のノードとしてまだ残っている状態、等) が起きる恐れがあるため、このような記載が<br>されています。</p></blockquote><p>これは、Azure のリソースを直接操作した場合に、AKS (Kubernetes) から見たときに情報の整合性が取れなくなるためになります。<br>ただ、特定のノードがおかしい等により再起動や削除されたいといったご要望があるかと思いますので、以下、実行例を交えて手順について纏めてみました。</p><p>なお、ノードの不調については、Azure 基盤の自動修復をはじめ、AKS の自動修復により改善されることがあります。<br>この話はまた別の機会にでも。</p><h2 id="特定のノードを再起動"><a href="#特定のノードを再起動" class="headerlink" title="特定のノードを再起動"></a>特定のノードを再起動</h2><p>まずは、特定のノードを再起動する場合の操作手順になります。<br>流れとしては、以下になります。</p><ol><li>該当ノードからワークロードを退避し、新たに Pod がスケジュールされないように対象から除外</li><li>再起動を実施</li><li>該当ノードを再度 AKS クラスターのスケジュールに組み込むよう設定</li></ol><hr><ol><li>該当ノードからワークロードを退避し、新たに Pod がスケジュールされないように対象から除外</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get nodes</span></span><br><span class="line">NAME                                STATUS   ROLES   AGE   VERSION</span><br><span class="line">aks-nodepool1-40771167-vmss000000   Ready    agent   24h   v1.18.10</span><br><span class="line">aks-nodepool1-40771167-vmss000001   Ready    agent   24h   v1.18.10</span><br><span class="line">aks-nodepool1-40771167-vmss000002   Ready    agent   24h   v1.18.10</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl drain &lt;ノード名&gt; --ignore-daemonsets --delete-local-data --force</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 対象ノードが <span class="string">"SchedulingDisabled"</span> になっていることを確認</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl get nodes</span></span><br><span class="line">NAME                                STATUS                     ROLES   AGE     VERSION</span><br><span class="line">aks-nodepool1-40771167-vmss000000   Ready,SchedulingDisabled   agent   4d17h   v1.18.10</span><br><span class="line">aks-nodepool1-40771167-vmss000001   Ready                      agent   4d17h   v1.18.10</span><br><span class="line">aks-nodepool1-40771167-vmss000002   Ready                      agent   4d17h   v1.18.10</span><br></pre></td></tr></table></figure><ol start="2"><li>再起動を実施</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> VMSS の場合</span></span><br><span class="line">az vmss restart -g MC_labvmssaks_labvmssaks_japaneast -n aks-nodepool1-40771167-vmss --instance-ids 0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可用性セットの場合</span></span><br><span class="line">az vm restart -g MC_labasaks_labasaks_japaneast -n aks-nodepool1-19417627-0</span><br></pre></td></tr></table></figure><ol start="3"><li>該当ノードを再度 AKS クラスターのスケジュールに組み込むよう設定</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl uncordon aks-nodepool1-40771167-vmss000000</span></span><br><span class="line">node/aks-nodepool1-40771167-vmss000000 uncordoned</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 対象ノードの STATUS が <span class="string">"Ready"</span> になっていることを確認</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl get nodes</span></span><br><span class="line">NAME                                STATUS   ROLES   AGE     VERSION</span><br><span class="line">aks-nodepool1-40771167-vmss000000   Ready    agent   4d17h   v1.18.10</span><br><span class="line">aks-nodepool1-40771167-vmss000001   Ready    agent   4d17h   v1.18.10</span><br><span class="line">aks-nodepool1-40771167-vmss000002   Ready    agent   4d17h   v1.18.10</span><br></pre></td></tr></table></figure><p>注意点としては、ノードを組み込んだ後に、Pod の配置の平滑化は行なわれることはありませんので、<br>必要に応じて、<a href="https://github.com/kubernetes-sigs/descheduler" target="_blank" rel="noopener">Descheduler</a> 等による平滑化をご検討ください。</p><h2 id="特定のノードを削除"><a href="#特定のノードを削除" class="headerlink" title="特定のノードを削除"></a>特定のノードを削除</h2><p>特定のノードの削除時も <code>kubectl drain</code> により退避させてから行う点は同じになります。<br>加えて、<code>kubectl delete node</code> により、Kubernetes におけるノードリソースの削除を行います。</p><ol><li>該当ノードからワークロードを退避し、新たに Pod がスケジュールされないように対象から除外</li><li>該当ノードを AKS の管理情報から削除</li><li>対象ノードやリソースを削除</li><li>必要に応じてスケールアウトを実施</li></ol><hr><ol><li>該当ノードで稼働するワークロードを別のノードに退避</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 対象ノードを確認</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl get nodes</span></span><br><span class="line">NAME                                STATUS   ROLES   AGE     VERSION</span><br><span class="line">aks-nodepool1-40771167-vmss000000   Ready    agent   5d15h   v1.18.10</span><br><span class="line">aks-nodepool1-40771167-vmss000001   Ready    agent   5d15h   v1.18.10</span><br><span class="line">aks-nodepool1-40771167-vmss000002   Ready    agent   5d15h   v1.18.10</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 対象ノードからワークロードを退避し、スケジュールから除外 (drain)</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl drain aks-nodepool1-40771167-vmss000000 --ignore-daemonsets --delete-emptydir-data</span></span><br></pre></td></tr></table></figure><ol start="2"><li>該当ノードを AKS の管理情報から削除</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete node aks-nodepool1-40771167-vmss000000</span><br></pre></td></tr></table></figure><p>次にノードにあたる仮想マシン/仮想マシンスケールセット インスタンスや関連するリソースを Azure ポータルまたは CLI 操作により削除します。</p><ol start="3"><li>対象ノードやリソースを削除</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 可用性セットの場合 (AvailabilitySet)</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> az vm delete -g MC_LABASAKS_LABASAKS_JAPANEAST -n aks-nodepool1-19417627-0</span></span><br><span class="line">Are you sure you want to perform this operation? (y/n): y</span><br><span class="line"><span class="meta">$</span><span class="bash"> az network nic delete -g MC_labasaks_labasaks_japaneast -n aks-nodepool1-19417627-nic-0</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> az disk delete -g MC_LABASAKS_LABASAKS_JAPANEAST -n aks-nodepool1-19417627-0_OsDisk_1_17ecc8db96374f15a4b91dfc9ce17749</span></span><br><span class="line">Are you sure you want to perform this operation? (y/n): y</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 仮想マシンスケールセットの場合 (VirtualMachineScaleSets)</span></span><br><span class="line">az vmss delete-instances -g MC_labvmssaks_labvmssaks_japaneast -n aks-nodepool1-40771167-vmss --instance-ids 0</span><br></pre></td></tr></table></figure><div style="background-color:#e2daf1 !important; padding: 1px 14px !important; border-radius: 10px !important;"><p><strong>注意</strong><br>上記のように Azure のリソースを削除しない場合に、スケーリング操作を行なうと、まだノードがあると認識され、<br>正しくスケーリング操作が行なわれません。</p><p>例えば、3台ノードがあった場合に、1台ノードを <code>kubectl delete</code> により削除後、Azure のリソースを削除を行わないで、<br>スケールイン (2 台) を行なった場合、先のノードが存在すると認識され、別の仮想マシンまたは仮想マシンスケールセット インスタンスが削除されてしまいます。</p><p>そのため、本操作を実施される場合には、必ず Azure のリソースも併せて削除してください。</p></div><ol start="4"><li>必要に応じてスケールアウトを実施</li></ol><p>最後に必要に応じまして、台数の調整を実施してください。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> az aks scale -g labasaks -n labasaks --node-count 3</span></span><br></pre></td></tr></table></figure><h2 id="PodDisruptionBudget-による可用性の向上"><a href="#PodDisruptionBudget-による可用性の向上" class="headerlink" title="PodDisruptionBudget による可用性の向上"></a>PodDisruptionBudget による可用性の向上</h2><p><code>kubectl drain</code> は内部で、Eviction (退避) API が呼ばれますが、この Eviction API は Pod を削除する動作となります。<br>(ReplicaSet を組んでいない Pod は単純に削除されることになります。)</p><blockquote><p><a href="https://kubernetes.io/docs/tasks/administer-cluster/safely-drain-node/#eviction-api" target="_blank" rel="noopener">The Eviction API</a> より引用</p><p>The eviction subresource of a Pod can be thought of as a kind of policy-controlled DELETE operation on the Pod itself</p></blockquote><p>そのため、連続してノードを Drain を実施されたとき、Pod がまだ正常に起動しておらず、サービス断が発生する恐れがあります。</p><p>PodDisruptionBudget 設定されておりますと、Eviction API が呼ばれたときに、設定された Pod 数の稼働状況を見て、Pod を削除するか判断されますので、ワークロードの可用性に考慮して設定いただければと思います。</p><blockquote><p>ご参考情報;</p><ul><li><a href="https://kubernetes.io/docs/tasks/administer-cluster/safely-drain-node/" target="_blank" rel="noopener">Safely Drain a Node - Kubernetes</a></li><li><a href="https://kubernetes.io/docs/concepts/workloads/pods/disruptions/" target="_blank" rel="noopener">Disruption - Kubernetess</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/aks/operator-best-practices-scheduler#plan-for-availability-using-pod-disruption-budgets" target="_blank" rel="noopener">ポッド中断バジェットを使用して可用性を計画する - Azure Kubernetes Service (AKS) での基本的なスケジューラ機能に関するベスト プラクティス</a></li></ul></blockquote><br>以上で、特定のノードを再起動/削除する手順を紹介させていただきました。本稿がお役に立てれば幸いです。]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは- Azure テクニカルサポートチームの大野です。&lt;br&gt;今回は良くお問合せいただく内容として、特定の AKS ノードの再起動または削除についてご案内したいと思います。&lt;/p&gt;
&lt;h2 id=&quot;そもそもサポート外の操作ですか？&quot;&gt;&lt;a href=&quot;#そもそもサポ
      
    
    </summary>
    
    
    
      <category term="Containers" scheme="https://jpaztech.github.io/blog/tags/Containers/"/>
    
      <category term="Azure Kubernetes Service (AKS)" scheme="https://jpaztech.github.io/blog/tags/Azure-Kubernetes-Service-AKS/"/>
    
  </entry>
  
  <entry>
    <title>Azure Windows VM で記憶域スペースを拡張する</title>
    <link href="https://jpaztech.github.io/blog/vm/extend-storage-space-on-azure-windows-vm/"/>
    <id>https://jpaztech.github.io/blog/vm/extend-storage-space-on-azure-windows-vm/</id>
    <published>2021-02-05T07:30:00.000Z</published>
    <updated>2021-04-27T07:25:57.397Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの重田です。</p><p>Azure Windows VM において記憶域スペースをご構成いただいているお客様や、SQL VM (SQL Server on Windows Server) をご利用いただいているお客様より、ディスクの拡張方法に関してお問い合わせをいただくことが多いので、手順についてご紹介します。</p><a id="more"></a><div style="background-color:#d2f9d2 !important; padding: 1px 14px !important; border-radius: 10px !important;"><p><strong>ご参考</strong><br>公開情報: <a href="https://docs.microsoft.com/ja-jp/windows-server/storage/storage-spaces/overview" target="_blank" rel="noopener">記憶域スペースの概要</a></p><p>対象サーバー OS:<br>Windows Server 2019、Windows Server 2016、Windows Server 2012 R2、Windows Server 2012</p></div><h2 id="■-通常の-Windows-VM-に関して"><a href="#■-通常の-Windows-VM-に関して" class="headerlink" title="■ 通常の Windows VM に関して"></a>■ 通常の Windows VM に関して</h2><h3 id="□-作業概要"><a href="#□-作業概要" class="headerlink" title="□ 作業概要"></a>□ 作業概要</h3><p>記憶域スペースを拡張いただく場合には、下記の 2 方法があります。それぞれの方法について、シンプル レイアウトの記憶域スペースを用いた検証結果を踏まえてご紹介します。</p><ol><li>記憶域プールに新規のディスクを追加し、仮想ディスクおよびボリュームを拡張する。</li><li>記憶域スペースを再作成する。<br>仮想ディスク上のデータを別ディスクなどに退避いただき、仮想ディスクならびに記憶域プールを削除する。<br>その後、記憶域プールを構成していたディスクを拡張し、再度記憶域プールならびに仮想ディスクを作成する。</li></ol><div style="background-color:#e2daf1 !important; padding: 1px 14px !important; border-radius: 10px !important;"><p><strong>注意</strong><br>記憶域プールは複数のディスクを 1 つの記憶域としてまとめて、まとめられた記憶域から仮想ディスクの領域を切り出します。<br>記憶域プール自体に新たに領域を足すことは想定されておりますが、すでに仮想ディスクとして切り出された土台となる領域 (記憶域プールを構成しているディスク) を拡張することは想定されておりません。</p><p>例えば、1TB × 3 本のディスクで記憶域プールを構成している場合、この既に構成している 1 TB を 2 TB にすることで拡張することは想定しておりません。<br><img src="/blog/vm/extend-storage-space-on-azure-windows-vm/19.png" alt=""></p><p>なお、Azure ディスク リソースは縮小いただくことがご実施いただけません。<br>公開情報:  <a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/linux/find-unattached-disks" target="_blank" rel="noopener">Azure IaaS VM ディスクと Premium マネージド ディスクおよびアンマネージド ディスクについてよく寄せられる質問</a></p></div><h3 id="□-方法-1-記憶域プールに新規のディスクを追加し、仮想ディスクおよびボリュームを拡張する"><a href="#□-方法-1-記憶域プールに新規のディスクを追加し、仮想ディスクおよびボリュームを拡張する" class="headerlink" title="□ 方法 1 : 記憶域プールに新規のディスクを追加し、仮想ディスクおよびボリュームを拡張する"></a>□ 方法 1 : 記憶域プールに新規のディスクを追加し、仮想ディスクおよびボリュームを拡張する</h3><p>方法 1 では、すでに構成されている記憶域プールにディスクを追加し、仮想ディスクおよびボリュームを拡張する方法をご紹介します。</p><div style="background-color:#e2daf1 !important; padding: 1px 14px !important; border-radius: 10px !important;"><p><strong>注意</strong><br>Windows Server 2012、2012R2 においては、記憶域プールにディスクを追加する場合、「<span style="color:red;">列の数 (NumberOfColumns) × データのコピーの数 (NumberOfDataCopies)</span>」の台数分のディスクを増設する必要があります。</p><p>記憶域プールには、仮想ディスクの 1 データ (ストライプ: ディスクに書き込む 1 トランザクションの単位) が、仮想ディスクを構成する物理ディスクのうち、何本の物理ディスクに分散して書き込まれるかを決定する、Numberofcolumns という値があります。<br>仮想ディスクを構成する物理ディスクを追加し、仮想ディスクを拡張する場合、データのコピーの数 (NumberOfDataCopies) を維持するため、NumberOfColumns の数の単位の利用可能なディスクが必要となります。</p><p>公開情報: <a href="https://blogs.technet.microsoft.com/askcorejp/2017/06/22/numberofcolumns-of-storagespace/" target="_blank" rel="noopener">公開情報記憶域スペースの NumberOfColumns と仮想ディスクの拡張について</a></p><p>例:<br>はじめに 3 本の物理ディスクの存在する記憶域プール内に作成した仮想ディスクは、NumberOfColumns が 3 で作成されているため、ディスクの拡張のためにも 3 本単位での利用可能な物理ディスクが必要になります。</p><p>以下の PowerShell コマンドレットを実施することで仮想ディスクの現在の NumberOfColumns の値を確認することができます。</p><blockquote><p>Get-VirtualDisk –FriendlyName “&lt;仮想ディスク名&gt;” | FL NumberOfColumns</p></blockquote><p>なお、Windows Server 2016 以降の記憶域スペースにおいては、記憶域プールに割り当てられた領域をリバランス (再配置) するためのコマンド Optimize-StoragePool が用意されています。</p><blockquote><p>Optimize-StoragePool -FriendlyName “&lt;記憶域プール名&gt;”</p></blockquote><p>公開情報: <a href="https://docs.microsoft.com/en-us/powershell/module/storage/optimize-storagepool?view=win10-ps" target="_blank" rel="noopener">Optimize-StoragePool</a></p></div><p><strong>1. 既存の VM に新規ディスクを追加します</strong><br>管理ディスクを護衛用の場合は下記の公開情報をご参照いただき、Azure Portal または Azure PowerShell より VM に新規ディスク リソースを追加します。</p><p>公開情報: <a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/attach-managed-disk-portal#add-a-data-disk" target="_blank" rel="noopener">Azure portal を使用して Windows VM にマネージド データ ディスクを接続する - データ ディスクの追加</a><br>公開情報: <a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/attach-disk-ps" target="_blank" rel="noopener">PowerShell を使用して Windows VM にデータ ディスクを接続する</a></p><p>非管理ディスクをご利用の場合は、下記をご参照ください。</p><p>Azure Portal の場合 :<br>Azure Portal より、[Virtual Machines] - [&lt;対象 VM 名&gt;] を選択し、開いた画面の左メニュー [ディスク] を選択します。開いた画面にて [+ データ ディスクの追加] をクリックします。<br>“アンマネージド ディスクの接続” 画面にて適宜値を設定し、[OK] をクリックします。値設定時に、”ソースの種類” は [新規 (空のディスク)] を選択します。</p><p>Azure PowerShell の場合 :<br>下記公開情報のコマンド例をご参照ください。<br>公開情報: <a href="https://docs.microsoft.com/en-us/powershell/module/az.compute/add-azvmdatadisk?view=azps-5.4.0#example-2--add-a-data-disk-to-an-existing-virtual-machine" target="_blank" rel="noopener">Add-AzVMDataDisk - Example 2: Add a data disk to an existing virtual machine</a></p><p><strong>2. VM に RDP 接続を行います。</strong></p><p><strong>3. 記憶域プールにディスクを追加します</strong><br>[サーバー マネージャー] より、[ファイル サービスと記憶域サービス] - [ボリューム] - [記憶域プール] を開き、[&lt;対象の記憶域プール&gt;] を選択します。<br>“物理ディスク” の [タスク] - [物理ディスクの追加] をクリックします。<br><img src="/blog/vm/extend-storage-space-on-azure-windows-vm/2.png" alt=""></p><p>追加するディスク (追加した新規ディスク) を選択し、[OK] をクリックします。<br><img src="/blog/vm/extend-storage-space-on-azure-windows-vm/3.png" alt=""></p><div style="background-color:#e2daf1 !important; padding: 1px 14px !important; border-radius: 10px !important;"><p><strong>注意</strong></p><ul><li>Windows Server 2012R2 以前では、仮想ディスク作成時の物理ディスク数単位で物理ディスクを追加します。</li><li>Windows Server 2016 以降では、ディスク追加後に Optimize-StoragePool コマンドを実行します。<blockquote><p>Optimize-StoragePool -FriendlyName “&lt;記憶域プール名&gt;”</p></blockquote></li></ul></div><p><strong>4. 仮想ディスクを拡張します</strong><br>記憶域プールにディスクを追加後、”仮想ディスク” の [対象仮想ディスク] を右クリックし、[仮想ディスクの拡張] を選択します。<br><img src="/blog/vm/extend-storage-space-on-azure-windows-vm/4.png" alt=""></p><p>拡張するサイズを指定し、[OK] をクリックします。以下の例では、拡張可能な最大サイズを選択し、拡張を実施しています。<br><img src="/blog/vm/extend-storage-space-on-azure-windows-vm/5.png" alt=""></p><p>仮想ディスクの拡張が完了すると、以下の通り容量が増えます。<br><img src="/blog/vm/extend-storage-space-on-azure-windows-vm/6.png" alt=""></p><p><strong>5. 仮想ディスク上のボリュームを拡張します</strong><br>公開情報: <a href="https://docs.microsoft.com/ja-jp/windows-server/storage/disk-management/extend-a-basic-volume" target="_blank" rel="noopener">ベーシック ボリュームを拡張する</a></p><p>[スタート] を右クリックし、[ディスクの管理] をクリックします。<br>開いた画面にて、仮想ディスク上の対象のボリュームを右クリックし、[ボリュームの拡張] をクリックします。<br>“ボリュームの拡張ウィザード” に沿って進み、拡張したいサイズを指定して [完了] をクリックします。<br><img src="/blog/vm/extend-storage-space-on-azure-windows-vm/8.png" alt=""></p><p>ボリュームの拡張が完了すると、以下の通り容量が増えます。<br><img src="/blog/vm/extend-storage-space-on-azure-windows-vm/9.png" alt=""></p><h3 id="□-方法-2-記憶域スペースを再作成する"><a href="#□-方法-2-記憶域スペースを再作成する" class="headerlink" title="□ 方法 2 : 記憶域スペースを再作成する"></a>□ 方法 2 : 記憶域スペースを再作成する</h3><p><strong>1. 仮想ディスクにあるデータを別領域に退避します</strong><br>拡張したいディスクにて構成している記憶域プール上の全仮想ディスクにあるデータを、仮想ディスク以外の領域 (退避用に新規ディスクを追加する、Azure Storage を利用するなど) にデータを退避 (コピーまたは移動) します。</p><p><strong>2. 仮想ディスクを削除します</strong><br>[サーバー マネージャー] より、[ファイル サービスと記憶域サービス] - [ボリューム] - [記憶域プール] を開きます。<br>[&lt;対象の記憶域プール&gt;] を選択し、”仮想ディスク” の [対象仮想ディスク] を右クリックし、[仮想ディスクのデタッチ] を選択します。<br><img src="/blog/vm/extend-storage-space-on-azure-windows-vm/10.png" alt=""></p><p>デタッチが完了すると、仮想ディスク名の横に “!” が表示されます。<br><img src="/blog/vm/extend-storage-space-on-azure-windows-vm/11.png" alt=""></p><p>再度 [対象仮想ディスク] を右クリックし、[仮想ディスクの削除] を選択します。<br><img src="/blog/vm/extend-storage-space-on-azure-windows-vm/12.png" alt=""></p><p><strong>3. 記憶域プールを削除します</strong><br>[対象記憶域プール] を右クリックし、[記憶域プールの削除] を選択します。<br><img src="/blog/vm/extend-storage-space-on-azure-windows-vm/13.png" alt=""></p><p><strong>4. 対象ディスクを拡張します</strong><br>Azure Portal または Azure PowerShell より、対象のディスク リソースを拡張します。</p><p>Azure Portal の場合 :<br>ディスクのサイズ変更を行う際には、VM が停止済み (割り当て解除) の状態である必要があります。</p><ol><li>Azure Portal にアクセスし、[&lt;当該 VM 名&gt;] - [ディスク] をクリックします。</li><li>“OS ディスク” または “データ ディスク” よりサイズを変更したいディスク名をクリックします。</li><li>管理ディスクの場合は [構成] をクリックし、”サイズ” に任意の値を入力します。<br>非管理ディスクの場合は、”サイズ” に任意の値を入力します。</li><li>保存をクリックします。</li></ol><p>Azure PowerShell の場合 :<br>公開情報: <a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/expend-os-disk#resizing-data-disks" target="_blank" rel="noopener">データ ディスクのサイズを変更する</a> </p><p><strong>5. VM を起動し、RDP 接続を行います</strong></p><p><strong>6. 記憶域プールを作成します</strong><br>公開情報をご参照の上、記憶域プールを作成します。<br>公開情報: <a href="https://docs.microsoft.com/ja-jp/windows-server/storage/storage-spaces/deploy-standalone-storage-spaces#step-1-create-a-storage-pool" target="_blank" rel="noopener">スタンドアロン サーバーに記憶域スペースを展開する - 手順 1: 記憶域プールを作成する</a></p><p><strong>7. 仮想ディスクを作成します</strong><br>公開情報をご参照の上、仮想ディスクを作成します。<br>公開情報: <a href="https://docs.microsoft.com/ja-jp/windows-server/storage/storage-spaces/deploy-standalone-storage-spaces#step-2-create-a-virtual-disk" target="_blank" rel="noopener">スタンドアロン サーバーに記憶域スペースを展開する - 手順 2: 仮想ディスクを作成する</a></p><p><strong>8. ボリュームを作成します</strong><br>公開情報をご参照の上、ボリュームを作成します。<br>公開情報: <a href="https://docs.microsoft.com/ja-jp/windows-server/storage/storage-spaces/deploy-standalone-storage-spaces#step-3-create-a-volume" target="_blank" rel="noopener">スタンドアロン サーバーに記憶域スペースを展開する - 手順 3: ボリュームを作成する</a></p><h2 id="■-余談-SQL-VM-に関して"><a href="#■-余談-SQL-VM-に関して" class="headerlink" title="■ (余談) SQL VM に関して"></a>■ (余談) SQL VM に関して</h2><p>SQL ギャラリー イメージ にて VM を作成いただき構成された記憶域プールについては、Azure ポータルにて一部のストレージ設定を変更することが可能です。詳細は下記の公開情報をご参照ください。</p><p>公開情報: <a href="https://docs.microsoft.com/ja-jp/azure/azure-sql/virtual-machines/windows/storage-configuration" target="_blank" rel="noopener">SQL Server VM のストレージの構成</a></p><br>本稿は以上となりますが、いかがでしたでしょうか。本稿が皆様のお役に立てれば幸いです。<hr>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;こんにちは。Azure テクニカル サポート チームの重田です。&lt;/p&gt;
&lt;p&gt;Azure Windows VM において記憶域スペースをご構成いただいているお客様や、SQL VM (SQL Server on Windows Server) をご利用いただいているお客様より、ディスクの拡張方法に関してお問い合わせをいただくことが多いので、手順についてご紹介します。&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
      <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
      <category term="Storage Space" scheme="https://jpaztech.github.io/blog/tags/Storage-Space/"/>
    
  </entry>
  
  <entry>
    <title>403 エラーが発生し Azure ストレージ アカウント内のコンテンツにアクセスできない</title>
    <link href="https://jpaztech.github.io/blog/storage/storageFirewall-403Error/"/>
    <id>https://jpaztech.github.io/blog/storage/storageFirewall-403Error/</id>
    <published>2021-01-29T08:30:00.000Z</published>
    <updated>2021-04-27T07:25:57.369Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの木下です。</p><p>今回は Azure ストレージ アカウント内コンテンツへのアクセス時に 403 エラーが発生した<br>場合の対処法をストレージファイアウォール観点でエラー事例とともにご紹介いたします。</p><a id="more"></a><p>まずは 403 エラー発生時の事例を 5 つご紹介いたします。</p><p><strong>事例1)</strong><br>Azure ストレージ アカウント &gt; ファイル共有 画面でのアクセスエラー<br><img src="/blog/storage/storageFirewall-403Error/Storage01.png" alt=""></p><p><strong>事例2)</strong><br>Azure ストレージ アカウント &gt; Storage Explorer (プレビュー) 画面でのアクセスエラー<br><img src="/blog/storage/storageFirewall-403Error/Storage02.png" alt=""></p><p><strong>事例3)</strong><br>Azure Storage Explorer ツール画面でのアクセスエラー<br><img src="/blog/storage/storageFirewall-403Error/Storage03.png" alt=""></p><p><strong>事例4)</strong><br>AzCopy コマンドにてオンプレミス / Azure VM から Azure Storage Blob コンテナーへのファイルコピー時のエラー<br><img src="/blog/storage/storageFirewall-403Error/Storage04.png" alt=""></p><p><strong>事例5)</strong><br>オンプレミス / Azure VM からファイル共有をマウントした時のアクセスエラー<br><img src="/blog/storage/storageFirewall-403Error/Storage05.png" alt=""></p><p>事例1-5 のエラーの場合、ストレージファイアウォールが有効化されており設定に不備不足が<br>ある可能性が考えられます。原因がストレージファイアウォールであるか切り分けるため、<br>ストレージファイアウォールを一度無効にしエラーが解消されるかを確認します。</p><font color="LightSalmon"><h2 id="■ストレージファイアウォール無効化の手順"><a href="#■ストレージファイアウォール無効化の手順" class="headerlink" title="■ストレージファイアウォール無効化の手順"></a>■ストレージファイアウォール無効化の手順</h2></font><ol><li>対象のストレージアカウント「ネットワーク」をクリックします。</li><li>「ファイアウォールと仮想ネットワーク」より「すべてのネットワーク」を選択し「保存」します。</li></ol><p><img src="/blog/storage/storageFirewall-403Error/Storage06.png" alt=""></p><p>「すべてのネットワーク」が選択されている場合、ストレージファイアウォールの設定は<b>無効</b>状態となります。</p><blockquote><p>参考 )<br>□Azure Storage ファイアウォールおよび仮想ネットワークを構成する<br><a href="https://docs.microsoft.com/ja-jp/azure/storage/common/storage-network-security#azure-portal" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/storage/common/storage-network-security#azure-portal</a></p></blockquote><p>「すべてのネットワーク」が選択されている状態に変更が完了したら、事例1-5 の状態が解消されるか確認してください。<br>事例1-5 の状態が解消されていれば、ストレージファイアウォールの設定に問題があると判断できます。</p><p>もし、このままストレージファイアウォールを無効としても運用上差し支えなければ無効の状態でご利用ください。<br>アクセス元を制限したい場合は、以下に沿ってファイアウォール有効化の設定をご確認ください。</p><font color="LightSalmon"><h2 id="■ストレージファイアウォール有効化の手順"><a href="#■ストレージファイアウォール有効化の手順" class="headerlink" title="■ストレージファイアウォール有効化の手順"></a>■ストレージファイアウォール有効化の手順</h2></font><h3 id="1-インターネットまたはオンプレミスのネットワークからのアクセスを許可する"><a href="#1-インターネットまたはオンプレミスのネットワークからのアクセスを許可する" class="headerlink" title="(1) インターネットまたはオンプレミスのネットワークからのアクセスを許可する"></a>(1) インターネットまたはオンプレミスのネットワークからのアクセスを許可する</h3><p>事例1-3 と 事例4-5 (※オンプレミス からの実施の場合のみ) はいずれもインターネットまたはオンプレミスからの<br>アクセスになりますが、ストレージファイアウォール側でアクセス元のパブリック IP アドレスが許可されていないことにより<br>エラーが出ている状態になります。そのため、アクセス元のクライアント端末のグローバル IP アドレスを追加してください。</p><ol><li>対象のストレージアカウント「ネットワーク」をクリックします。</li><li>「ファイアウォールと仮想ネットワーク」のクライアント端末の IP アドレスを追加し「保存」します。</li></ol><p><img src="/blog/storage/storageFirewall-403Error/Storage10.png" alt=""></p><blockquote><p>注意)<br>Express Route をご利用されており、Microsoft Peering または Public Peering を用いて Azure ストレージに接続する構成の場合、<br>Azure ストレージに側の接続元の IP アドレスはオンプレミスのプライベート IP アドレスではなく、Microsoft Peering または<br>Public Peering で構成したパブリック IP アドレスとなります。そのため、Express Route 経由後のパブリック IP アドレスを追加<br>していただく必要があることをあらかじめご留意ください。</p></blockquote><p>アクセス許可を行いたいアクセス元の IP アドレスが分からない状態の場合、Azure ストレージの<br>診断ログを取得し、403 エラーを検知しているログより IP アドレスを特定します。</p><h4 id="・Azure-ストレージの診断ログの設定およびアクセス元-IP-アドレスの特定"><a href="#・Azure-ストレージの診断ログの設定およびアクセス元-IP-アドレスの特定" class="headerlink" title="・Azure ストレージの診断ログの設定およびアクセス元 IP アドレスの特定"></a>・Azure ストレージの診断ログの設定およびアクセス元 IP アドレスの特定</h4><ol><li>Azure ポータル ( <a href="https://portal.azure.com/" target="_blank" rel="noopener">https://portal.azure.com/</a> ) にログインし、ストレージアカウントを選択します。</li><li>「監視 (クラシック)」内 「診断設定 (クラシック)」を選択します。</li><li>「BLOBのプロパティ」を選択します。</li><li>状態を「オン」にし、「ログ記録」にて、「読み取り」「書き込み」「削除」のすべてにチェックを入れ「保存」します。<br><img src="/blog/storage/storageFirewall-403Error/Storage16.png" alt=""></li></ol><p><img src="/blog/storage/storageFirewall-403Error/Storage17.png" alt=""></p><blockquote><p>注意 )<br>上記設定を有効化いただくと、BLOB サービスに対するリクエストごとの診断ログが<br>ストレージ内に保持され、その BLOB ファイルに応じた料金が発生いたします。</p><p>また Azure Files は診断ログの記録は現在サポートされておりませんのでご了承ください。<br>□ログの構成<br><a href="https://docs.microsoft.com/ja-jp/azure/storage/common/storage-monitor-storage-account#configure-logging" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/storage/common/storage-monitor-storage-account#configure-logging</a></p></blockquote><p>対象ストレージアカウントのコンテナー内に $logs が作成されるため、取得されたログよりアクセスに失敗した時刻を<br>対象に 403 エラーが記録されているログを探し、該当のログ内にある IP アドレスを特定します。<br>※診断ログに表記される時刻は UTC となりますのでご留意ください。</p><p>下記ログは、192.100.0.102 からのアクセスが失敗した例となります。<br>ストレージファイアウォールにて 192.100.0.102 を許可しアクセスが可能となるかご確認ください。<br>例)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.0;202Y-MM-DDTHH:MM:SS.ZZZZZZZ;PutBlob;OAuthIpAuthorizationError;403;XX;XX;bearer;XXXXXXXXX;XXXXXXXXX;blob;</span><br><span class="line">"https://XXXXXXXXX.blob.core.windows.net:443/XXXXXXXXX/XXXXXXXXX.txt?timeout=901";"/";XXXXXXXXXXXXXXXXXX;0;</span><br><span class="line">192.100.0.102:4362;202Y-MM-DD;XXXX;0;XXX;XXX;XX;;;;;;"AzCopy/10.6.0 Azure-Storage/0.10 (go1.13; Windows_NT)";;"XXXXXXXXXXXXXXXXXX"</span><br><span class="line"></span><br><span class="line">※ SASIpAuthorizationError : ID 認証を使用してアクセスした際のステータスメッセージ</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.0;202Y-MM-DDTHH:MM:SS.ZZZZZZZ;PutBlob;SASIpAuthorizationError;403;X;X;sas;;XXXXXXXXX;blob;</span><br><span class="line">"https://XXXXXXXXX.blob.core.windows.net:443/XXXXXXXXX/XXXXXXXXX.txt?XXXXXXXXX;timeout=901";"/";XXXXXXXXX;0;</span><br><span class="line">192.100.0.102:4362;202Y-MM-DD;XXXX;0;XXX;XXX;XX;;;;;;"AzCopy/10.6.0 Azure-Storage/0.10 (go1.13; Windows_NT)";;"XXXXXXXXXXXXXXXXXX"</span><br><span class="line"></span><br><span class="line">※ OAuthIpAuthorizationError : SAS を使用してアクセスした際のステータスメッセージ</span><br></pre></td></tr></table></figure><blockquote><p>参考 )<br>□ストレージ アカウントの監視の設定<br><a href="https://docs.microsoft.com/ja-jp/azure/storage/common/storage-monitor-storage-account#configure-monitoring-for-a-storage-account" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/storage/common/storage-monitor-storage-account#configure-monitoring-for-a-storage-account</a><br>□バージョン 1.0 のサンプル ログ エントリ<br><a href="https://docs.microsoft.com/ja-jp/rest/api/storageservices/storage-analytics-log-format#sample-log-entries-for-version-10" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/rest/api/storageservices/storage-analytics-log-format#sample-log-entries-for-version-10</a><br>□ログに記録される要求ステータス メッセージ<br><a href="https://docs.microsoft.com/ja-jp/rest/api/storageservices/storage-analytics-logged-operations-and-status-messages#logged-request-status-messages" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/rest/api/storageservices/storage-analytics-logged-operations-and-status-messages#logged-request-status-messages</a></p></blockquote><h3 id="2-特定の仮想ネットワークおよびサブネットからのアクセスを許可する"><a href="#2-特定の仮想ネットワークおよびサブネットからのアクセスを許可する" class="headerlink" title="(2) 特定の仮想ネットワークおよびサブネットからのアクセスを許可する"></a>(2) 特定の仮想ネットワークおよびサブネットからのアクセスを許可する</h3><p>事例4-5 (※ Azure VM からの実施の場合のみ) はいずれもストレージファイアウォール側で Azure VM が<br>所属している仮想ネットワークからのアクセスが許可されていないことによりにエラーが発生している状態です。<br>そのため、対象の Azure VM が所属している仮想ネットワークおよびサブネットを追加する必要があります。</p><ol><li>対象のストレージアカウント「ネットワーク」をクリックします。</li><li>「ファイアウォールと仮想ネットワーク」の「仮想ネットワーク」に許可する仮想ネットワークおよびサブネットを追加します。</li></ol><p><img src="/blog/storage/storageFirewall-403Error/Storage07.png" alt=""></p><p>　#すでに利用したい仮想ネットワークがある場合は「既存の仮想ネットワークを追加する」から追加します。<br>　 仮想ネットワークが未作成の場合は「新しい仮想ネットワークを追加する」より作成追加してください。</p><p>　#異なるサブスクリプションの仮想ネットワークを追加する場合は、「サブスクリプション」項目のプルダウンより<br>　 対象のサブスクリプション内の仮想ネットワークおよびサブネットを選択し有効化します。<br>　 (有効化が完了するまで最大 15 分かかる場合があります) 有効化が完了したら「追加」をクリックします。<br><img src="/blog/storage/storageFirewall-403Error/Storage18.png" alt=""><br>　<br>3. 追加した仮想ネットワークおよびサブネットが表示されエンドポイントの状態が有効となっていることを確認し「保存」します。</p><p><img src="/blog/storage/storageFirewall-403Error/Storage08.png" alt=""></p><p>仮想ネットワークおよびサブネットの追加が完了しましたら、許可したアクセス元よりアクセスし、<br>事例4-5  (※ Azure VM からの実施の場合のみ) の状態が解消されるかご確認ください。<br>解消されない場合は追加した仮想ネットワークやサブネットの範囲が正しいかご確認をお願いします。</p><blockquote><p>注意)<br>ストレージファイアウォール設定で「すべてのネットワーク」と「選択されたネットワーク」の切り替えを行う場合や<br>登録しているサブネットが仮想ネットワーク上で一度削除され、新たに同名でサブネットが作成された場合などにより<br>古い情報が残存した状態となりエンドポイントの状態が「見つかりません」というようなエラーが表示されることがあります。</p><p>その場合は、一度ストレージファイアウォール「仮想ネットワーク」項目からエラーが表示されているサブネットを削除し、<br>上述の手順で仮想ネットワークおよびサブネットの追加をお試しいただきますようお願いいたします。</p></blockquote><p><img src="/blog/storage/storageFirewall-403Error/Storage09.png" alt=""></p><p>ストレージファイアウォール設定を有効化し、許可したいアクセス元の追加が完了しますと、<br>各々エラーが解消し Azure ストレージ内コンテンツへのアクセスが可能となります。</p><p><strong>事例1)</strong><br><img src="/blog/storage/storageFirewall-403Error/Storage11.png" alt=""><br><strong>事例2)</strong><br><img src="/blog/storage/storageFirewall-403Error/Storage12.png" alt=""><br><strong>事例3)</strong><br><img src="/blog/storage/storageFirewall-403Error/Storage13.png" alt=""><br><strong>事例4)</strong><br><img src="/blog/storage/storageFirewall-403Error/Storage14.png" alt=""><br><strong>事例5)</strong><br><img src="/blog/storage/storageFirewall-403Error/Storage15.png" alt=""></p><p>本手順でエラーが解消しない場合、ストレージファイアウォール以外の設定に問題がある可能性もございます。<br>ストレージ内コンテンツへのアクセス権限は不足していないか等含めご確認くださいませ。</p><p>本稿が皆様のお役に立ちましたら幸いでございます。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;こんにちは、Azure テクニカル サポート チームの木下です。&lt;/p&gt;
&lt;p&gt;今回は Azure ストレージ アカウント内コンテンツへのアクセス時に 403 エラーが発生した&lt;br&gt;場合の対処法をストレージファイアウォール観点でエラー事例とともにご紹介いたします。&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="Storage" scheme="https://jpaztech.github.io/blog/tags/Storage/"/>
    
  </entry>
  
  <entry>
    <title>VPN Gateway よくあるお問合せ - FAQ</title>
    <link href="https://jpaztech.github.io/blog/network/vpngw-FAQ1/"/>
    <id>https://jpaztech.github.io/blog/network/vpngw-FAQ1/</id>
    <published>2020-12-23T15:00:00.000Z</published>
    <updated>2021-04-27T07:25:57.349Z</updated>
    
    <content type="html"><![CDATA[<p>Azure VPN Gateway に関して、たびたびお問合せ頂く内容をご紹介させていただきます。  </p><h3 id="メンテナンスの事前通知"><a href="#メンテナンスの事前通知" class="headerlink" title="メンテナンスの事前通知"></a>メンテナンスの事前通知</h3><p>VPN Gateway ではサービスを健全に運用するため定期的(月に 1, 2 回程度 )のメンテナンスを実施いたします。<br>メンテナンスでは数十秒程度の通信断が発生することがございますが、メンテナンスの <strong>事前通知は行っておりません</strong>  </p><h3 id="事後にメンテナンス有無を確認する方法"><a href="#事後にメンテナンス有無を確認する方法" class="headerlink" title="事後にメンテナンス有無を確認する方法"></a>事後にメンテナンス有無を確認する方法</h3><p>メンテナンス実施時に診断ログにメンテナンス実行を示すイベントが記録されます。<br>ログを確認することで、過去に発生した IPsec セッションの断がメンテナンスによるものかを確認することが可能です。<br>複数種類のメンテナンスがあり、全メンテナンスでログが出力されるわけではございません。<br>ログ上、メンテナンスとして記録されていない、意図せぬ申告なサービス断が発生した場合には Azure サポートにて調査をいたしますので、ケースオープンをしてお問い合わせ下さい。  </p><h3 id="ゲートウェイ共存環境における、ユーザ定義ルートの使用時の注意事項"><a href="#ゲートウェイ共存環境における、ユーザ定義ルートの使用時の注意事項" class="headerlink" title="ゲートウェイ共存環境における、ユーザ定義ルートの使用時の注意事項"></a>ゲートウェイ共存環境における、ユーザ定義ルートの使用時の注意事項</h3><p>VPN Gateway と ExpressRoute Gateway は同一仮想ネットワーク( 同一ゲートウェイ サブネット ) 配置できますが、<strong>この環境ではユーザ定義ルートにてネクストホップ “仮想ネットワークゲートウェイ” とする経路は使用できません。</strong>  </p><p>上記制限に該当するよくあるシナリオといたしましては次のようなものがあります。<br>VPN Gateway を使用した site-to-site VPN ＋ 強制トンネリングの環境では、 ユーザ定義ルート 0.0.0.0/0 ネクストホップ 仮想ネットワークゲートウェイ の経路を設定いたします。<br>しかし、この環境に ExpressRoute Gateway  を追加作成した場合、上記の制限に該当するため、強制トンネリングが無効となりますのでご注意ください。</p><h1 id="Site-to-Site-に関する-FAQ"><a href="#Site-to-Site-に関する-FAQ" class="headerlink" title="Site-to-Site に関する FAQ"></a>Site-to-Site に関する FAQ</h1><h3 id="VPN-Gateway-で静的パブリック-IP-アドレスを使う方法"><a href="#VPN-Gateway-で静的パブリック-IP-アドレスを使う方法" class="headerlink" title="VPN Gateway で静的パブリック IP アドレスを使う方法"></a>VPN Gateway で静的パブリック IP アドレスを使う方法</h3><p>かねてより VPN Gateway に静的パブリック IP アドレスを割り当てたいというご要望を頂いておりましたが対応しておりませんでした。<br>2020年9月現在でも、VpnGwX 等の通常の VPN Gateway SKU では静的 IP アドレスを使用することはできませんが、<strong>ゾーン冗長 SKU VpnGwXAZ</strong> を選択いただくことで実現が可能です。  </p><p>非ゾーン冗長 SKU （VpnGwX ）から ゾーン冗長 VpnGwX SKU への変更には、VPN Gateway の再作成が必要となるため、VPN Gateway のアドレス変更が発生いたします。  </p><h3 id="VPN-Gateway-をトランジットした通信"><a href="#VPN-Gateway-をトランジットした通信" class="headerlink" title="VPN Gateway をトランジットした通信"></a>VPN Gateway をトランジットした通信</h3><p>VPN Gateway では Site-to-Site VPN 経由で接続された複数のサイト間の通信を行うことが可能です。<br>この場合、 サイト と Azure 間の接続には必ず <strong>BGP</strong> が必要になります。<br>スタティック構成( BGP を使用しない構成 )での VPN Gateway トランジット構成はサポートされませんのでご注意下さい。  </p><p><img src="/blog/network/vpngw-FAQ1/vpngw-transit.png" alt=""></p><h3 id="VPN-Gateway-ExpressRoute-共存環境のデザイン"><a href="#VPN-Gateway-ExpressRoute-共存環境のデザイン" class="headerlink" title="VPN Gateway, ExpressRoute 共存環境のデザイン"></a>VPN Gateway, ExpressRoute 共存環境のデザイン</h3><p>同一 VNET 内に ExpressRoute と VPN Gateway を配置することが可能です。<br>しかし、VPN Gateway Site-to-Site 接続で接続された拠点 A と ExpressRoute 接続された拠点 B 間は、Azure 経由で通信を行うことはできません (<strong>共存環境では GW 間のトランジット通信はできません</strong>)  </p><p><img src="/blog/network/vpngw-FAQ1/vpngw-er-coexist.png" alt=""></p><h3 id="BGP-によるトラフィック制御方法"><a href="#BGP-によるトラフィック制御方法" class="headerlink" title="BGP によるトラフィック制御方法"></a>BGP によるトラフィック制御方法</h3><p>VPN Gateway では IPsec 上で BGP を使用してオンプレミスサイトと経路交換をすることができます。<br>構成によっては複数の BGP Peer から同一のプレフィックスを受信することがございますが、その場合にはロードバランス( BGP multipath )の動作をいたします。<br>特定の経路を優先させたい場合には、 AS-PATH プリペンド( AS-PATH 長が最も短い経路が優先 )をご使用頂けます。  </p><h3 id="VPN-Gateway-Active-Standby-から-Active-Active-に変更した場合のコストについて"><a href="#VPN-Gateway-Active-Standby-から-Active-Active-に変更した場合のコストについて" class="headerlink" title="VPN Gateway Active / Standby から Active / Active に変更した場合のコストについて"></a>VPN Gateway Active / Standby から Active / Active に変更した場合のコストについて</h3><p>VPN Gateway Site-to-Site 接続 では以下のコストが発生いたします。  </p><ol><li>VPN Gateway SKU   </li><li>Site-to-Site トンネル数( 11本以上のトンネルを作成する場合 )  </li><li>送信トラフィック  </li></ol><p>ご参考. VPN Gateway 価格表<br><a href="https://azure.microsoft.com/ja-jp/pricing/details/vpn-gateway/" target="_blank" rel="noopener">https://azure.microsoft.com/ja-jp/pricing/details/vpn-gateway/</a>  </p><p>VPN Gateway Active / Active 構成では、 Active / Standby 構成と比較して、オンプレミスサイトとのトンネル数が2倍になります。<br>接続オンプレミスサイトが多く、 Site-to-Site トンネル数が 10 を超える場合にはトンネル数に応じた課金(Site-to-Site トンネル数)が発生いたしますので、ご注意ください。  </p><p>合計トンネル数が 10 以下の環境では、 Active / Active と Active / Standby 構成で料金の差はございません。  </p><h3 id="IKE-バージョン、トンネルモードの推奨設定について"><a href="#IKE-バージョン、トンネルモードの推奨設定について" class="headerlink" title="IKE バージョン、トンネルモードの推奨設定について"></a>IKE バージョン、トンネルモードの推奨設定について</h3><p>VPN Gateway サービスでは、ゲートウェイ機器ベンダーと接続検証を実施しており、検証済ゲートウェイデバイスについては、以下サイトにてサンプルコンフィグをご提供しております。  </p><p>ご参考. 検証済みの VPN デバイスとデバイス構成ガイド<br><a href="https://docs.microsoft.com/ja-jp/azure/vpn-gateway/vpn-gateway-about-vpn-devices#validated-vpn-devices-and-device-configuration-guides" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/vpn-gateway/vpn-gateway-about-vpn-devices#validated-vpn-devices-and-device-configuration-guides</a>  </p><p>検証済デバイスであっても、サンプルコンフィグに無い設定の組み合わせ( IKE バージョン, モード( ポリシーベース、ルートベース ) )では、接続性に問題が発生することがございます。<br>オンプレミス ゲートウェイを設定の際には、<strong>必ずサンプルコンフィグで使用している設定の組み合わせをご使用下さい</strong>。  </p><p>未検証デバイス、未検証設定を用いて発生した不具合については、 Azure サポート窓口では解決のご支援ができないため、各 ゲートウェイ機器ベンダーにお問合せ下さい。<br>Azure VPN Gateway では IKEv2 ルートベース設定が最も実績の多い組み合わせとなります。<br>やむを得ず未検証デバイスを使用する場合には、IKEv2 ルートベースを第一候補として設定をお試いただくことを推奨いたします。  </p><h1 id="Point-to-Site-に関する-FAQ"><a href="#Point-to-Site-に関する-FAQ" class="headerlink" title="Point-to-Site に関する FAQ"></a>Point-to-Site に関する FAQ</h1><h3 id="Azure-VPN-Client-のインストール方法"><a href="#Azure-VPN-Client-のインストール方法" class="headerlink" title="Azure VPN Client のインストール方法"></a>Azure VPN Client のインストール方法</h3><p>Azure VPN Client をローカルファイルにダウンロードし、 PC にインストールしたいというご相談をいただきますが、 Azure VPN Client は ユニバーサル Windows プラットフォームアプリケーションとして開発しているため、必ず <strong>Microsoft Store からのインストールが必要</strong> です。  </p><h3 id="VPN-クライアントを使用する際の管理者権限"><a href="#VPN-クライアントを使用する際の管理者権限" class="headerlink" title="VPN クライアントを使用する際の管理者権限"></a>VPN クライアントを使用する際の管理者権限</h3><p>Windows クライアントの Point-To-Site 接続では、3種類の VPN クライアント アプリケーションをサポートしております。各クライアントの使用にあたり以下のタイミングで管理者権限( Administrator )が必要となります。  </p><p>admin 権限が必要な処理</p><table><thead><tr><th>クライアントの種類</th><th>クライアント app インストール時</th><th>VPN 接続時</th></tr></thead><tbody><tr><td>Windows 標準の VPN クライアント (SSTP, IKE)</td><td>標準インストール</td><td>必要</td></tr><tr><td>OpenVPN クライアント( OpenVPN )</td><td>必要</td><td><strong>不要</strong></td></tr><tr><td>Azure VPN クライアント( OpenVPN )</td><td><strong>不要</strong></td><td><strong>不要</strong></td></tr></tbody></table><p>VPN 接続する際に使用するユーザアカウントに管理者権限が付与できない場合、 OpenVPN クライアント、もしくは Azure VPN クライアントを使用することで問題を回避できることがあります。  </p><h3 id="P2S-クライアントにおけるフルトンネル設定の可否"><a href="#P2S-クライアントにおけるフルトンネル設定の可否" class="headerlink" title="P2S クライアントにおけるフルトンネル設定の可否"></a>P2S クライアントにおけるフルトンネル設定の可否</h3><p>一般的に VPN クライアントが、全トラフィックを VPN 経由で行う設定をフルトンネル、一部トラフィックのみ VPN 経由で行う設定をスプリットトンネルと呼ばれておりますが、 Azure VPN Gateway 接続では <strong>スプリットトンネルのみサポート</strong> します。<br>もしフルトンネルで Azure VNET と接続する必要がある場合には、サードパーティ製の NVA をご使用下さい。  </p><h3 id="P2S-経由でのインターネット、-Azure-PaaS-サービスへのアクセス"><a href="#P2S-経由でのインターネット、-Azure-PaaS-サービスへのアクセス" class="headerlink" title="P2S 経由でのインターネット、 Azure PaaS サービスへのアクセス"></a>P2S 経由でのインターネット、 Azure PaaS サービスへのアクセス</h3><p>P2S クライアントは Azure VPN Gateway を経由させて、インターネット, PaaS サービスにダイレクトにアクセスすることはできません。  </p><p>もし、P2S クライアントから Azure VPN Gateway 経由でインターネットアクセスする場合には、 Azure 上に Proxy サーバを構築し、 Proxy を経由させることでインターネットにアクセスさせる必要がございます。  </p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Azure VPN Gateway に関して、たびたびお問合せ頂く内容をご紹介させていただきます。  &lt;/p&gt;
&lt;h3 id=&quot;メンテナンスの事前通知&quot;&gt;&lt;a href=&quot;#メンテナンスの事前通知&quot; class=&quot;headerlink&quot; title=&quot;メンテナンスの事前通知
      
    
    </summary>
    
    
    
      <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
      <category term="FAQ" scheme="https://jpaztech.github.io/blog/tags/FAQ/"/>
    
      <category term="VPN Gateway" scheme="https://jpaztech.github.io/blog/tags/VPN-Gateway/"/>
    
  </entry>
  
  <entry>
    <title>AAD Pod Identity の使用例 - AKS の Pod にマネージド ID で Azure リソースへのアクセス権を割り当てる</title>
    <link href="https://jpaztech.github.io/blog/containers/aks-aad-pod-identity/"/>
    <id>https://jpaztech.github.io/blog/containers/aks-aad-pod-identity/</id>
    <published>2020-12-21T03:00:00.000Z</published>
    <updated>2021-04-27T07:25:57.313Z</updated>
    
    <content type="html"><![CDATA[<p>この記事は <a href="https://qiita.com/advent-calendar/2020/microsoft-azure-tech" target="_blank" rel="noopener">Microsoft Azure Tech Advent Calendar 2020</a> の 21 日目の記事になります。</p><p>こんにちは🎅 Azure テクニカル サポート チームの桐井です。</p><p>AKS 上のアプリケーション Pod から、 SQL Database や Key Vault、Blob Storage などの Azure サービスを利用する場合は、Pod に資格情報を渡し対象リソースへのアクセス権を付与する必要があります。</p><p>この記事では、AKS 上の Pod へ Azure AD Pod Identity を使ってマネージド ID を割り当てる方法を解説します。サンプル アプリケーションを動かしながら、マネージド ID の持つアクセス権で Azure Key Vault へアクセスする例をご紹介します。</p><a id="more"></a><hr><h2 id="マネージド-ID-を使った-Azure-リソースへのアクセス"><a href="#マネージド-ID-を使った-Azure-リソースへのアクセス" class="headerlink" title="マネージド ID を使った Azure リソースへのアクセス"></a>マネージド ID を使った Azure リソースへのアクセス</h2><p>Pod に資格情報を渡す方法として、Pod 用のサービス プリンシパルを作成し、発行されたアプリケーション ID / パスワードの文字列を設定ファイルや Kubernetes の Secret から読み込むという方法があげられます。</p><p>この方法では、資格情報の文字列を開発者が管理する必要があり、資格情報やそれを含む Kubernetes の YAML マニフェストを安全に管理するためのセキュリティ上の課題が生じます。また、資格情報のローテーションを行った場合、新しい ID / パスワード文字列への置き換えが必要になるといった運用上の課題も考えられます。</p><p>このような課題の解決策として、Azure 環境上では「<strong>マネージド ID</strong>」が利用可能です。</p><p>マネージド ID は Azure リソースでのみ使用できる特殊なタイプのサービス プリンシパルです。アプリケーションは、Azure Active Directory (AAD) よりリアルタイムに取得したトークンを使って Azure リソースへアクセスします。資格情報は Azure によって管理されるため、パスワード文字列を自分で管理する必要がなくなります。</p><blockquote><p>※ ご参考情報: マネージド ID の概要・動作の詳細は、下記ドキュメントをご参照ください。<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/managed-identities-azure-resources/overview" target="_blank" rel="noopener">Azure リソースのマネージド ID とは</a><br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/managed-identities-azure-resources/how-managed-identities-work-vm" target="_blank" rel="noopener">Azure リソースのマネージド ID と Azure 仮想マシンの連携</a></p></blockquote><h3 id="AAD-Pod-Identity"><a href="#AAD-Pod-Identity" class="headerlink" title="AAD Pod Identity"></a>AAD Pod Identity</h3><p>マネージド ID は <a href="https://docs.microsoft.com/ja-jp/azure/active-directory/managed-identities-azure-resources/services-support-managed-identities" target="_blank" rel="noopener">VM や App Service など</a> の Azure リソースに割り当て、アプリケーションが他の Azure サービスへアクセスするための資格情報として利用できます。同様にマネージド ID を AKS で稼働する Pod に対して割り当てることが可能です。</p><blockquote><p>※ ご参考情報: Azure Kubernetes Service (AKS) の認証と認可のベスト プラクティス - ポッド ID を使用する<br><a href="https://docs.microsoft.com/ja-jp/azure/aks/operator-best-practices-identity#use-pod-identities" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/aks/operator-best-practices-identity#use-pod-identities</a></p></blockquote><p>Kubernetes クラスターに <a href="https://github.com/Azure/aad-pod-identity" target="_blank" rel="noopener">AAD Pod Identity</a> をインストールすることで、Pod でマネージド ID が利用できるようになります。</p><p><img src="/blog/containers/aks-aad-pod-identity/aks-aad-pod-identity01.png" alt="アプリケーション Pod が SQL Server にアクセスする例 (上記ドキュメント ページより引用)"></p><p>Pod Identity では、あらかじめマネージド ID とアプリケーション Pod の関連付け (Azure Identity Binding) を定義しておきます。Pod が Azure サービスへのアクセスを要求すると、トラフィックがクラスター上の NMI Pod (Node Management Identity) に転送されます。NMI は Pod と関連付けられたマネージド ID のアクセス トークンを Azure Active Directory に要求し、発行されたアクセス トークンを Pod に返却します。Pod はこのトークンを使用して Azure リソースの操作を行います。</p><p>AKS で Pod Identity を使用するには現在 2 通りの方法があり、<a href="https://azure.github.io/aad-pod-identity/docs/demo/standard_walkthrough/" target="_blank" rel="noopener">手動でインストール</a>する方法のほか、プレビュー機能となりますが、先月 (2020/11) 発表されました AAD Pod Identity Add-on [^1] を使用する方法があります。</p><blockquote><p><a href="https://github.com/Azure/AKS/releases/tag/2020-11-30" target="_blank" rel="noopener">Azure/AKS Release 2020-11-30</a> - Preview Features<br><a href="https://docs.microsoft.com/en-us/azure/aks/use-azure-ad-pod-identity" target="_blank" rel="noopener">Azure AD Pod Identity Add-on</a> is now in public preview.</p></blockquote><p>本記事では、この AKS アドオンを使用した手順をご紹介します。</p><blockquote><p>※ ご参考情報: Pod Identity の詳細については、プロジェクトの公式ドキュメント、下記ブログ記事をあわせてご参照ください。<br>Azure Active Directory Pod Identity For Kubernetes - Documentation<br><a href="https://azure.github.io/aad-pod-identity/docs/" target="_blank" rel="noopener">https://azure.github.io/aad-pod-identity/docs/</a><br>Pod Identity<br><a href="https://medium.com/microsoftazure/pod-identity-5bc0ffb7ebe7" target="_blank" rel="noopener">https://medium.com/microsoftazure/pod-identity-5bc0ffb7ebe7</a></p></blockquote><p>[^1]: Pod Identity の既定では、クラスター上で NMI と MIC の 2 種類のコンポーネントが動作します。アドオンでインストールした Pod Identity では <a href="https://azure.github.io/aad-pod-identity/docs/configure/pod_identity_in_managed_mode/" target="_blank" rel="noopener">Managed Mode</a> で動作し、AKS クラスター上では NMI の Pod のみが動作します。</p><h2 id="サンプル-アプリケーションで-Pod-Identity-を試してみよう"><a href="#サンプル-アプリケーションで-Pod-Identity-を試してみよう" class="headerlink" title="サンプル アプリケーションで Pod Identity を試してみよう"></a>サンプル アプリケーションで Pod Identity を試してみよう</h2><p>本記事では <a href="https://docs.microsoft.com/ja-jp/azure/aks/tutorial-kubernetes-prepare-app" target="_blank" rel="noopener">AKS チュートリアルでおなじみの azure-vote アプリケーション</a>を例に解説をします。<br>azure-vote は front Pod (Web アプリ) と back Pod (Redis) の 2 段構成となっており、チュートリアルでは Web アプリと Redis の両方が AKS クラスター上にデプロイされています。</p><p>今回は Redis を AKS クラスターにはデプロイせず、代わりに <a href="https://docs.microsoft.com/ja-jp/azure/azure-cache-for-redis/cache-overview" target="_blank" rel="noopener">Azure Cache for Redis</a> を使用する構成をつくります。Redis へ接続するためのアクセス キーが必要となるため、安全に管理するために <a href="https://docs.microsoft.com/ja-jp/azure/key-vault/general/overview" target="_blank" rel="noopener">Azure Key Vault</a> を使用します。この Key Vault の参照権限を持つマネージド ID を作成しておき、Pod がデプロイされた際に Pod Identity でトークンを取得できるようにします。パスワード文字列の発行・YAML マニフェスト上での管理が必要ないという点がポイントです。</p><p>azure-vote アプリケーション自体は Key Vault へアクセスする機能を持たないため、実際のキーの取得は <a href="https://github.com/Azure/secrets-store-csi-driver-provider-azure" target="_blank" rel="noopener">Secrets Store CSI Driver</a> を使って実現します。CSI ドライバーは、Pod のラベルで指定されたマネージド ID の権限を使用して Key Vault にアクセスします。Key Vault オブジェクトを Kubernetes の Secret へ同期する機能を使い、環境変数で Redis のアクセス キーを azure-vote アプリケーションに渡します。</p><p><img src="/blog/containers/aks-aad-pod-identity/aks-aad-pod-identity02.png" alt=""></p><p>せっかくなので、今回は Key Vault と Redis への接続に <a href="https://docs.microsoft.com/ja-jp/azure/private-link/private-link-overview" target="_blank" rel="noopener">Azure Private Link</a> を利用してみました。トラフィックは AKS ノードと同じサブネットの Private Endpoint を介し、各サービスへプライベート ネットワーク経由で到達します。</p><h3 id="検証用のリソース-グループを作成"><a href="#検証用のリソース-グループを作成" class="headerlink" title="検証用のリソース グループを作成"></a>検証用のリソース グループを作成</h3><p>それでは作業を進めていきましょう (•̀ᴗ•́)و ̑̑<br>新しくリソース グループを作成し、この中に AKS / Key Vault / Redis Cache / Managed Identity をつくっていきます。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">resourceGroup="pod-identity"</span><br><span class="line">az group create --name $&#123;resourceGroup&#125; --location japaneast</span><br></pre></td></tr></table></figure><h3 id="Pod-Identity-アドオンが有効なクラスターの作成"><a href="#Pod-Identity-アドオンが有効なクラスターの作成" class="headerlink" title="Pod Identity アドオンが有効なクラスターの作成"></a>Pod Identity アドオンが有効なクラスターの作成</h3><p>Pod Identity アドオンが有効な AKS クラスターを作成します。</p><blockquote><p>ご参考情報: Azure Kubernetes Service で Azure Active Directory ポッドマネージド ID を使用する (プレビュー)<br><a href="https://docs.microsoft.com/en-us/azure/aks/use-azure-ad-pod-identity" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/azure/aks/use-azure-ad-pod-identity</a></p></blockquote><p>本記事の時点では、 Pod Identity アドオンはプレビュー機能として提供されています。プレビュー機能を利用するために、はじめに <code>EnablePodIdentityPreview</code> 機能の登録を行います。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">az feature register --name EnablePodIdentityPreview \</span><br><span class="line">  --namespace Microsoft.ContainerService</span><br></pre></td></tr></table></figure><p>登録が完了したら AKS クラスターの作成に進みます。<code>--enable-pod-identity</code> オプションを指定します。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">clusterName="pod-identity"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Pod Identity アドオンが有効なクラスターを作成</span></span></span><br><span class="line">az aks create \</span><br><span class="line">  --resource-group $&#123;resourceGroup&#125; \</span><br><span class="line">  --name $&#123;clusterName&#125; \</span><br><span class="line">  --network-plugin azure \</span><br><span class="line">  --enable-managed-identity \</span><br><span class="line">  --enable-pod-identity</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># クラスターの資格情報を取得</span></span></span><br><span class="line">az aks get-credentials -g $&#123;resourceGroup&#125; -n $&#123;clusterName&#125;</span><br></pre></td></tr></table></figure><blockquote><p>[補足] network-plugin に kubenet はサポートされていないため Azure CNI を使用します<br># BadRequestError: Operation failed with status: ‘Bad Request’. Details: Network plugin kubenet is not supported to use with PodIdentity addon.</p></blockquote><h3 id="Redis-Cache-の作成"><a href="#Redis-Cache-の作成" class="headerlink" title="Redis Cache の作成"></a>Redis Cache の作成</h3><p>Azure ポータルで Redis Cache を作成します。<br>AKS クラスターから Azure Private Link を使ってアクセスするために、[ネットワーク] タブで AKS ノードのサブネットにプライベート エンドポイントを作成しておきます。</p><p><img src="/blog/containers/aks-aad-pod-identity/aks-aad-pod-identity03.png" alt=""></p><p>azure-vote アプリケーションは Redis の接続に 6379/TCP を使用するるため、[非 TLS ポート] を有効にしておきます。Redis バージョンも azure-vote-back にあわせて 6 にしておきます。</p><p><img src="/blog/containers/aks-aad-pod-identity/aks-aad-pod-identity04.png" alt=""></p><p>Redis Cache の作成が完了したら、ホスト名と接続用のアクセス キーを確認しましょう。後で使用するためメモしておきます。</p><p><img src="/blog/containers/aks-aad-pod-identity/aks-aad-pod-identity05.png" alt=""></p><h3 id="Azure-Key-Vault-キー-コンテナー-シークレットの作成"><a href="#Azure-Key-Vault-キー-コンテナー-シークレットの作成" class="headerlink" title="Azure Key Vault キー コンテナー / シークレットの作成"></a>Azure Key Vault キー コンテナー / シークレットの作成</h3><p>次に Redis のアクセス キーを保管する Key Vault キー コンテナーを作成します。<br>Redis と同様に、[ネットワーク] タブで AKS ノードのサブネットにプライベート エンドポイントを作成します。</p><p><img src="/blog/containers/aks-aad-pod-identity/aks-aad-pod-identity06.png" alt=""></p><p>作成が完了したら、先ほどメモした Redis の接続キーをシークレット オブジェクトとして登録します。</p><p>Key Vault の作成直後は、アクセス可能なネットワークがプライベート エンドポイント経由のみとなっているため、そのままではポータルから新しくシークレットの作成ができません。設定の [ネットワーク] にて [プライベート エンドポイントと選択されたネットワーク] を選択し、[ファイアウォール] で自分のパブリック IP アドレスを一時的に許可します。</p><p>その後 [シークレット] から新しいシークレットの作成画面に進みます。[名前]を入力し、[値]には Redis のプライマリー キーを入力して保存します。</p><p><img src="/blog/containers/aks-aad-pod-identity/aks-aad-pod-identity07.png" alt=""></p><h3 id="Key-Vault-シークレット-ストア-CSI-ドライバーのインストール"><a href="#Key-Vault-シークレット-ストア-CSI-ドライバーのインストール" class="headerlink" title="Key Vault シークレット ストア CSI ドライバーのインストール"></a>Key Vault シークレット ストア CSI ドライバーのインストール</h3><p>AKS クラスターに Key Vault シークレット ストア CSI ドライバーをインストールします。Helm 3 を使い、下記のコマンドでインストールします。<br>そういえば今年は <a href="https://helm.sh/blog/helm-v2-deprecation-timeline/" target="_blank" rel="noopener">Helm 2 終了のお知らせ</a>がありましたね。まだ Helm 3 に移行していない方は早めに移行しましょうー！</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># helm リポジトリの登録</span></span></span><br><span class="line">helm repo add csi-secrets-store-provider-azure https://raw.githubusercontent.com/Azure/secrets-store-csi-driver-provider-azure/master/charts</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># CSI ドライバーのインストール</span></span></span><br><span class="line">helm install csi-secrets-store-provider-azure/csi-secrets-store-provider-azure --generate-name</span><br></pre></td></tr></table></figure><p>次に AKS クラスターに <code>SecretProviderClass</code> を作成し、先ほど用意した Key Vault の参照設定を行います。以下のように YAML ファイルを作成し、Key Vault キー コンテナー、 シークレット オブジェクトの情報を記述します。Key Vault のテナント ID は <code>az keyvault show --name ${vaultName}</code> で確認できます。</p><p><code>spec.parameters.objects</code> が読み込み対象の Key Vault オブジェクトになります。Redis アクセス キーの Secret オブジェクトを指定します。<br>また、<code>spec.secretObjects</code> の設定は、Key Vault を Kubernetes の Secret に同期するための設定になります。ここで設定した名前やキーで、Secret オブジェクトが自動的に作成されます。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">secrets-store.csi.x-k8s.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">SecretProviderClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">azure-vote-secret-provider-class</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">provider:</span> <span class="string">azure</span></span><br><span class="line">  <span class="attr">parameters:</span></span><br><span class="line">    <span class="attr">usePodIdentity:</span> <span class="string">"true"</span>      <span class="comment"># Pod Identity を使用</span></span><br><span class="line">    <span class="attr">userAssignedIdentityID:</span> <span class="string">""</span>  <span class="comment"># Pod Identity を使用する場合は空文字列にします</span></span><br><span class="line">    <span class="attr">keyvaultName:</span> <span class="string">"azure-vote"</span>  <span class="comment"># Key Vault 名</span></span><br><span class="line">    <span class="attr">objects:</span> <span class="string">|</span>    <span class="comment"># Key Vault Secret オブジェクトの指定</span></span><br><span class="line">      <span class="attr">array:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line">        <span class="attr">objectName:</span> <span class="string">azure-vote-redis-key</span></span><br><span class="line">        <span class="attr">objectType:</span> <span class="string">secret</span></span><br><span class="line">    <span class="attr">subscriptionId:</span> <span class="string">"$&#123;サブスクリプション ID&#125;"</span></span><br><span class="line">    <span class="attr">tenantId:</span> <span class="string">"$&#123;Key Vault のテナント ID&#125;"</span></span><br><span class="line">  <span class="attr">secretObjects:</span>    <span class="comment"># Kubernetes Secret への同期設定</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">secretName:</span> <span class="string">azure-vote-secret</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Secret</span></span><br><span class="line">    <span class="attr">data:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">objectName:</span> <span class="string">azure-vote-redis-key</span></span><br><span class="line">      <span class="attr">key:</span> <span class="string">redis-key</span></span><br></pre></td></tr></table></figure><p><code>kubectl apply</code> でクラスターにデプロイします。この時点では Key Vault からの読み込み・K8s Secret への同期はおこなわれません。後ほど、アプリケーション Pod をデプロイしたタイミングで実施されます。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">%</span><span class="bash"> kubectl apply -f secretproviderclass.yaml</span></span><br><span class="line">secretproviderclass.secrets-store.csi.x-k8s.io/azure-vote-secret-provider-class created</span><br></pre></td></tr></table></figure><h3 id="Key-Vault-アクセス用のマネージド-ID-を作成"><a href="#Key-Vault-アクセス用のマネージド-ID-を作成" class="headerlink" title="Key Vault アクセス用のマネージド ID を作成"></a>Key Vault アクセス用のマネージド ID を作成</h3><p>Key Vault へのアクセスに使用するマネージド ID を作成します。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">identityName="azure-vote"</span><br><span class="line">az identity create -g $&#123;resourceGroup&#125; -n $&#123;identityName&#125;</span><br></pre></td></tr></table></figure><p>作成したマネージド ID に <code>閲覧者 (Reader)</code> ロールを割り当て、対象のキー コンテナーからシークレットを取得するアクセス許可を付与します。<br>また、Key Vault のセキュリティ ポリシーを設定し、マネージド ID (の clientId) によるシークレットの取得を許可します。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">vaultName="azure-vote"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Key Vault リソース ID を取得</span></span></span><br><span class="line">keyVaultId=$(az keyvault show -n $&#123;vaultName&#125; --query id -o tsv)</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Azure AD ID の principalId, clientId を取得</span></span></span><br><span class="line">principalId=$(az identity show -g $&#123;resourceGroup&#125; -n $&#123;identityName&#125; --query principalId -o tsv)</span><br><span class="line">clientId=$(az identity show -g $&#123;resourceGroup&#125; -n $&#123;identityName&#125; --query clientId -o tsv)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Azure AD ID に Reader ロールを割り当て </span></span></span><br><span class="line">az role assignment create \</span><br><span class="line">  --role "Reader" \</span><br><span class="line">  --assignee $&#123;principalId&#125; \</span><br><span class="line">  --scope $&#123;keyVaultId&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Key Vault のアクセス ポリシーを設定</span></span></span><br><span class="line">az keyvault set-policy \</span><br><span class="line">  -n $&#123;vaultName&#125; \</span><br><span class="line">  --secret-permissions get \</span><br><span class="line">  --spn $&#123;clientId&#125;</span><br></pre></td></tr></table></figure><h3 id="Pod-Identity-を作成"><a href="#Pod-Identity-を作成" class="headerlink" title="Pod Identity を作成"></a>Pod Identity を作成</h3><p>AKS クラスターに Pod Identity を作成し、上記で作成したマネージド ID を AKS クラスターから使えるようにします。<code>az aks pod-identity add</code> コマンドを実行します。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># マネージド ID のリソース ID を取得</span></span></span><br><span class="line">identityResourceId=$(az identity show -g $&#123;resourceGroup&#125; -n $&#123;identityName&#125; --query id -o tsv)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># AKS クラスターに Pod Identity を作成</span></span></span><br><span class="line">az aks pod-identity add \</span><br><span class="line">  --resource-group $&#123;resourceGroup&#125; \</span><br><span class="line">  --cluster-name $&#123;clusterName&#125; \</span><br><span class="line">  --namespace default \</span><br><span class="line">  --name azure-vote \</span><br><span class="line">  --identity-resource-id $&#123;identityResourceId&#125;</span><br></pre></td></tr></table></figure><p>上記コマンドにより、クラスターの default ネームスペースに <code>AzureIdentity</code> <code>AzureIdentityBinding</code> のオブジェクトが作成されます。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">%</span><span class="bash"> kubectl get AzureIdentity,AzureIdentityBinding -n default</span></span><br><span class="line">NAME                                             AGE</span><br><span class="line">azureidentity.aadpodidentity.k8s.io/azure-vote   9m</span><br><span class="line"></span><br><span class="line">NAME                                                            AGE</span><br><span class="line">azureidentitybinding.aadpodidentity.k8s.io/azure-vote-binding   9m1s</span><br></pre></td></tr></table></figure><p><code>AzureIdentity</code> はマネージド ID を表し、使用した ID の <code>clientID</code>  <code>resourceID</code> が記録されています。<code>AzureIdentityBinding</code> はマネージド ID と Pod の関連付けを表すもので、<code>AzureIdentity</code> の名前と後述する Pod のラベル名が記録されています。</p><p>また、 AKS クラスターが持つマネージド ID に対して、コマンドで指定したマネージド ID を scope とした Managed Identity Operator ロールが割り当てられます。<br><img src="/blog/containers/aks-aad-pod-identity/aks-aad-pod-identity07.png" alt=""></p><p>上記のように、 Pod Identity では<a href="https://azure.github.io/aad-pod-identity/docs/getting-started/role-assignment/#performing-role-assignments" target="_blank" rel="noopener">マネージド ID 操作に必要なロール割り当て</a>や <a href="https://azure.github.io/aad-pod-identity/docs/demo/standard_walkthrough/#3-deploy-azureidentity" target="_blank" rel="noopener"><code>AzureIdentity</code> <code>AzureIdentityBinding</code> の作成</a> が必要となりますが、 <code>az aks pod-identity</code> コマンドではこれらのステップをユーザーに代わり行ってくれます。</p><h3 id="Azure-リソースへのアクセス権を-Pod-に付与する"><a href="#Azure-リソースへのアクセス権を-Pod-に付与する" class="headerlink" title="Azure リソースへのアクセス権を Pod に付与する"></a>Azure リソースへのアクセス権を Pod に付与する</h3><p>さいごに、 azure-vote アプリケーションをデプロイします。下記のように Deployment および Service の YAML マニフェストを記述します。<br>ポイントは以下の 3 点です。</p><ul><li><strong>Pod のラベル</strong><ul><li><code>aadpodidbinding: azure-vote</code> ラベルにより <code>AzureIdentity</code> との関連付けをします</li></ul></li><li><strong>Secret Store を利用した資格情報のボリューム マウント</strong><ul><li>ボリューム マウントが行われると Key Vault シークレットの内容が Kubernetes 上の Secret として同期されます</li><li>CSI ドライバーは Pod がボリュームをマウントする際に呼び出されます。今回は Kubernetes Secret を環境変数として読み込むためマウントしたファイルは必要ないのですが、CSI ドライバーを呼び出すために <code>volumesMounts</code> および <code>volumeMounts</code> の記述が必要となります<blockquote><p>参考: <a href="https://github.com/kubernetes-sigs/secrets-store-csi-driver/issues/290" target="_blank" rel="noopener">kubernetes-sigs/secrets-store-csi-driver - Sync of k8 secrets not happening #290</a></p></blockquote></li></ul></li><li><strong>環境変数の設定</strong><ul><li><code>REDIS</code> <code>REDIS_PWD</code> でアプリケーションに Redis の接続先/パスワードを渡します</li><li>パスワードの値は Kubernetes Secret から取得します (<code>secretKeyRef</code>)</li></ul></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">azure-vote</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">azure-vote</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">azure-vote</span></span><br><span class="line">        <span class="attr">aadpodidbinding:</span> <span class="string">azure-vote</span>   <span class="comment"># Pod Identity を指定</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">azure-vote-front</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">mcr.microsoft.com/azuredocs/azure-vote-front:v1</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="comment"># Redis ホスト / アクセスキーを環境変数に設定</span></span><br><span class="line">        <span class="comment"># アクセスキーは自動作成される K8s Secret から読み込む</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">REDIS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"$&#123;Redis ホスト名&#125;"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">REDIS_PWD</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">azure-vote-secret</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">redis-key</span></span><br><span class="line">        <span class="comment"># Secret Store の動作上ボリュームを一度マウントする必要がある</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">secrets-store-inline</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">"/mnt/secrets-store"</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">secrets-store-inline</span></span><br><span class="line">        <span class="attr">csi:</span></span><br><span class="line">          <span class="attr">driver:</span> <span class="string">secrets-store.csi.k8s.io</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">volumeAttributes:</span></span><br><span class="line">            <span class="comment"># secretProviderClass 名を指定</span></span><br><span class="line">            <span class="attr">secretProviderClass:</span> <span class="string">"azure-vote-secret-provider-class"</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">azure-vote</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">azure-vote</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">azure-vote</span></span><br></pre></td></tr></table></figure><p><code>kubectl apply</code> コマンドで YAML ファイルを適用し Deployment と Service をデプロイします。</p><p>Pod の作成と同時に CSI ドライバーによって Secret が作成されます。この Secret に Key Vault へ登録した Redis のアクセス キーが同期されています。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">%</span><span class="bash"> kubectl apply -f app.yaml</span></span><br><span class="line">deployment.apps/azure-vote created</span><br><span class="line">service/azure-vote created</span><br><span class="line"></span><br><span class="line"><span class="meta">%</span><span class="bash"> kubectl get secret | grep azure-vote -B1</span></span><br><span class="line">NAME                        TYPE             DATA   AGE</span><br><span class="line">azure-vote-secret           Opaque           1      7s</span><br></pre></td></tr></table></figure><p><code>kubectl get</code> コマンドで Pod と Service が作成されたか確認してみましょう。Service の <code>EXTERNAL-IP</code> に表示された IP アドレスにブラウザーからアクセスして、投票アプリのページが表示されれば成功です!</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">%</span><span class="bash"> kubectl get pod,svc -l app=azure-vote</span></span><br><span class="line">NAME                              READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/azure-vote-666c85dbbc-2bfkl   1/1     Running   0          22s</span><br><span class="line"></span><br><span class="line">NAME                 TYPE           CLUSTER-IP    EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">service/azure-vote   LoadBalancer   10.0.58.182   20.xx.xx.37   80:32285/TCP   22s</span><br></pre></td></tr></table></figure><p>AKS チュートリアルでは Redis も azure-vote-back Pod としてデプロイしているため、Pod を削除すると投票結果が消えてしまいます。今回の構成では Azure Cache for Redis へ結果が置かれているため、Pod を再起動したあとも同じカウント値が表示されるかと思います。</p><p>みなさんはどちらに投票しますか？ ちなみに私はねこ派です🐈<br><img src="/blog/containers/aks-aad-pod-identity/aks-aad-pod-identity09.png" alt=""></p><h2 id="さいごに"><a href="#さいごに" class="headerlink" title="さいごに"></a>さいごに</h2><p>この記事では、Pod から Azure リソースへアクセスする資格情報としてマネージド ID を使用し、Pod Identity Add-on を使った手順をサンプル アプリケーションを例にご紹介しました。YAML マニフェスト上でサービス プリンシパルの資格情報を扱わずに、Key Vault へのアクセスができることをご確認いただけたかと思います。</p><p>このほかにも、マネージド ID を使って Pod から様々な Azure リソースの操作が可能になります。利用例の 1 つとしては Application Gateway Ingress Controller (AGIC) が挙げられます。AGIC では、コントローラー Pod が Ingress オブジェクトを読み取り、その内容にもとづいて自動的に Application Gateway を構成するという動作をします。このとき <a href="https://azure.github.io/application-gateway-kubernetes-ingress/setup/install-existing/#set-up-aad-pod-identity" target="_blank" rel="noopener">Application Gateway を操作するためのアクセス権限を AAD Pod Identity を使って割り当てる</a>ことができます。</p><blockquote><p>ご参考情報: Application Gateway Ingress Controller<br><a href="https://azure.github.io/application-gateway-kubernetes-ingress/" target="_blank" rel="noopener">https://azure.github.io/application-gateway-kubernetes-ingress/</a></p></blockquote><p>このように、今後オープン ソースのツールなどでも Pod Identity を利用する機会も出てくるかと存じますので、ご参考にいただけたらと思います。<br>本稿が皆様のお役に立ちましたら幸いです。</p><hr><p>最後まで読んでいただきありがとうございました！<br><a href="https://qiita.com/advent-calendar/2020/microsoft-azure-tech" target="_blank" rel="noopener">Microsoft Azure Tech Advent Calendar 2020</a> はまだまだ続きます。明日も是非ご覧くださいー！</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;この記事は &lt;a href=&quot;https://qiita.com/advent-calendar/2020/microsoft-azure-tech&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Microsoft Azure Tech Advent Calendar 2020&lt;/a&gt; の 21 日目の記事になります。&lt;/p&gt;
&lt;p&gt;こんにちは🎅 Azure テクニカル サポート チームの桐井です。&lt;/p&gt;
&lt;p&gt;AKS 上のアプリケーション Pod から、 SQL Database や Key Vault、Blob Storage などの Azure サービスを利用する場合は、Pod に資格情報を渡し対象リソースへのアクセス権を付与する必要があります。&lt;/p&gt;
&lt;p&gt;この記事では、AKS 上の Pod へ Azure AD Pod Identity を使ってマネージド ID を割り当てる方法を解説します。サンプル アプリケーションを動かしながら、マネージド ID の持つアクセス権で Azure Key Vault へアクセスする例をご紹介します。&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="Containers" scheme="https://jpaztech.github.io/blog/tags/Containers/"/>
    
      <category term="Azure Kubernetes Service (AKS)" scheme="https://jpaztech.github.io/blog/tags/Azure-Kubernetes-Service-AKS/"/>
    
  </entry>
  
  <entry>
    <title>誤って削除してしまったストレージ アカウントを復旧する</title>
    <link href="https://jpaztech.github.io/blog/storage/storageAccount-Restore/"/>
    <id>https://jpaztech.github.io/blog/storage/storageAccount-Restore/</id>
    <published>2020-12-18T21:00:00.000Z</published>
    <updated>2021-04-27T07:25:57.353Z</updated>
    
    <content type="html"><![CDATA[<p>この記事は <a href="https://qiita.com/advent-calendar/2020/microsoft-azure-tech" target="_blank" rel="noopener">Microsoft Azure Tech Advent Calendar 2020</a> の 20 日目の記事になります。</p><p>こんにちは、Azure サポートチームの安田です。</p><p>今回は誤って削除してしまったストレージ アカウントの復元を行う方法をご案内します。以前までは弊サポート部門にお問い合わせいただき、数営業日かけて復旧するという流れでしたが、最近のアップデートにてお客様にて迅速に復元を行うことができるようになりました。ただし、本手順を用いても復元が叶わない場合もありますので、予めご了承ください。</p><a id="more"></a><p>また、本手順は現段階ではプレビューの機能となりますので、ポータルの UI 等が変更される可能性があります。こちらも予めご了承ください。</p><blockquote><p>本情報の内容（添付文書、リンク先などを含む）は、作成日時点でのものであり、予告なく変更される場合があります。</p></blockquote><font color="LightSalmon"><h2 id="ストレージ-アカウント復元時の注意点について"><a href="#ストレージ-アカウント復元時の注意点について" class="headerlink" title="ストレージ アカウント復元時の注意点について"></a>ストレージ アカウント復元時の注意点について</h2></font><p>前提として復元を行うには、以下の項目を満たしている必要があります。下記の条件を満たしていない場合には、残念ながら復旧は叶わないこととなりますので、予めご留意ください。</p><ul><li>削除後に、同じ名前の新しいストレージ アカウントが作成されていない</li><li>ストレージ アカウントが過去 14 日以内に削除された</li><li>クラシック ストレージ アカウントではない</li></ul><p>また、リソースグループ毎削除してしまった場合には、予め同名のリソースグループを作成しておく必要あるため、事前に用意ください。</p><font color="LightSalmon"><h2 id="ストレージ-アカウント復元の手順"><a href="#ストレージ-アカウント復元の手順" class="headerlink" title="ストレージ アカウント復元の手順"></a>ストレージ アカウント復元の手順</h2></font><ol><li>Azure ポータルにアクセスし、右上の ? マークから、 “ヘルプとサポート” を選択します。</li></ol><p><img src="/blog/storage/storageAccount-Restore/Storage3.png" alt=""></p><ol start="2"><li>右側のタブから “新しいサポート リクエスト” を選択し、下記画像のように各項目を選択します。</li></ol><p>#ストレージ アカウントについては表示された任意のものを選択ください。</p><p>#(この選択されたアカウントは利用しませんのでご安心ください。)</p><p>#“概要” の項目を適当に記載した場合、次の画面に正しく遷移しない可能性があるため、</p><p>#下記のように “Recover deleted storage object “ と入力ください。</p><p>記載が完了したら “次へ” を選択し、ソリューションの画面に推移します。</p><p><img src="/blog/storage/storageAccount-Restore/Storage4.png" alt=""></p><ol start="3"><li>“推奨される解決策” 内の “お客様が管理するストレージ アカウントの復旧” を選択します。</li></ol><p><img src="/blog/storage/storageAccount-Restore/Storage9.png" alt=""></p><ol start="4"><li>復旧対象のストレージ アカウントを選択し、”回復” を押下します。</li></ol><p><img src="/blog/storage/storageAccount-Restore/Storage7.png" alt=""></p><p>暫くすると復元が完了の通知が発生します。</p><p><img src="/blog/storage/storageAccount-Restore/Storage10.png" alt=""></p><p>本手順で復旧が完了しない場合、または復旧についてご不明な点がある場合は、お気兼ねなく弊サポート部門へお問い合わせください。</p><font color="LightSalmon"><h2 id="予期せぬリソースの削除を防ぐために"><a href="#予期せぬリソースの削除を防ぐために" class="headerlink" title="予期せぬリソースの削除を防ぐために"></a>予期せぬリソースの削除を防ぐために</h2></font>残念ながら上記方法では復元をお約束することは叶いません。こういった不慮の事故を未然に防ぐため、Azure のリソースには "リソースロック機能"、BLOB ファイルには "Soft Delete 機能" という誤削除防止の機能が用意されています。以前の記事で紹介しているため、詳細については "リソースの誤削除を未然に防ぐ方法について（リソースロック機能のご紹介）" と "BLOB ファイルの誤削除を未然に防ぐ方法について（Soft Delete 機能のご紹介）" の項目をご確認ください。<blockquote><p>Azure リソースの意図しない削除について<br><a href="https://jpaztech.github.io/blog/vm/resource-delete/">https://jpaztech.github.io/blog/vm/resource-delete/</a></p></blockquote><p>こちらの情報が、少しでも皆様のご参考となれば幸いでございます。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;この記事は &lt;a href=&quot;https://qiita.com/advent-calendar/2020/microsoft-azure-tech&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Microsoft Azure Tech Advent Calendar 2020&lt;/a&gt; の 20 日目の記事になります。&lt;/p&gt;
&lt;p&gt;こんにちは、Azure サポートチームの安田です。&lt;/p&gt;
&lt;p&gt;今回は誤って削除してしまったストレージ アカウントの復元を行う方法をご案内します。以前までは弊サポート部門にお問い合わせいただき、数営業日かけて復旧するという流れでしたが、最近のアップデートにてお客様にて迅速に復元を行うことができるようになりました。ただし、本手順を用いても復元が叶わない場合もありますので、予めご了承ください。&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="Storage" scheme="https://jpaztech.github.io/blog/tags/Storage/"/>
    
  </entry>
  
  <entry>
    <title>NSG と Azure Firewall の違い</title>
    <link href="https://jpaztech.github.io/blog/network/difference-nsg-fw/"/>
    <id>https://jpaztech.github.io/blog/network/difference-nsg-fw/</id>
    <published>2020-12-11T05:30:00.000Z</published>
    <updated>2021-04-27T07:25:57.345Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure サポートチームの薄井です。<br>今回は Network Security Group (NSG) と Azure Firewall の違いについて紹介します。</p><ul><li>NSG と Azure Firewall ってどっちもアクセス制御できるけれど何が違うの？</li><li>どういう場面で使い分けたらいいの？</li></ul><p>という、よくありそうな疑問に回答します。</p><a id="more"></a><h2 id="NSG-と-Azure-Firewall-の機能比較"><a href="#NSG-と-Azure-Firewall-の機能比較" class="headerlink" title="NSG と Azure Firewall の機能比較"></a>NSG と Azure Firewall の機能比較</h2><p>以下の表は NSG と Azure Firewall の大まかな機能比較表です。</p><table><thead><tr><th align="left">機能</th><th align="center">NSG</th><th align="center">Azure Firewall</th></tr></thead><tbody><tr><td align="left">動作箇所</td><td align="center">サブネットと VM の NIC</td><td align="center">ネットワークの境界</td></tr><tr><td align="left">対象レイヤー</td><td align="center">L3/L4</td><td align="center">L3/L4 + L7</td></tr><tr><td align="left">サービスタグによるフィルター処理</td><td align="center">○</td><td align="center">○</td></tr><tr><td align="left">FQDN によるフィルター処理</td><td align="center">×</td><td align="center">○</td></tr><tr><td align="left">SNAT と DNAT</td><td align="center">×</td><td align="center">○</td></tr><tr><td align="left">脅威インテリジェンスベースのフィルター処理</td><td align="center">×</td><td align="center">○</td></tr><tr><td align="left">価格</td><td align="center">無料</td><td align="center">有料</td></tr></tbody></table><h3 id="動作箇所"><a href="#動作箇所" class="headerlink" title="動作箇所"></a>動作箇所</h3><p>NSG はサブネットや Azure 仮想マシンの NIC 上で動作します。<br>Azure Firewall はインターネット（仮想ネットワーク）と仮想ネットワークの境界で動作します。</p><h3 id="サービスタグによるフィルター処理"><a href="#サービスタグによるフィルター処理" class="headerlink" title="サービスタグによるフィルター処理"></a>サービスタグによるフィルター処理</h3><p>サービス タグは、指定された Azure サービスからの IP アドレス プレフィックスのグループを表します。 サービス タグに含まれるアドレス プレフィックスの管理は Microsoft が行い、アドレスが変化するとサービス タグは自動的に更新されます。これにより、ネットワーク セキュリティ規則に対する頻繁な更新の複雑さを最小限に抑えられます。<br>なお、NSG と Azure Firewall では使用できるサービスタグは異なります。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/virtual-network/service-tags-overview" target="_blank" rel="noopener">仮想ネットワーク サービス タグ</a></li></ul><h3 id="FQDN-によるフィルター処理"><a href="#FQDN-によるフィルター処理" class="headerlink" title="FQDN によるフィルター処理"></a>FQDN によるフィルター処理</h3><p>FQDN によるフィルター処理は Azure Firewall のみの機能となります。<br>FQDN タグを用いると、例えば VNET 内の Windows VM からの Windows Update を行うためのトラフィックを許可したりすることが可能です。<br>FQDN ターゲットを用いると任意の FQDN への HTTP, HTTPS および MSSQL へのアクセスを制御できます。また、*.microsoft.com への<br>アクセスを許可/拒否するといったワイルドカードを使用したルールを作成することもできます。<br>ネットワーク ルールでの FQDN フィルタリングにより、HTTP, HTTPS および MSSQL 以外のプロトコルも FQDN を用いたフィルター処理を行えます。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/firewall/fqdn-tags" target="_blank" rel="noopener">Azure Firewall の FQDN タグの概要</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/firewall/firewall-faq#how-do-wildcards-work-in-an-application-rule-target-fqdn" target="_blank" rel="noopener">アプリケーション ルールのターゲット FQDN でワイルドカードはどのように機能しますか。</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/firewall/fqdn-filtering-network-rules" target="_blank" rel="noopener">ネットワーク ルールでの FQDN フィルタリング</a></li></ul><h3 id="SNAT-と-DNAT"><a href="#SNAT-と-DNAT" class="headerlink" title="SNAT と DNAT"></a>SNAT と DNAT</h3><p>Azure Firewall では Azure VM にパブリック IP アドレスを割り当てない場合でも、SNAT や DNAT の機能によって、<br>Azure Firewall のパブリック IP を利用することで Azure VM とインターネットとの間で通信が行えます。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/firewall/overview#outbound-snat-support" target="_blank" rel="noopener">Azure Firewall とは</a></li></ul><h3 id="脅威インテリジェンスベースのフィルター処理"><a href="#脅威インテリジェンスベースのフィルター処理" class="headerlink" title="脅威インテリジェンスベースのフィルター処理"></a>脅威インテリジェンスベースのフィルター処理</h3><p>Azure Firewall では脅威インテリジェンスベースのフィルター処理をすることが可能です。<br>ファイアウォール用に脅威インテリジェンスベースのフィルター処理を有効にして、既知の悪意のある IP アドレスやドメインとの間のトラフィックの警告と拒否を行うことができます。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/firewall/threat-intel" target="_blank" rel="noopener">Azure Firewall の脅威インテリジェンスベースのフィルター処理</a></li></ul><h3 id="価格"><a href="#価格" class="headerlink" title="価格"></a>価格</h3><p>NSG は無料ですが、Azure Firewall は課金が発生します。</p><ul><li><a href="https://azure.microsoft.com/ja-jp/pricing/details/azure-firewall/" target="_blank" rel="noopener">Azure Firewall の価格</a></li></ul><h2 id="その他"><a href="#その他" class="headerlink" title="その他"></a>その他</h2><h3 id="Azure-Firewall-にて通信制御のルールやログを一元管理する"><a href="#Azure-Firewall-にて通信制御のルールやログを一元管理する" class="headerlink" title="Azure Firewall にて通信制御のルールやログを一元管理する"></a>Azure Firewall にて通信制御のルールやログを一元管理する</h3><p>インターネット と VNet 間との通信やサブネット間の通信を全て Azure Firewall 経由とした場合は、<br>Azure Firewall 側で一元的に通信制御のルールを管理することができます。<br>また、診断ログの機能を使用した場合、FWで許可した通信と拒否した通信のログを一元的に記録することができます。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/firewall/tutorial-diagnostics" target="_blank" rel="noopener">チュートリアル:Azure Firewall のログとメトリックを監視する</a></li></ul><h2 id="NSG-と-Azure-Firewall-のどちらを利用すべきか"><a href="#NSG-と-Azure-Firewall-のどちらを利用すべきか" class="headerlink" title="NSG と Azure Firewall のどちらを利用すべきか"></a>NSG と Azure Firewall のどちらを利用すべきか</h2><p>以上が NSG と Azure Firewall の比較でした。<br>まとめますと、どちらを利用するかは、以下のように決定していただければと思います。</p><ul><li>NSG のみの機能で実現できるような場面では NSG のみを利用</li><li>Azure Firewall の機能が必要な場面では Azure Firewall を利用</li><li>通信制御のログを一元管理する場合には Azure Firewall を利用</li></ul><h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><h3 id="WAF-との違いは何ですか"><a href="#WAF-との違いは何ですか" class="headerlink" title="WAF との違いは何ですか"></a>WAF との違いは何ですか</h3><p>WAF（Web Application Firewall）は、レイヤー 7 に特化して、Web アプリケーションを脆弱性や悪用から保護するファイアウォールです。<br>Azure Firewall は RDP、SSH、FTP など、あらゆるポートとプロトコルの送受信、HTTP/S 送信におけるアプリケーションの保護を行うものです。<br>Azure 上で利用できる WAF については以下のドキュメントをご参照いただければと思います。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/web-application-firewall/" target="_blank" rel="noopener">Web アプリケーション ファイアウォールのドキュメント</a></li></ul><h3 id="IDS-IPS-との違いは何ですか"><a href="#IDS-IPS-との違いは何ですか" class="headerlink" title="IDS/IPS との違いは何ですか"></a>IDS/IPS との違いは何ですか</h3><p>一般的に言う IDS/IPS はネットワーク型で、ネットワーク上に流れるパケットを収集し、データやプロトコルなど分析し、攻撃パータンやルールにマッチした場合、検出・防止で制御します。<br>現在、Azure 上で提供している IDS/IPS の機能は DDoS Protection Basic / Standard です。DDoS Protection はバックボーン ネットワーク上で攻撃検知・緩和が実施されます。</p><p>以上、ご参考になれば幸いです。</p><hr>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;こんにちは、Azure サポートチームの薄井です。&lt;br&gt;今回は Network Security Group (NSG) と Azure Firewall の違いについて紹介します。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;NSG と Azure Firewall ってどっちもアクセス制御できるけれど何が違うの？&lt;/li&gt;
&lt;li&gt;どういう場面で使い分けたらいいの？&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;という、よくありそうな疑問に回答します。&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
      <category term="NSG" scheme="https://jpaztech.github.io/blog/tags/NSG/"/>
    
      <category term="Firewall" scheme="https://jpaztech.github.io/blog/tags/Firewall/"/>
    
  </entry>
  
  <entry>
    <title>Premium SSD のパフォーマンス レベルについて</title>
    <link href="https://jpaztech.github.io/blog/vm/introduction-performance-tier-ssd/"/>
    <id>https://jpaztech.github.io/blog/vm/introduction-performance-tier-ssd/</id>
    <published>2020-12-11T00:00:00.000Z</published>
    <updated>2021-04-27T07:25:57.413Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの山下です。</p><p>今回は、先日一般公開 (GA) が <a href="https://azure.microsoft.com/en-us/updates/performance-tiers-for-premium-ssds-is-now-generally-available/" target="_blank" rel="noopener">発表</a> された、Premium SSD のパフォーマンス レベルについてご紹介いたします。</p><a id="more"></a><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>Azure のディスクでは、ディスクのサイズに応じて性能（スループット、IOPS）が設定されています。ディスクの性能を向上されたい場合には、ディスクのサイズ拡張を行うという、シンプルな仕組みで提供されております。しかしながら、ディスクの拡張は容易に行える一方で、一度拡張したディスクは縮小が行えないという制限事項があるため、月末のバッチ処理やパフォーマンスの調査で切り分けなどで一時的に向上されたい場合には、拡張いただくのが難しいという課題がございました。</p><blockquote><p>Azure で利用できるディスクの種類<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/disks-types" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/virtual-machines/disks-types</a><br>Azure IaaS VM ディスクと Premium マネージド ディスクおよびアンマネージド ディスクについてよく寄せられる質問<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/faq-for-disks" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/virtual-machines/faq-for-disks</a></p></blockquote><p>今回 GA された Premium SSD のパフォーマンス レベルの機能では、ディスク サイズを変更することなく、数日間だけ上位のサイズと同じパフォーマンス レベルを得るといったことができる機能となっております。</p><h2 id="制限事項"><a href="#制限事項" class="headerlink" title="制限事項"></a>制限事項</h2><p>公開ドキュメントより制限事項を以下に抜粋いたします。</p><ul><li>現在、この機能は Premium SSD でのみサポートされています。</li><li>ディスクのレベルを変更する前に、VM の割り当てを解除するか、実行中の VM からディスクを切断する必要があります。</li><li>P60、P70、P80 の各パフォーマンス レベルの使用は、4,096 GiB 以上のディスクに制限されています。</li><li>ディスクのパフォーマンス レベルは、12 時間ごとに 1 回だけダウングレードできます。</li></ul><blockquote><p>Azure portal を利用してパフォーマンス レベルを変更する<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/disks-performance-tiers-portal" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/virtual-machines/disks-performance-tiers-portal</a><br>Change your performance tier using the Azure portal<br><a href="https://docs.microsoft.com/en-us/azure/virtual-machines/disks-performance-tiers-portal" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/azure/virtual-machines/disks-performance-tiers-portal</a></p></blockquote><h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><p>ここでは Azure Portal からの設定方法、ならびに実際にパフォーマンスが向上している様子をご紹介いたします。Azure Portal だけではなく、Azure PowerShell, Azure CLI からも設定が行えますので、CUI で変更されたい場合には、公開ドキュメントのご参照をお願いいたします。</p><p>今回は以下のような環境で、データ ディスクにおけるパフォーマンス レベルの変更を確認します。</p><ul><li>VM サイズ：Standard D16s_v3</li><li>ディスク サイズ：P4 (120 IOPS / 25 MBps)</li><li>変更後のパフォーマンス レベル：P40 (7500 IOPS / 250 MBps)</li><li>ゲスト OS：Windows Server 2019</li></ul><h3 id="パフォーマンス-レベル変更前の性能を確認"><a href="#パフォーマンス-レベル変更前の性能を確認" class="headerlink" title="パフォーマンス レベル変更前の性能を確認"></a>パフォーマンス レベル変更前の性能を確認</h3><p>iometer を使用して P4 のデータディスクのスループットを計測した結果、以下の画像のように、P4 の上限値である 25 MBps 前後の性能であることが確認できます。<br><img src="/blog/vm/introduction-performance-tier-ssd/originalthroughput.png" alt=""></p><h3 id="パフォーマンス-レベルの変更"><a href="#パフォーマンス-レベルの変更" class="headerlink" title="パフォーマンス レベルの変更"></a>パフォーマンス レベルの変更</h3><ol><li>VM の停止操作を行い、割り当て解除の状態にします。<br><img src="/blog/vm/introduction-performance-tier-ssd/deallocated.png" alt=""></li><li>パフォーマンス レベルを変更されたいディスクを開き、[設定] - [サイズおよびパフォーマンス] にアクセスします。</li><li>下部にある [パフォーマンス レベル] のプルダウンより、変更されたいパフォーマンス レベルを選択します。ここでは P40 を選択し、[サイズ変更] をクリックします。<br><img src="/blog/vm/introduction-performance-tier-ssd/performancelevel.png" alt=""></li><li>更新が完了したメッセージが表示されるのを待ちます。<br><img src="/blog/vm/introduction-performance-tier-ssd/changed.png" alt=""></li><li>更新完了後、VM を開始します。</li></ol><h3 id="パフォーマンス-レベル変更後の性能を確認"><a href="#パフォーマンス-レベル変更後の性能を確認" class="headerlink" title="パフォーマンス レベル変更後の性能を確認"></a>パフォーマンス レベル変更後の性能を確認</h3><p>再度 iometer を使用してスループットを計測した結果が以下です。スループットが先ほどの 25 MBps から、250 MBps 前後まで向上していることが確認できます。<br><img src="/blog/vm/introduction-performance-tier-ssd/highthroughput.png" alt=""></p><h3 id="補足事項"><a href="#補足事項" class="headerlink" title="補足事項"></a>補足事項</h3><p>制限事項に記載した通り、パフォーマンス レベルのダウングレードは 12 時間ごとに 1 回の操作が許可されています。12 時間経過せずに変更しようとした場合、下記画像のようにエラーが発生し、変更操作は失敗しますのでご留意ください。<br><img src="/blog/vm/introduction-performance-tier-ssd/changeerror.png" alt=""></p><p>また、アップグレードしている期間は、アップグレードされたパフォーマンス レベルの料金で課金されます。今回の場合、パフォーマンス レベルを P40 に変更している期間は、P4 ではなく、P40 の料金で課金される挙動となります。パフォーマンス レベルをもとの P4 に戻すことで、戻した以降は P4 の料金で課金されます。</p><p>本稿が少しでも皆様のご参考となれば幸いです。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;こんにちは、Azure テクニカル サポート チームの山下です。&lt;/p&gt;
&lt;p&gt;今回は、先日一般公開 (GA) が &lt;a href=&quot;https://azure.microsoft.com/en-us/updates/performance-tiers-for-premium-ssds-is-now-generally-available/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;発表&lt;/a&gt; された、Premium SSD のパフォーマンス レベルについてご紹介いたします。&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
      <category term="Disk" scheme="https://jpaztech.github.io/blog/tags/Disk/"/>
    
  </entry>
  
  <entry>
    <title>Azure Marketplace から作成した Windows VM において SMB 1.0 が有効化できない事象について</title>
    <link href="https://jpaztech.github.io/blog/vm/marketplace-image-smb1/"/>
    <id>https://jpaztech.github.io/blog/vm/marketplace-image-smb1/</id>
    <published>2020-12-08T06:30:00.000Z</published>
    <updated>2021-04-27T07:25:57.417Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの菅澤です。</p><p>Azure Marketplace より作成した Windows Server 2012 R2 以降の VM について、SMB 1.0 がインストールしようとするとイメージファイルパスの指定を求められることがございます。<br>こちらの背景及び対処策についてご紹介いたします。</p><a id="more"></a><hr><h2 id="■-Azure-Marketplace-上の-Windows-イメージにおける-SMB-1-0-への対応について"><a href="#■-Azure-Marketplace-上の-Windows-イメージにおける-SMB-1-0-への対応について" class="headerlink" title="■ Azure Marketplace 上の Windows イメージにおける SMB 1.0 への対応について"></a>■ Azure Marketplace 上の Windows イメージにおける SMB 1.0 への対応について</h2><p>Azure Marketplace 上の Windows Seriver 2012 R2 以降のイメージは、2018 年秋以降、SMB 1.0 が無効化した状態にて公開しております。<br>この無効化方法が、OS 上で無効化しただけではなく、バイナリーファイルを除去という形になっておりますため、お客様にて SMB 1.0 を有効化（追加インストールを含む）することができないことになります。</p><p>多くのお客様より、SMB 1.0 の有効化が可能となるよう、バイナリ―ファイルの組み込みのご要望いただいておりますが、後述の通り、SMB 1.0 の利用を推奨できないという状況があるために、このような対応を行う予定はございません。<br>大変恐縮ではございますが、代替として SMB 2.x / 3.x のご利用をご検討いただけますと幸いでございます。</p><blockquote><p>補足<br>技術的には、SMB 1.0 のインストールを行おうとした際に表示される代替ソースパスの指定画面において、これに対応するパッケージや iso ファイルを指定すればインストールを行うことが可能です。<br>しかし Azure サポートでは、SMB 1.0 のパッケージの配布、iso ファイルの提供など、この有効化に関するサポートを提供しておりません。</p></blockquote><hr><h2 id="■-なぜ-SMB-1-0-を利用できないのか"><a href="#■-なぜ-SMB-1-0-を利用できないのか" class="headerlink" title="■ なぜ SMB 1.0 を利用できないのか"></a>■ なぜ SMB 1.0 を利用できないのか</h2><p>SMB 1.0 は設計から 30 年程度が経過するプロトコルとなっており、その脆弱性を利用した問題も多数発生しております。<br>この脆弱性に対処するためには、設計が根本から見直された SMB 2.x 以上のプロトコルを利用するほかに選択がない状況です。<br>このことから、当社として SMB 1.0 のご利用はセキュリティの観点から推奨できないこととなっております。<br>また、以下のように最新の Windows バージョンでは　SMB 1.0 が既定ではインストールされない旨、以下のドキュメントにてご連絡をさせていただいております。<br>　# OS としての対応は、サポートされない・有効化できない、というわけではなく、<br>　# 利用するには手動での追加インストールが必要となるものです。</p><p>( 参考 ) Windows 10 Fall Creators Update と Windows Server バージョン 1709 以降のバージョン<br>   の既定では SMBv1 はインストールされません<br>　<a href="https://support.microsoft.com/ja-jp/help/4034314/smbv1-is-not-installed-by-default-in-windows" target="_blank" rel="noopener">https://support.microsoft.com/ja-jp/help/4034314/smbv1-is-not-installed-by-default-in-windows</a></p><p>上述の背景より、Azure Marketplace 上の Windows Server 2012 R2 以降のイメージでは、前述の通り SMB 1.0 を無効化した状態で公開しております。<br>なお、Azure としては、この無効化の方法が OS としての対応とは異なっており、前述の通りバイナリ―ファイルの除去という形が取られております。</p><hr><h2 id="■-Winodws-OS-上で有効となっている-SMB-クライアントバージョンを確認する方法について"><a href="#■-Winodws-OS-上で有効となっている-SMB-クライアントバージョンを確認する方法について" class="headerlink" title="■ Winodws OS 上で有効となっている SMB クライアントバージョンを確認する方法について"></a>■ Winodws OS 上で有効となっている SMB クライアントバージョンを確認する方法について</h2><p>Windows OS 上にて、どのバージョンの SMB クライアントが有効となっているかを確認したいというお客様も多くいらっしゃるかと存じます。<br>そんな場合には、Windows OS 上にて PowerShell を起動し、以下のコマンドを実行いただけますと、これを確認することが可能です。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc.exe qc lanmanworkstation</span><br></pre></td></tr></table></figure><p>実行結果中、DEPENDENCIES に MRxSmb20 が表示される場合、SMB 2.x / 3.x をご利用いただくことが可能となります。<br>また、MRxSmb10 が表示される場合には SMB 1.0 をご利用いただくことが可能となります。</p><p>( 参考 ) Windows と Windows Server で SMBv1、SMBv2、SMBv3 を検出する方法と有効<br>       または無効にする方法<br>　<a href="https://support.microsoft.com/ja-jp/help/2696547/how-to-detect-enable-and-disable-smbv1-smbv2-and-smbv3-in-windows-and" target="_blank" rel="noopener">https://support.microsoft.com/ja-jp/help/2696547/how-to-detect-enable-and-disable-smbv1-smbv2-and-smbv3-in-windows-and</a><br>　ご確認いただきたい項：<br>　SMB クライアントで状態を検出し、SMB プロトコルを有効または無効にする方法</p><hr><h2 id="■-SMB-1-0-を-Azure-VM-にて利用したい場合の対処方法について"><a href="#■-SMB-1-0-を-Azure-VM-にて利用したい場合の対処方法について" class="headerlink" title="■ SMB 1.0 を Azure VM にて利用したい場合の対処方法について"></a>■ SMB 1.0 を Azure VM にて利用したい場合の対処方法について</h2><p>Azure Marketplace 上の Windows Seriver 2012 R2 以降のイメージを用いて作成した VM では SMB 1.0 を有効化いただくことは叶いません。<br>しかし、どうしてもこれを利用しなければならない場合もあるかと存じます。<br>このような場合にも、Azure VM としてプロトコルを規制しているわけではございませんので、前述の通り SMB 1.0 の利用は推奨できませんが、対処策といたしましてはお客様自身にて SMB 1.0 機能を有効化した、または有効化可能な状態の仮想ディスクをご用意いただくことでご利用いただくことが可能です。</p><p>以下に、仮想マシンを複製する方法および Hyper-V にて作成された 仮想ディスクを Azure 上に移行する方法に関するドキュメントを記載いたします。<br>こちらを参考に、ご検討くださいますようお願いいたします。</p><ul><li><p>仮想マシンを複製する場合<br>　( 参考 ) Azure Resource Manager (ARM) 仮想マシンの複製方法のご紹介 (Part.1)<br>　<a href="https://blogs.technet.microsoft.com/jpaztech/2018/09/21/arm-vm-replication-part-1/" target="_blank" rel="noopener">https://blogs.technet.microsoft.com/jpaztech/2018/09/21/arm-vm-replication-part-1/</a><br>　( 参考 ) Azure Resource Manager (ARM) 仮想マシンの複製方法のご紹介 (Part.2)<br>　<a href="https://blogs.technet.microsoft.com/jpaztech/2018/09/25/arm-vm-replication-part-2/" target="_blank" rel="noopener">https://blogs.technet.microsoft.com/jpaztech/2018/09/25/arm-vm-replication-part-2/</a></p></li><li><p>仮想マシンをローカルからアップロードする場合<br>　( 参考 )Azure にアップロードする Windows VHD または VHDX を準備する<br>　<a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/prepare-for-upload-vhd-image" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/prepare-for-upload-vhd-image</a><br>　( 参考 )汎用化した VHD をアップロードして Azure で新しい VM を作成する<br>　<a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/upload-generalized-managed" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/upload-generalized-managed</a><br>　( 参考 ) Azure 上の Windows Server 仮想マシンのライセンス認証<br>　<a href="https://blogs.technet.microsoft.com/jpaztech/2017/10/25/activate_windowsvm_on_azure/" target="_blank" rel="noopener">https://blogs.technet.microsoft.com/jpaztech/2017/10/25/activate_windowsvm_on_azure/</a> </p></li></ul><p>上述の内容について、お客様 VM のセキュリティ向上のための施策であることとなり、何卒ご理解いただけますようお願いいたします。<br>また、本稿が皆様のお役に立てれば幸いです。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;こんにちは、Azure テクニカル サポート チームの菅澤です。&lt;/p&gt;
&lt;p&gt;Azure Marketplace より作成した Windows Server 2012 R2 以降の VM について、SMB 1.0 がインストールしようとするとイメージファイルパスの指定を求められることがございます。&lt;br&gt;こちらの背景及び対処策についてご紹介いたします。&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
      <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
  </entry>
  
  <entry>
    <title>AKS の送信トラフィック - Load Balancer SKU と SNAT オプション</title>
    <link href="https://jpaztech.github.io/blog/containers/aks-load-balancer-sku-and-snat-options/"/>
    <id>https://jpaztech.github.io/blog/containers/aks-load-balancer-sku-and-snat-options/</id>
    <published>2020-11-22T21:00:00.000Z</published>
    <updated>2021-04-27T07:25:57.325Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは！ Azure テクニカル サポート チームの桐井です。</p><p>Azure Kubernetes Service (AKS) にデプロイされた Pod からインターネットへの送信トラフィックでは、 Azure VM で外部接続をする場合と同様に、仮想ネットワークのプライベート IP アドレスからグローバル IP アドレスへの SNAT が必要です。 AKS 上のアプリケーションから外部の連携サービスへアクセスするというシナリオで、リソース グループ内に存在するパブリック IP アドレスのうちどれが送信元の IP アドレスとして使用されるのか、疑問に思われた方もいらっしゃるのではないかと思います。</p><p>Azure では外部接続の SNAT オプションを複数提供しており、 AKS ではクラスター作成時に選択した Load Balancer の SKU によって、使用される SNAT オプションが異なることがございます。この記事では、送信トラフィックに Azure Load Balancer が使用されている [^1] ことを前提に、 AKS の外部接続で使用される SNAT オプションについて、関係する Azure リソースの構成とともにご紹介いたします。</p><a id="more"></a><p>[^1]: 送信接続のために Azure Load Balancer ではなく、 User Defined Routing (UDR) を使用して、独自のゲートウェイ、ファイアウォールまたはプロキシを使用する構成もございます。詳細につきましては「<a href="https://docs.microsoft.com/ja-jp/azure/aks/egress-outboundtype" target="_blank" rel="noopener">ユーザー定義ルートを使用してクラスターのエグレスをカスタマイズする</a>」をご参照ください。</p><hr><h2 id="AKS-で使用される-Load-Balancer-SKU-と-SNAT-オプション"><a href="#AKS-で使用される-Load-Balancer-SKU-と-SNAT-オプション" class="headerlink" title="AKS で使用される Load Balancer SKU と SNAT オプション"></a>AKS で使用される Load Balancer SKU と SNAT オプション</h2><p>AKS では、 Azure Load Balancer の <strong>Standard SKU</strong> と <strong>Basic SKU</strong> の両方がサポートされています。 Load Balancer の SKU は、クラスター作成時のオプションで指定可能で、既定では Standard SKU が選択されます。</p><p>外部接続で使用される SNAT オプションを、クラスター作成時に選択した Load Balancer の SKU 、および <a href="https://kubernetes.io/ja/docs/concepts/services-networking/service/" target="_blank" rel="noopener">Kubernetes Service</a> の作成状況ごとにまとめると、下記の表のようになります。 SNAT オプションに記載のシナリオは、下記 Azure Load Balancer のドキュメントに記載のシナリオと対応することを示します。</p><blockquote><p>Azure Load Balancer ドキュメント<br><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections" target="_blank" rel="noopener">アウトバウンド接続での SNAT の使用</a></p></blockquote><p>Standard SKU を選択した場合は、クラスター作成と同時に Load Balancer リソースも作成されますが、 Basic SKU では <a href="https://kubernetes.io/ja/docs/concepts/services-networking/service/#loadbalancer" target="_blank" rel="noopener">Load Balancer タイプの Service</a> を作成するまで Load Balancer リソースは構成されないという点に注意が必要です。</p><table><thead><tr><th>Load Balancer SKU /<br>K8s Service の有無</th><th>SNAT オプション</th><th>SNAT アドレスに使用される IP アドレス</th></tr></thead><tbody><tr><td><strong>Standard</strong></td><td>外部 Load Balancer の送信規則による SNAT<br><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#scenario-2-virtual-machine-without-public-ip-and-behind-standard-public-load-balancer" target="_blank" rel="noopener">※シナリオ2</a></td><td>送信規則のフロントエンド IP アドレス</td></tr><tr><td><strong>Basic</strong> /<br>Service (LoadBalancer) が<strong>作成されていない</strong></td><td>Azure 既定の SNAT<br><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#scenario-3-virtual-machine-without-public-ip-and-behind-basic-load-balancer" target="_blank" rel="noopener">※シナリオ3</a></td><td>ランダムに割り当てられる IP アドレス</td></tr><tr><td><strong>Basic</strong> /<br>Service (LoadBalancer) が<strong>作成済み</strong></td><td>外部 Load Balancer の負荷分散規則による SNAT<br><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#scenario-2-virtual-machine-without-public-ip-and-behind-standard-public-load-balancer" target="_blank" rel="noopener">※シナリオ2</a></td><td>負荷分散規則のフロントエンド IP アドレス</td></tr></tbody></table><p>それでは Standard / Basic SKU それぞれを選択した AKS クラスターで、どのように SNAT が構成されるのか、実際に作成された Azure リソースをみながら確認していきましょう。 Pod からインターネットへ通信を行った際の送信元 IP アドレスの検証には、送信元のグローバル IP アドレスを確認できるサービス <a href="http://www.ifconfig.io/" target="_blank" rel="noopener">ifconfig.io</a> を使用します。</p><p>また、 Azure で提供される SNAT オプションにつきまして、弊社ネットワーク エンジニアによる解説記事がございます。どの SNAT オプションが使用されるか、状況別に判定するフローチャートがございますので、本記事とあわせてご参考にいただけますと幸いでございます。</p><blockquote><p>Japan Azure IaaS Core Support Blog<br><a href="https://jpaztech.github.io/blog/network/snat-options-for-azure-vm/">Azure VM の外部接続 (SNAT) オプション まとめ</a></p></blockquote><h3 id="Standard-SKU-の場合"><a href="#Standard-SKU-の場合" class="headerlink" title="Standard SKU の場合"></a>Standard SKU の場合</h3><p>Standard SKU を使用した場合では、 AKS クラスターから送信されたトラフィックは Load Balancer の<strong>送信規則に従い SNAT</strong> されます。Pod からインターネットへの通信では、<strong>送信規則に割り当てられたフロントエンド IP アドレス</strong> が送信元のアドレスとなります。</p><blockquote><p>AKS ドキュメント<br><a href="https://docs.microsoft.com/ja-jp/azure/aks/load-balancer-standard" target="_blank" rel="noopener">Azure Kubernetes Service (AKS) でパブリック Standard Load Balancer を使用する</a></p></blockquote><p>Standard SKU を選択しクラスターを作成すると、以下の画像のようにノード リソース グループの中に ロード バランサー および Public IP Address リソースが作成されます。</p><p><img src="/blog/containers/aks-load-balancer-sku-and-snat-options/aks-load-balancer-sku-and-snat-options01.png" alt="Standard SKU を使用し AKS クラスターを作成した場合のノード リソース グループ (MC_*) 内の様子"></p><p>ロード バランサー の送信規則には aksOutboundRule というルールが設定されており、一緒に作成された Public IP Address がフロントエンド IP アドレスとして指定されています。クラスターの送信トラフィックはこの送信規則にもとづいて SNAT されます。</p><p><img src="/blog/containers/aks-load-balancer-sku-and-snat-options/aks-load-balancer-sku-and-snat-options02.png" alt="ロード バランサー kubernetes のフロントエンド IP 構成と送信規則"></p><p>実際にクラスター上の Pod から通信を行うと、送信元のグローバル IP アドレスとして、送信規則のフロントエンドに割り当てられた IP アドレスが使用されていることが確認できます。</p><p><img src="/blog/containers/aks-load-balancer-sku-and-snat-options/aks-load-balancer-sku-and-snat-options03.png" alt="Pod 内からインターネットへの通信で使用されている送信元 IP アドレスを確認"></p><h3 id="Basic-SKU-の場合"><a href="#Basic-SKU-の場合" class="headerlink" title="Basic SKU の場合"></a>Basic SKU の場合</h3><p>Basic SKU を使用した AKS クラスターでは、 LoadBalancer タイプの Service の有無によって、使用される SNAT オプションが異なり、送信元の IP アドレスの割り当て方法も変化します。</p><ul><li>LoadBalancer タイプの Service が作成されていない場合<ul><li>エージェント ノードの VMSS は、どの外部 Load Balancer のバックエンドにも存在しないため、 <strong>Azure 既定の SNAT</strong> により<strong>ランダムに割り当てられたパブリック IP</strong> が使用されます</li></ul></li><li>LoadBalancer タイプの Service を作成した場合<ul><li>ロード バランサー および Public IP Address リソースが作成され、<strong>負荷分散規則に割り当てられたフロントエンド IP アドレスで SNAT</strong> されます</li></ul></li></ul><blockquote><p>AKS ドキュメント<br><a href="https://docs.microsoft.com/ja-jp/azure/aks/egress" target="_blank" rel="noopener">Azure Kubernetes Service (AKS) で Basic SKU ロード バランサーと共に、エグレス トラフィックに静的パブリック IP アドレスを使用する</a></p></blockquote><p>上記の動作について、文章だけではイメージしづらいと思いますので、ここではリソースのライフサイクルに沿って順に解説いたします。</p><h4 id="1-AKS-クラスターを作成した直後"><a href="#1-AKS-クラスターを作成した直後" class="headerlink" title="(1) AKS クラスターを作成した直後"></a>(1) AKS クラスターを作成した直後</h4><p>ノード リソース グループの中には、ロード バランサー および Public IP Address リソースは存在しません。</p><p><img src="/blog/containers/aks-load-balancer-sku-and-snat-options/aks-load-balancer-sku-and-snat-options04.png" alt="Basic SKU を使用し AKS クラスターを作成した場合のノード リソース グループ (MC_*) 内の様子"></p><p>この段階では、エージェント ノードの VMSS は、どの Load Balancer のメンバーではなく、外部接続では Azure 既定の SNAT が使用されます。SNAT に使用される IP アドレスは、 VM が存在する Azure リージョン内で使用されるグローバル IP アドレスの中から、未使用のアドレスがランダムに割り当てられます。 Pod から通信を行った場合も、ノード (VM) と同じ SNAT 構成が使用されます。</p><p><img src="/blog/containers/aks-load-balancer-sku-and-snat-options/aks-load-balancer-sku-and-snat-options05.png" alt="Load Balancer Service が存在しない場合: Azure 既定の SNAT が使用される"></p><p>Azure 既定の SNAT では、 VM / VMSS が再デプロイされると、割り当て済みの IP アドレスは解放され、新しいパブリック IP アドレスに変動します。 そのため、アプリケーションの接続先で IP アドレスによる通信制限を行っている場合、 IP アドレスの変動によりアクセスができなくなる恐れがありますのでご注意ください。</p><blockquote><p>詳細につきましてはこちらの記事もご参照ください<br>Japan Azure IaaS Core Support Blog<br><a href="https://jpaztech.github.io/blog/network/snat-options-for-azure-vm/#Azure-%E6%97%A2%E5%AE%9A%E3%81%AE-SNAT">Azure VM の外部接続 (SNAT) オプション まとめ 「Azure 既定の SNAT」</a></p></blockquote><h4 id="2-Load-Balancer-Service-を作成した後"><a href="#2-Load-Balancer-Service-を作成した後" class="headerlink" title="(2) Load Balancer Service を作成した後"></a>(2) Load Balancer Service を作成した後</h4><p>AKS クラスターに <code>type: LoadBalancer</code> の Kubernetes Service を作成すると、自動的に ロード バランサー および Public IP Address リソースが作成されます。</p><p><img src="/blog/containers/aks-load-balancer-sku-and-snat-options/aks-load-balancer-sku-and-snat-options06.png" alt="Service を作成すると ロード バランサー / Public IP Address リソースが作成される"></p><p>エージェント ノードの VMSS がバックエンド プールとして割り当てられます。また、負荷分散規則が構成され、フロントエンド IP アドレスには、同時に作成された Public IP Address が割り当てられます。</p><p>Load Balancer が構成されると、クラスターの送信トラフィックは負荷分散規則にもとづいて SNAT されるようになります。 SNAT アドレスには、フロントエンド IP アドレスとして割り当てられた IP アドレスが使用されます。実際に Pod から通信を試すと、送信元の グローバル IP アドレスが Service の External-IP として表示されている IP アドレスと一致することが確認できます。</p><p><img src="/blog/containers/aks-load-balancer-sku-and-snat-options/aks-load-balancer-sku-and-snat-options07.png" alt="Load Balancer の負荷分散規則により SNAT される。送信元 IP アドレスは Service の External-IP と一致する"></p><p>2 つ目以降の Service をデプロイした場合は、最初に割り当てられた IP アドレスが引き続き SNAT アドレスとして使用されます。例えば <code>Service A</code> 、 <code>Service B</code> という順番で Service を作成した場合、SNAT IP アドレスには <code>Service A</code> で割り当てられたパブリック IP アドレスが使用されます。</p><p><img src="/blog/containers/aks-load-balancer-sku-and-snat-options/aks-load-balancer-sku-and-snat-options08.png" alt="複数の Service を作成した場合は、最初に割り当てられた External-IP が SNAT アドレスとして使用される"></p><h4 id="3-Load-Balancer-Service-をすべて削除した後"><a href="#3-Load-Balancer-Service-をすべて削除した後" class="headerlink" title="(3) Load Balancer Service をすべて削除した後"></a>(3) Load Balancer Service をすべて削除した後</h4><p>すべての Load Balancer Service が削除されると、 ロード バランサー および Public IP Address リソースはノード リソース グループから自動的に削除されます。</p><p>上記の「<a href="#1-AKS-クラスターを作成した直後">(1) クラスターを作成した直後</a>」と同じ構成に戻ります。その後の Pod からの通信では、 Azure 既定の SNAT によってランダムに割り当てられたパブリック IP アドレスが送信元の IP アドレスとして使用されます。</p><h2 id="さいごに"><a href="#さいごに" class="headerlink" title="さいごに"></a>さいごに</h2><p>この記事では、 AKS の外部接続で使用される SNAT オプションについて Load Balancer の構成を踏まえて解説いたしました。</p><p>今回ご紹介しました Load Balancer のように、 AKS では Kubernetes の操作を介して、各種 Azure リソースが自動的に構成されます。動作の詳細や注意点について、対象の Azure サービスのドキュメントや、 VM の使用を想定した公開情報が参考になることもございますので、ぜひご参照いただけたらと思います。</p><p>本稿が皆様のお役に立てれば幸いです。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;こんにちは！ Azure テクニカル サポート チームの桐井です。&lt;/p&gt;
&lt;p&gt;Azure Kubernetes Service (AKS) にデプロイされた Pod からインターネットへの送信トラフィックでは、 Azure VM で外部接続をする場合と同様に、仮想ネットワークのプライベート IP アドレスからグローバル IP アドレスへの SNAT が必要です。 AKS 上のアプリケーションから外部の連携サービスへアクセスするというシナリオで、リソース グループ内に存在するパブリック IP アドレスのうちどれが送信元の IP アドレスとして使用されるのか、疑問に思われた方もいらっしゃるのではないかと思います。&lt;/p&gt;
&lt;p&gt;Azure では外部接続の SNAT オプションを複数提供しており、 AKS ではクラスター作成時に選択した Load Balancer の SKU によって、使用される SNAT オプションが異なることがございます。この記事では、送信トラフィックに Azure Load Balancer が使用されている [^1] ことを前提に、 AKS の外部接続で使用される SNAT オプションについて、関係する Azure リソースの構成とともにご紹介いたします。&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="Containers" scheme="https://jpaztech.github.io/blog/tags/Containers/"/>
    
      <category term="Azure Kubernetes Service (AKS)" scheme="https://jpaztech.github.io/blog/tags/Azure-Kubernetes-Service-AKS/"/>
    
  </entry>
  
  <entry>
    <title>一時ディスクのドライブ文字が変わる</title>
    <link href="https://jpaztech.github.io/blog/vm/drive-letter-changed-2/"/>
    <id>https://jpaztech.github.io/blog/vm/drive-letter-changed-2/</id>
    <published>2020-11-06T03:00:00.000Z</published>
    <updated>2021-04-27T07:25:57.393Z</updated>
    
    <content type="html"><![CDATA[<p><span style="color:red;"><strong>Update: 11/6</strong> (Last: 8/27)</span></p><p>こんにちは。Azure テクニカル サポート チームの重田です。</p><p>Azure Windows VM では、規定で一時ディスクにドライブ文字 D が割り当てられますが、<br>お客様の中には、アプリケーションの仕様上、データ ドライブを D ドライブと設定しなければならない場合があります。<br>その場合には、下記公開情報の手順にて一時ディスクのドライブ文字を変更いただけます。</p><a id="more"></a><ul><li>Windows VM のデータ ドライブとしての D: ドライブの使用<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/change-drive-letter" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/change-drive-letter</a></li></ul><p>しかしながら、一時ディスクのドライブ文字を D から変更いただいている場合、VM の停止 / 起動など物理ホスト サーバーの移動いただいた際に、一時ディスクのドライブ文字が変更される場合があります。</p><hr><h2 id="■-問題の動作につきまして"><a href="#■-問題の動作につきまして" class="headerlink" title="■ 問題の動作につきまして"></a>■ 問題の動作につきまして</h2><p>物理ホストの移動するタイミングにて、一時ディスクのドライブ文字が変更される動作は、下記のタイミング・条件によりごく稀に発生する場合があります。</p><ul><li><p><strong>タイミング:</strong><br>VM の停止 (割り当て解除) / 起動、再デプロイ、サイズ変更、ASR で対向リージョンにフェールオーバーを行ったなど、物理ホストサーバ移動後の VM の起動時</p></li><li><p><strong>条件:</strong><br>データ ドライブのドライブ文字 (例えば D) に対して、一時ディスクのドライブ文字が T など、ドライブ文字間が空いているアルファベットをご設定いただいている</p></li><li><p><strong>変更点:</strong><br>一時ディスクのドライブ文字が、データ ドライブのドライブ文字に連続したドライブ文字に変更される<br>(例えば、データ ドライブ文字が D の時に一時ディスクのドライブ文字 が E に変更される)</p></li><li><p><strong>発生頻度:</strong><br><s>ごく稀</p></li></ul><p>結論から申し上げますと、本動作は、現行の Azure の想定された起こりうる動作でございます。<br>すでに内部にて Azure の動作の改善点として確認されており、現在対処の準備を進めておりますが、現行の動作からの変更ということで長期にわたる可能性があり、直近での改善は困難であると想定されます。</s></p><p><span style="color:red;">本動作につきましては Azure 基盤側にて順次改善が展開されております。<br>改善に伴い、物理ホストの移動が発生した場合、改善が適用された状態の物理ホストから一時ディスクがアタッチされるため、ゲスト OS 内で保持している改善が適用される前の物理ホストからアタッチされた一時ディスクの情報と、改善が適用された後の一時ディスクの情報に差異があった場合に、ドライブ文字が変更される場合がございます。</span></p><p><span style="color:red;">1 度一時ディスクのドライブ文字が変更される場合がございますが、改善適用後に物理ホストの移動を伴う操作 (割り当て解除状態からの起動、再デプロイ、サイズ変更など) をご実施いただいた後であれば、本事象は発生しないことが期待されます。</span></p><hr><h2 id="■-問題の動作による影響につきまして"><a href="#■-問題の動作による影響につきまして" class="headerlink" title="■ 問題の動作による影響につきまして"></a>■ 問題の動作による影響につきまして</h2><p>Azure Marketplace イメージから作成した Windows VM では、規定で pagefile.sys<br>(仮想メモリ / ページング ファイル) が一時ディスクにシステム管理サイズで設定されております。</p><p>一時ディスクに pagefile.sys をご設定いただいている状況で、一時ディスクのドライブ文字が変更された場合、C ドライブに pagefile.sys が設定・配置されます。<br>そのため、ご利用状況によって pagefile.sys が拡張された際に、C ドライブの容量を圧迫することがございます。 </p><hr><h2 id="■-対処策につきまして"><a href="#■-対処策につきまして" class="headerlink" title="■ 対処策につきまして"></a>■ 対処策につきまして</h2><p>現在、本動作につきましては、下記 2 つの方法が対処策となります。</p><ol><li>一時ディスクを既定値である D ドライブで運用いただく。</li><li>OS 起動時に一時ディスクのドライブ文字を確認し、変更されている場合には再度ドライブ文字をご変更いただく。<br>pagefile.sys を一時ディスクにご設定いただいている場合には、そちらも併せてご変更いただく (要再起動)。</li></ol><p>対処策 1 につきましては、ご利用いただくアプリケーションの要件でデータ ドライブのドライブ文字を D にしなければならないといった制約がない場合にご検討ください。</p><p>対処策 2 につきましては、手動変更ではなく、タスクスケジューラにて登録した PowerShell スクリプトを OS 起動時に実行する方法 (スタートアップ スクリプト) になります。<br>具体的なサンプル スクリプトと、タスクスケジューラによるスクリプト実行設定を下記にご紹介いたします。</p><p><span style="color:red;">追記：<br>上述の通り、1 度一時ディスクのドライブ文字が変更される場合がございますが、改善適用後に物理ホストの移動を伴う操作をご実施いただいた後であれば、本事象は発生しないことが期待されます。</span><br><span style="color:red;">そのため、一時ディスクのドライブ文字が意図せず変更された場合には、手動でドライブ文字ならびにページングファイルのご設定を修正いただき、その後は静観いただけますと幸いでございます。</span></p><h3 id="□-サンプル-スクリプト"><a href="#□-サンプル-スクリプト" class="headerlink" title="□ サンプル スクリプト"></a>□ サンプル スクリプト</h3><p>本サンプル スクリプトは、ドライブ文字の設定状況を確認し、一時ディスクのドライブ文字が変更されている場合にはドライブ文字および pagefile.sys の設定を変更する処理を行う PowerShell スクリプトになります。<br>一時ディスクを <span style="color:red;"> <strong>T ドライブ</strong> </span>としておりますので、お客様にて必要に応じてご変更ください。</p><p>※ 一時ディスクのドライブ文字が変更されていない場合には、特に設定変更の処理は実施されません。<br>※ 本スクリプトが実行された際には、<span style="color:red;"><strong>ゲスト OS の再起動</strong> </span>が実施されます。</p><p>なお、お客様環境に導入いただく際には、十分な検証作業をご実施ください。</p><blockquote><p><strong>免責事項</strong></p><p>本サンプルスクリプトは、サンプルとして提供されるものであり、製品の実運用環境で使用されることを前提に提供されるものではありません。</p><p>本サンプルコードおよびそれに関連するあらゆる情報は、「現状のまま」で提供されるものであり、商品性や特定の目的への適合性に関する黙示の保証も含め、明示・黙示を問わずいかなる保証も付されるものではありません。</p><p>マイクロソフトは、お客様に対し、本サンプルコードを使用および改変するための非排他的かつ無償の権利ならびに本サンプルコードをオブジェクトコードの形式で複製および頒布するための非排他的かつ無償の権利を許諾します。</p><p>但し、お客様は、（１）本サンプルコードが組み込まれたお客様のソフトウェア製品のマーケティングのためにマイクロソフトの会社名、ロゴまたは、商標を用いないこと、（２）本サンプルコードが組み込まれたお客様のソフトウェア製品に有効な著作権表示をすること、および（３）本サンプルコードの使用または頒布から生じるあらゆる損害 （弁護士費用を含む）に関する請求または訴訟について、マイクロソフトおよびマイクロソフトの取引業者に対し補償し、損害を与えないことに同意するものとします。</p></blockquote><figure class="highlight powershell"><figcaption><span>SampleScript.ps1</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#一時ディスクのラベル</span></span><br><span class="line"><span class="variable">$DriveLabel</span>=<span class="string">"Temporary Storage"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#現在の一時ディスクのドライブ文字</span></span><br><span class="line"><span class="variable">$DriveLetter</span>=<span class="built_in">Get-Volume</span> | where FileSystemLabel <span class="operator">-match</span> <span class="variable">$DriveLabel</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#変更したい一時ディスクのドライブ文字</span></span><br><span class="line"><span class="variable">$NewDriveLetter</span>=<span class="string">"T"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#現在存在するドライブ文字</span></span><br><span class="line"><span class="variable">$AllLetter</span>=<span class="built_in">Get-Partition</span> | select DriveLetter</span><br><span class="line"></span><br><span class="line"><span class="comment">#pagefile の設定情報があるレジストリ パス</span></span><br><span class="line"><span class="variable">$RegistryPath</span>=<span class="string">"Registry::HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Session Manager\Memory Management"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#pagefile の設定: T ドライブにシステム管理サイズで pagefile.sys を設置</span></span><br><span class="line"><span class="variable">$NewValue</span>=<span class="string">"T:\pagefile.sys 0 0"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ドライブの存在判定 (現在 T ドライブが存在しているか)</span></span><br><span class="line"><span class="keyword">if</span> (!(<span class="variable">$AllLetter</span>.DriveLetter <span class="operator">-contains</span> <span class="variable">$NewDriveLetter</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#存在しない場合</span></span><br><span class="line">    <span class="comment">#現在の一時ディスクのドライブ文字を T ドライブに再設定</span></span><br><span class="line">    <span class="built_in">Set-Partition</span> <span class="literal">-Driveletter</span> <span class="variable">$DriveLetter</span>.DriveLetter <span class="literal">-NewDriveLetter</span> <span class="variable">$NewDriveLetter</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#設定後、T ドライブに改めて pagefile.sys 設定</span></span><br><span class="line">    <span class="built_in">Set-ItemProperty</span> <span class="literal">-Path</span> <span class="variable">$RegistryPath</span> <span class="literal">-Name</span> PagingFiles <span class="literal">-Value</span> <span class="variable">$NewValue</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#OS 再起動</span></span><br><span class="line">    <span class="built_in">Restart-Computer</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h3 id="□-タスクスケジューラの設定"><a href="#□-タスクスケジューラの設定" class="headerlink" title="□ タスクスケジューラの設定"></a>□ タスクスケジューラの設定</h3><p>タスクスケジューラは以下のようにご設定いただけますと、OS 起動時にスクリプトを実行することが可能となります。<br>上記サンプル スクリプトをお客様のご利用状況に合わせてご変更いただき (例えば、一時ディスクのドライブ文字を適宜ご変更いただくなど)、タスクスケジューラにご設定ください。</p><p>1) SampleScript.txt をSampleScript.ps1 に変更します。</p><p>2) [サーバー マネージャー] - [ツール] - [タスク スケジューラ] から<br>   [タスクの作成] をクリックします。</p><p>3) [全般] タブにて以下の設定を実施します。</p><blockquote><p>名前 : 任意でご設定ください<br>タスク実行時に使うユーザー アカウント : 管理者権限ユーザ<br>ユーザーがログオンしているかどうかにかかわらず実行する : 有効<br>最上位の特権で実行する : 有効</p></blockquote><p>4) [トリガー] - [新規] にてタスクの開始に [スタートアップ時] を選択し、[OK] をクリックします。</p><p>5) [操作] - [新規] にて [プログラムの開始] が選択されている事を確認し、以下を設定後、[OK] を押下して設定を反映させます。</p><blockquote><p>プログラム/スクリプト : C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe<br>引数の追加 : &lt;SampleScript.ps1 のパス&gt;\SampleScript.ps1</p></blockquote><p>※ パスワードを要求されましたら、対象ユーザー (管理者) のパスワードを入力します。</p><br>本稿が皆様のお役に立てれば幸いです。<hr>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;span style=&quot;color:red;&quot;&gt;&lt;strong&gt;Update: 11/6&lt;/strong&gt; (Last: 8/27)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;こんにちは。Azure テクニカル サポート チームの重田です。&lt;/p&gt;
&lt;p&gt;Azure Windows VM では、規定で一時ディスクにドライブ文字 D が割り当てられますが、&lt;br&gt;お客様の中には、アプリケーションの仕様上、データ ドライブを D ドライブと設定しなければならない場合があります。&lt;br&gt;その場合には、下記公開情報の手順にて一時ディスクのドライブ文字を変更いただけます。&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
      <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
      <category term="Drive Letter" scheme="https://jpaztech.github.io/blog/tags/Drive-Letter/"/>
    
  </entry>
  
  <entry>
    <title>VM の再作成により可用性ゾーンを変更する (PowerShell 編)</title>
    <link href="https://jpaztech.github.io/blog/vm/change-availability-zone-using-powershell/"/>
    <id>https://jpaztech.github.io/blog/vm/change-availability-zone-using-powershell/</id>
    <published>2020-11-02T06:30:00.000Z</published>
    <updated>2021-04-27T07:25:57.381Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの菅澤です。</p><p>Azure VM では、一部リージョンのみとはなりますが可用性ゾーンをサポートしています。</p><ul><li>Azure での Availability Zones をサポートしているリージョン<br><a href="https://docs.microsoft.com/ja-jp/azure/availability-zones/az-region" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/availability-zones/az-region</a></li></ul><p>ただ、可用性ゾーンを利用した VM を作成したい場合には、これに利用するディスクも可用性ゾーンを利用している必要があり、一般に仮想マシンを新規デプロイする場合にのみこの利用有無を設定できます。</p><a id="more"></a><p>しかし、運用をしている中で可用性ゾーンへ組み入れる必要が発生したり、逆に、可用性ゾーンに組み入れられていると一部機能が対応しないため、可用性ゾーンから外したいというご要望が出てくることがあるかと思います。</p><p>本稿では、こうしたご要望にお応えするために、可用性ゾーンへ含まれない VM を可用性ゾーンに組み入れる、可用性ゾーンに含まれる VM を可用性ゾーンから外す方法について、Azure PowerShell のサンプルを用いてそれぞれご案内いたします。</p><h2 id="■-本手順を利用する前提条件"><a href="#■-本手順を利用する前提条件" class="headerlink" title="■ 本手順を利用する前提条件"></a>■ 本手順を利用する前提条件</h2><p>本手順では、管理ディスクを利用していることを前提としてご案内いたします。<br>Azure PowerShell か実行可能な環境、もしくは Azure CloudShell をご利用いただける環境から実行してください。</p><h2 id="■-手順の流れについて"><a href="#■-手順の流れについて" class="headerlink" title="■ 手順の流れについて"></a>■ 手順の流れについて</h2><p>可用性ゾーンへ含まれない VM を可用性ゾーンに組み入れる、可用性ゾーンに含まれる VM を可用性ゾーンから外すのいずれの場合でも以下の流れにて作業を行います。</p><ol><li>仮想マシンを停止する。</li><li>仮想マシンのスナップショットを取得する。</li><li>仮想マシンのスナップショットから仮想マシンを作成する。</li><li>作成されたスナップショット、およびもともと利用されていたリソースを削除する。</li></ol><h2 id="■-可用性ゾーンを設定したい場合"><a href="#■-可用性ゾーンを設定したい場合" class="headerlink" title="■ 可用性ゾーンを設定したい場合"></a>■ 可用性ゾーンを設定したい場合</h2><p>まず、設定変更を行いたい仮想マシンを停止してください。</p><p>停止が完了したら、現在利用しているディスクのスナップショットを取得します。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ResourceGroup</span> = <span class="string">"AZ"</span> <span class="comment"># リソースグループ名</span></span><br><span class="line"><span class="variable">$Location</span> = <span class="string">"japaneast"</span>　<span class="comment"># リージョン名 ( japaneast など )</span></span><br><span class="line"><span class="variable">$vmName</span> = <span class="string">"NonAz"</span> <span class="comment"># 仮想マシン名</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$snapshotName</span> = <span class="variable">$vmname</span> + <span class="string">"-OSDisk-Snapshot"</span>  <span class="comment"># スナップショット名</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###以下変更不要###</span></span><br><span class="line"><span class="comment"># VM の情報を取得</span></span><br><span class="line"><span class="variable">$vm</span> = <span class="built_in">get-Azvm</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroup</span> <span class="literal">-Name</span> <span class="variable">$vmName</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># スナップショットを作成</span></span><br><span class="line"><span class="variable">$snapshot</span> =  <span class="built_in">New-AzSnapshotConfig</span> <span class="literal">-SourceResourceId</span> <span class="variable">$vm</span>.StorageProfile.OsDisk.ManagedDisk.Id <span class="literal">-Location</span> <span class="variable">$Location</span> <span class="literal">-CreateOption</span> copy</span><br><span class="line"></span><br><span class="line"><span class="built_in">New-AzSnapshot</span> <span class="literal">-Snapshot</span> <span class="variable">$snapshot</span> <span class="literal">-SnapshotName</span> <span class="variable">$snapshotName</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroup</span></span><br></pre></td></tr></table></figure><p>次に、上記で取得したスナップショットをもとに VM を作成します。</p><p>パブリック IP アドレスは、通常可用性ゾーンに含まれない VM では Basic SKU が利用されますが、可用性ゾーンでパブリック IP アドレスを利用する場合には Standard SKU かつ静的な割り当てが必要となりますのでご注意ください。</p><ul><li>パブリック IP アドレス<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-network/public-ip-addresses" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/virtual-network/public-ip-addresses</a></li></ul><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ResourceGroup</span> = <span class="string">"AZ"</span> <span class="comment"># リソースグループ名</span></span><br><span class="line"><span class="variable">$Location</span> = <span class="string">"japaneast"</span>　<span class="comment"># リージョン名</span></span><br><span class="line"><span class="variable">$vmName</span> = <span class="string">"NonAz"</span> <span class="comment"># 元の VM の仮想マシン名</span></span><br><span class="line"><span class="variable">$ZoneNo</span> = <span class="number">1</span> <span class="comment"># ゾーン番号 ( 1 or 2 or 3 )</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 必要に応じて変更してください</span></span><br><span class="line"><span class="variable">$snapshotName</span> = <span class="variable">$vmname</span> + <span class="string">"-OSDisk-Snapshot"</span>　<span class="comment"># スナップショット名</span></span><br><span class="line"><span class="variable">$osDiskName</span> = <span class="variable">$vmname</span> + <span class="string">"-OSDisk-AZ"</span>  <span class="comment"># 新しい VM の OS ディスク名</span></span><br><span class="line"><span class="variable">$virtualMachineName</span> = <span class="variable">$vmName</span> + <span class="string">"AZ"</span> <span class="comment"># 新しい VM 名</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###以下変更不要ですが、 VM の Config を作成にある Windows / Linux の部分のみご確認ください ###</span></span><br><span class="line"><span class="comment"># 以下は元 VM と同じものを自動的に選択しています</span></span><br><span class="line"><span class="comment"># VM の情報を取得</span></span><br><span class="line"><span class="variable">$vm</span> = <span class="built_in">get-Azvm</span>  <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroup</span> <span class="literal">-Name</span> <span class="variable">$vmName</span></span><br><span class="line"><span class="variable">$Subnet</span> =  (<span class="built_in">Get-AzNetworkInterface</span> <span class="literal">-ResourceID</span> <span class="variable">$vm</span>.NetworkProfile.NetworkInterfaces.Id).IpConfigurations.subnet.Id <span class="comment"># サブネット情報</span></span><br><span class="line"><span class="variable">$virtualMachineSize</span> = <span class="variable">$vm</span>.HardwareProfile.VmSize <span class="comment"># VM サイズ </span></span><br><span class="line"><span class="variable">$DiskType</span> = (<span class="built_in">Get-AzDisk</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroup</span> <span class="literal">-DiskName</span>  <span class="variable">$vm</span>.StorageProfile.OsDisk.Name).Sku.Name <span class="comment"># ディスクの種類</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># スナップショット情報を取得</span></span><br><span class="line"><span class="variable">$snapshot</span> = <span class="built_in">Get-AzSnapshot</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroup</span> <span class="literal">-SnapshotName</span> <span class="variable">$snapshotName</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ディスクを作成</span></span><br><span class="line"><span class="variable">$diskConfig</span> = <span class="built_in">New-AzDiskConfig</span> <span class="literal">-Location</span> <span class="variable">$snapshot</span>.Location <span class="literal">-SourceResourceId</span> <span class="variable">$snapshot</span>.Id <span class="literal">-CreateOption</span> Copy <span class="literal">-Zone</span> <span class="variable">$ZoneNo</span> <span class="literal">-AccountType</span> <span class="variable">$DiskType</span></span><br><span class="line"><span class="variable">$disk</span> = <span class="built_in">New-AzDisk</span> <span class="literal">-Disk</span> <span class="variable">$diskConfig</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroup</span> <span class="literal">-DiskName</span> <span class="variable">$osDiskName</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># VM の Config を作成　( -Windows となっている部分は、Linux VM の場合には -Linux に変えてください )</span></span><br><span class="line"><span class="variable">$VirtualMachine</span> = <span class="built_in">New-AzVMConfig</span> <span class="literal">-VMName</span> <span class="variable">$virtualMachineName</span> <span class="literal">-VMSize</span> <span class="variable">$virtualMachineSize</span> <span class="literal">-Zone</span> <span class="variable">$ZoneNo</span></span><br><span class="line"><span class="variable">$VirtualMachine</span> = <span class="built_in">Set-AzVMOSDisk</span> <span class="literal">-VM</span> <span class="variable">$VirtualMachine</span> <span class="literal">-ManagedDiskId</span> <span class="variable">$disk</span>.Id <span class="literal">-CreateOption</span> Attach <span class="literal">-Windows</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># public IP および NIC を作成</span></span><br><span class="line"><span class="variable">$publicIp</span> = <span class="built_in">New-AzPublicIpAddress</span> <span class="literal">-Name</span> (<span class="variable">$vmName</span>+<span class="string">'-AZ_ip'</span>) <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroup</span> <span class="literal">-Location</span> <span class="variable">$snapshot</span>.Location <span class="literal">-AllocationMethod</span> <span class="keyword">Static</span> <span class="literal">-Zone</span> <span class="variable">$ZoneNo</span> <span class="literal">-Sku</span> Standard</span><br><span class="line"><span class="variable">$nic</span> = <span class="built_in">New-AzNetworkInterface</span> <span class="literal">-Name</span> (<span class="variable">$vmName</span>+<span class="string">'-AZ_nic'</span>) <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroup</span> <span class="literal">-Location</span> <span class="variable">$snapshot</span>.Location <span class="literal">-SubnetId</span> <span class="variable">$subnet</span> <span class="literal">-PublicIpAddressId</span> <span class="variable">$publicIp</span>.Id </span><br><span class="line"><span class="variable">$VirtualMachine</span> = <span class="built_in">Add-AzVMNetworkInterface</span> <span class="literal">-VM</span> <span class="variable">$VirtualMachine</span> <span class="literal">-Id</span> <span class="variable">$nic</span>.Id</span><br><span class="line"></span><br><span class="line"><span class="comment"># VM を作成</span></span><br><span class="line"><span class="built_in">New-AzVM</span> <span class="literal">-VM</span> <span class="variable">$VirtualMachine</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroup</span> <span class="literal">-Location</span> <span class="variable">$snapshot</span>.Location</span><br></pre></td></tr></table></figure><p>上記で作成された VM が動作するようでしたらば、もともと利用していたリソースおよび、本手順で作成したスナップショットを削除し、手順は完了となります。</p><h2 id="■-可用性ゾーンの設定を削除したい場合"><a href="#■-可用性ゾーンの設定を削除したい場合" class="headerlink" title="■ 可用性ゾーンの設定を削除したい場合"></a>■ 可用性ゾーンの設定を削除したい場合</h2><p>まず、現在利用しているディスクのスナップショットを取得します。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ResourceGroup</span> = <span class="string">"AZ"</span> <span class="comment"># リソースグループ名</span></span><br><span class="line"><span class="variable">$Location</span> = <span class="string">"japaneast"</span>　<span class="comment"># リージョン名 ( japaneast など )</span></span><br><span class="line"><span class="variable">$vmName</span> = <span class="string">"Az"</span> <span class="comment"># 仮想マシン名</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 必要に応じて変更してください</span></span><br><span class="line"><span class="variable">$snapshotName</span> = <span class="variable">$vmname</span> + <span class="string">"-OSDisk-Snapshot"</span>  <span class="comment"># スナップショット名</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###以下変更不要###</span></span><br><span class="line"><span class="comment"># VM の情報を取得</span></span><br><span class="line"><span class="variable">$vm</span> = <span class="built_in">get-Azvm</span>  <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroup</span> <span class="literal">-Name</span> <span class="variable">$vmName</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># スナップショットを作成</span></span><br><span class="line"><span class="variable">$snapshot</span> =  <span class="built_in">New-AzSnapshotConfig</span> <span class="literal">-SourceResourceId</span> <span class="variable">$vm</span>.StorageProfile.OsDisk.ManagedDisk.Id <span class="literal">-Location</span> <span class="variable">$Location</span> <span class="literal">-CreateOption</span> copy</span><br><span class="line"></span><br><span class="line"><span class="built_in">New-AzSnapshot</span> <span class="literal">-Snapshot</span> <span class="variable">$snapshot</span> <span class="literal">-SnapshotName</span> <span class="variable">$snapshotName</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroup</span></span><br></pre></td></tr></table></figure><p>次に、上記で取得したスナップショットをもとに VM を作成します。</p><p>パブリック IP アドレスは、通常可用性ゾーンに含まれない VM とするため、Basic SKU としています。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ResourceGroup</span> = <span class="string">"AZ"</span> <span class="comment"># リソースグループ名</span></span><br><span class="line"><span class="variable">$Location</span> = <span class="string">"japaneast"</span>　<span class="comment"># リージョン名</span></span><br><span class="line"><span class="variable">$vmName</span> = <span class="string">"Az"</span> <span class="comment"># 元の VM の仮想マシン名</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 必要に応じて変更してください</span></span><br><span class="line"><span class="variable">$snapshotName</span> = <span class="variable">$vmname</span> + <span class="string">"-OSDisk-Snapshot"</span>　<span class="comment"># スナップショット名</span></span><br><span class="line"><span class="variable">$osDiskName</span> = <span class="variable">$vmname</span> + <span class="string">"-OSDisk_NonAz"</span>  <span class="comment"># 新しい VM の OS ディスク名</span></span><br><span class="line"><span class="variable">$virtualMachineName</span> = <span class="variable">$vmName</span> + <span class="string">"NonAZ"</span> <span class="comment"># 新しい VM 名</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###以下変更不要ですが、 VM の Config を作成にある Windows / Linux の部分のみご確認ください ###</span></span><br><span class="line"><span class="comment"># 以下は元 VM と同じものを自動的に選択しています</span></span><br><span class="line"><span class="comment"># VM の情報を取得</span></span><br><span class="line"><span class="variable">$vm</span> = <span class="built_in">get-Azvm</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroup</span> <span class="literal">-Name</span> <span class="variable">$vmName</span></span><br><span class="line"><span class="variable">$Subnet</span> =  (<span class="built_in">Get-AzNetworkInterface</span> <span class="literal">-ResourceID</span> <span class="variable">$vm</span>.NetworkProfile.NetworkInterfaces.Id).IpConfigurations.subnet.Id <span class="comment"># サブネット情報</span></span><br><span class="line"><span class="variable">$virtualMachineSize</span> = <span class="variable">$vm</span>.HardwareProfile.VmSize <span class="comment"># VM サイズ </span></span><br><span class="line"><span class="variable">$DiskType</span> = (<span class="built_in">Get-AzDisk</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroup</span> <span class="literal">-DiskName</span>  <span class="variable">$vm</span>.StorageProfile.OsDisk.Name).Sku.Name <span class="comment"># ディスクの種類</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># スナップショット情報を取得</span></span><br><span class="line"><span class="variable">$snapshot</span> = <span class="built_in">Get-AzSnapshot</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroup</span> <span class="literal">-SnapshotName</span> <span class="variable">$snapshotName</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ディスクを作成</span></span><br><span class="line"><span class="variable">$diskConfig</span> = <span class="built_in">New-AzDiskConfig</span> <span class="literal">-Location</span> <span class="variable">$snapshot</span>.Location <span class="literal">-SourceResourceId</span> <span class="variable">$snapshot</span>.Id <span class="literal">-CreateOption</span> Copy <span class="literal">-AccountType</span> <span class="variable">$DiskType</span></span><br><span class="line"><span class="variable">$disk</span> = <span class="built_in">New-AzDisk</span> <span class="literal">-Disk</span> <span class="variable">$diskConfig</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroup</span> <span class="literal">-DiskName</span> <span class="variable">$osDiskName</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># VM の Config を作成　( -Windows となっている部分は、Linux VM の場合には -Linux に変えてください )</span></span><br><span class="line"><span class="variable">$VirtualMachine</span> = <span class="built_in">New-AzVMConfig</span> <span class="literal">-VMName</span> <span class="variable">$virtualMachineName</span> <span class="literal">-VMSize</span> <span class="variable">$virtualMachineSize</span></span><br><span class="line"><span class="variable">$VirtualMachine</span> = <span class="built_in">Set-AzVMOSDisk</span> <span class="literal">-VM</span> <span class="variable">$VirtualMachine</span> <span class="literal">-ManagedDiskId</span> <span class="variable">$disk</span>.Id <span class="literal">-CreateOption</span> Attach <span class="literal">-Windows</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># public IP および NIC を作成</span></span><br><span class="line"><span class="variable">$publicIp</span> = <span class="built_in">New-AzPublicIpAddress</span> <span class="literal">-Name</span> (<span class="variable">$vmName</span>+<span class="string">'NonAZ_ip'</span>) <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroup</span> <span class="literal">-Location</span> <span class="variable">$snapshot</span>.Location <span class="literal">-AllocationMethod</span> Dynamic <span class="literal">-Sku</span> Basic</span><br><span class="line"><span class="variable">$nic</span> = <span class="built_in">New-AzNetworkInterface</span> <span class="literal">-Name</span> (<span class="variable">$vmName</span>+<span class="string">'NonAZ_nic'</span>) <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroup</span> <span class="literal">-Location</span> <span class="variable">$snapshot</span>.Location <span class="literal">-SubnetId</span> <span class="variable">$subnet</span> <span class="literal">-PublicIpAddressId</span> <span class="variable">$publicIp</span>.Id </span><br><span class="line"><span class="variable">$VirtualMachine</span> = <span class="built_in">Add-AzVMNetworkInterface</span> <span class="literal">-VM</span> <span class="variable">$VirtualMachine</span> <span class="literal">-Id</span> <span class="variable">$nic</span>.Id</span><br><span class="line"></span><br><span class="line"><span class="comment"># VM を作成</span></span><br><span class="line"><span class="built_in">New-AzVM</span> <span class="literal">-VM</span> <span class="variable">$VirtualMachine</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroup</span> <span class="literal">-Location</span> <span class="variable">$snapshot</span>.Location</span><br></pre></td></tr></table></figure><p>上記で作成された VM が動作するようでしたらば、もともと利用していたリソースおよび、本手順で作成したスナップショットを削除し、手順は完了となります。</p><h2 id="■-参考"><a href="#■-参考" class="headerlink" title="■ 参考"></a>■ 参考</h2><p>本ドキュメントの作成に当たっては、以下の資料を参考としておりますので、よろしければこちらもご確認をいただけますと幸いです。</p><ul><li><p>スナップショットの作成<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/snapshot-copy-managed-disk" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/snapshot-copy-managed-disk</a></p></li><li><p>PowerShell でスナップショットから仮想マシンを作成する<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/scripts/virtual-machines-windows-powershell-sample-create-vm-from-snapshot" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/virtual-machines/scripts/virtual-machines-windows-powershell-sample-create-vm-from-snapshot</a></p></li></ul><p>本稿が皆様のお役に立てれば幸いです。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;こんにちは、Azure テクニカル サポート チームの菅澤です。&lt;/p&gt;
&lt;p&gt;Azure VM では、一部リージョンのみとはなりますが可用性ゾーンをサポートしています。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Azure での Availability Zones をサポートしているリージョン&lt;br&gt;&lt;a href=&quot;https://docs.microsoft.com/ja-jp/azure/availability-zones/az-region&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://docs.microsoft.com/ja-jp/azure/availability-zones/az-region&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ただ、可用性ゾーンを利用した VM を作成したい場合には、これに利用するディスクも可用性ゾーンを利用している必要があり、一般に仮想マシンを新規デプロイする場合にのみこの利用有無を設定できます。&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="Sample Script" scheme="https://jpaztech.github.io/blog/tags/Sample-Script/"/>
    
      <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
      <category term="Availability Zone" scheme="https://jpaztech.github.io/blog/tags/Availability-Zone/"/>
    
      <category term="Azure PowerShell" scheme="https://jpaztech.github.io/blog/tags/Azure-PowerShell/"/>
    
  </entry>
  
</feed>
